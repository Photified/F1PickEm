<!DOCTYPE html>
<html lang="en" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#e10600">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>F1 PICKEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,400;0,700;0,900;1,400&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <script src="bingo_data.js"></script>

    <style>
        :root {
            --brand-red: #e10600; --brand-dark: #15151e; --bg-body: #f8f9fa;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.08);
            --c-driver: #ff9500; --c-team: #00d2be; --c-fia: #e10600; 
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Titillium Web', sans-serif; background: var(--bg-body); color: var(--brand-dark); margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .hidden { display: none !important; }

        /* HEADER */
        header { background: white; border-bottom: 3px solid var(--brand-red); height: 60px; display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); z-index: 20; flex-shrink: 0; }
        .logo-area { padding: 0 15px; height: 100%; display: flex; align-items: center; border-right: 1px solid #eee; cursor: pointer; }
        .header-logo { max-height: 28px; width: auto; }
        
        .race-scroll-area { flex: 1; display: flex; flex-direction: row; align-items: center; overflow-x: auto; height: 100%; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .race-card { flex: 0 0 auto; min-width: 70px; padding: 0 12px; height: 100%; display: inline-flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid #f5f5f5; cursor: pointer; opacity: 0.5; transition: 0.2s; }
        .race-card.active { opacity: 1; background: #fff; border-bottom: 4px solid var(--brand-red); }
        .race-flag-img { width: 24px; height: 16px; object-fit: cover; border-radius: 2px; margin-bottom: 4px; }
        .race-name { font-size: 9px; font-weight: 800; text-transform: uppercase; white-space: nowrap; }
        
        /* LAYOUT */
        .main-stage { flex: 1; display: grid; grid-template-columns: 320px 1fr 300px; padding: 20px; gap: 20px; overflow: hidden; height: 100%; }
        .panel { background: white; border-radius: 12px; box-shadow: var(--card-shadow); overflow: hidden; display: flex; flex-direction: column; border: 1px solid #e0e0e0; height: 100%; }
        .active-panel { background: white; border-radius: 12px; border: 1px solid #e0e0e0; padding: 0; display: flex; flex-direction: column; overflow: hidden; height: 100%; position: relative; }

        .view-login, .view-strategy, .view-standings, .view-rules { padding-bottom: 120px !important; }
        #view-game { padding-bottom: 70px !important; } 

        @media (max-width: 1024px) {
            .main-stage { grid-template-columns: 1fr; padding: 10px; padding-bottom: 0; }
            .panel { display: none; } 
            .panel.mobile-modal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; border-radius: 0; animation: slideUp 0.25s ease-out; }
            .mobile-close-btn { display: block !important; }
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .mobile-close-btn { display: none; padding: 15px; background: #333; color: white; text-align: center; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }

        /* NAV */
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: white; border-top: 1px solid #ddd; z-index: 1000; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); padding-bottom: 10px; }
        .nav-item { flex: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: #888; text-transform: uppercase; cursor: pointer; }
        .nav-item.active { color: var(--brand-red); background: #fff5f5; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }
        @media (max-width: 1024px) { .mobile-nav { display: flex; } }

        /* HEADER & BUDGET */
        #raceHeader { padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; height: 70px; }
        .rh-left { display: flex; align-items: center; gap: 12px; }
        .rh-flag { width: 45px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .rh-title { font-size: 18px; font-weight: 900; font-style: italic; text-transform: uppercase; line-height: 1; }
        .rh-date { font-size: 11px; color: #888; font-weight: 700; margin-top: 2px; }
        .rh-right-group { display: flex; align-items: center; gap: 8px; }
        
        .header-btn { width: 36px; height: 36px; border-radius: 8px; border: none; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s; }
        .hb-setup { background: white; border: 1px solid #eee; color: #666; }
        .hb-lock { background: #22c55e; color: white; display: none; }
        .hb-unlock { background: #ef4444; color: white; display: none; }

        .budget-hud { background: #f4f4f8; padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; border-left: 4px solid #22c55e; display: flex; flex-direction: column; align-items: flex-end; min-width: 70px; }
        .budget-hud-val { font-size: 14px; font-weight: 900; color: #22c55e; line-height: 1; }
        .budget-hud-bar-bg { width: 100%; height: 4px; background: #e0e0e0; margin-top: 4px; border-radius: 3px; }
        .budget-hud-bar-fill { height: 100%; background: #22c55e; width: 50%; border-radius: 3px; transition: 0.3s; }

        /* GRID */
        .grid-container { flex: 1; padding: 10px; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .bingo-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap: 8px; width: 100%; height: 100%; max-width: 600px; margin: 0 auto; }
        
        .slot { background: #fafafa; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; position: relative; cursor: pointer; user-select: none; transition: 0.2s; text-transform: uppercase; color: #aaa; width: 100%; height: 100%; }
        .slot[data-req="driver"] { background: #fff8e6; border-color: var(--c-driver); color: var(--c-driver); }
        .slot[data-req="team"] { background: #e0fbf8; border-color: var(--c-team); color: var(--c-team); }
        .slot[data-req="fia"] { background: #fff2f2; border-color: var(--c-fia); color: var(--c-fia); }

        .slot.filled { background: white !important; border: 1px solid #ddd !important; padding: 0; overflow: hidden; display: flex; flex-direction: column; text-align: left; box-shadow: 0 4px 10px rgba(0,0,0,0.08); border-radius: 8px; }
        .slot.filled::before { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 0; border-style: solid; border-width: 24px 24px 0 0; z-index: 5; }
        .slot.filled[data-type="driver"]::before { border-color: var(--c-driver) transparent transparent transparent; }
        .slot.filled[data-type="team"]::before { border-color: var(--c-team) transparent transparent transparent; }
        .slot.filled[data-type="fia"]::before { border-color: var(--c-fia) transparent transparent transparent; }

        .slot-img-container { width: 100%; height: 60%; display: flex; align-items: flex-end; justify-content: center; background-color: var(--team-color-hex); position: relative; overflow: hidden; }
        .slot-img { z-index: 2; transition: 0.2s; }
        .slot.filled[data-type="driver"] .slot-img { width: 100%; height: 120%; object-fit: cover; object-position: top center; margin-bottom: -15%; }
        .slot.filled[data-type="team"] .slot-img { width: 95%; height: auto; object-fit: contain; margin-bottom: 20px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2)); }
        .slot.filled[data-type="fia"] .slot-img { width: 50%; height: auto; margin-bottom: 20px; filter: brightness(0) invert(1); opacity: 0.8; }
        .slot-price-tag { background: rgba(0,0,0,0.8); color: white; font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 12px; position: absolute; bottom: 4px; right: 4px; z-index: 10; border: 1px solid rgba(255,255,255,0.2); }

        .slot-text-container { width: 100%; height: 40%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 2px 4px; background: white; border-top: 1px solid rgba(0,0,0,0.05); }
        .slot-sub { font-size: 7px; text-transform: uppercase; font-weight: 900; color: var(--cat-text-color); margin-bottom: 2px; letter-spacing: 0.5px; opacity: 0.7; }
        .slot-main { font-size: 10px; font-weight: 900; line-height: 1.1; color: #222; text-transform: uppercase; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .remove-pick-btn { position: absolute; top: 4px; left: 4px; width: 22px; height: 22px; background: rgba(0,0,0,0.3); color: #fff; display: flex; align-items: center; justify-content: center; z-index: 15; border-radius: 50%; font-size: 12px; font-weight: bold; cursor: pointer; backdrop-filter: blur(2px); }
        .slot.matched { opacity: 1; box-shadow: inset 0 0 0 3px var(--score-win); transform: scale(1.02); z-index: 5; }
        .slot.matched::after { content: '‚úì'; position: absolute; top: 4px; right: 4px; background: var(--score-win); color: black; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 20; }

        /* MARKET STYLES - FIXED GRID */
        .tab-header { display: flex; border-bottom: 1px solid #eee; background: #f9f9f9; flex-shrink: 0; height: 45px; }
        .tab-btn { flex: 1; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px; cursor: pointer; color: #888; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn.active { background: white; color: #000; }
        #tabBtn-drivers.active { border-bottom-color: var(--c-driver); color: var(--c-driver); }
        #tabBtn-teams.active { border-bottom-color: var(--c-team); color: var(--c-team); }
        #tabBtn-fia.active { border-bottom-color: var(--c-fia); color: var(--c-fia); }

        /* Force 3 columns for Drivers */
        .market-grid-drivers { padding: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; box-sizing: border-box; }
        .driver-card-market { background: var(--team-color); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 140px; cursor: pointer; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .dcm-img { width: 100%; height: 90%; object-fit: cover; object-position: top center; margin-bottom: 0; z-index: 1; filter: drop-shadow(0 0 5px rgba(0,0,0,0.2)); }
        .dcm-name { width: 100%; background: rgba(20,20,30,0.9); color: white; font-size: 9px; font-weight: 800; text-align: center; padding: 5px 2px; z-index: 2; text-transform: uppercase; line-height: 1; }

        .market-list-teams { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .team-card-market { width: 100%; height: 70px; background: white; border-radius: 8px; border: 1px solid #eee; border-left: 8px solid var(--team-color); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tcm-name { font-size: 14px; font-weight: 900; text-transform: uppercase; color: #333; }
        .tcm-img { height: 90%; width: 60%; object-fit: contain; object-position: right center; }

        .market-detail-view { display: none; flex-direction: column; height: 100%; background: #f4f4f8; }
        .market-detail-view.active { display: flex; }
        .market-detail-header { background: white; padding: 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; font-weight: 900; font-size: 16px; color: #333; position: sticky; top: 0; z-index: 10; }
        .back-btn { font-size: 20px; cursor: pointer; color: #888; }
        .prediction-list { padding: 15px; overflow-y: auto; }
        
        /* CLICK FIX: Removed pointer-events: none */
        .prediction-btn { background: white; border-radius: 8px; overflow: hidden; display: flex; height: 55px; margin-bottom: 10px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #ddd; transition: 0.2s; }
        .prediction-btn:active { transform: scale(0.98); }
        .prediction-btn.unaffordable { opacity: 0.7; filter: grayscale(0.8); } /* Visual only, still clickable */
        .pb-left { width: 55px; background: var(--team-color); display: flex; align-items: center; justify-content: center; }
        .pb-img { width: 40px; height: 40px; object-fit: contain; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
        .prediction-btn.team-mode .pb-left { width: 140px; } 
        .prediction-btn.team-mode .pb-img { width: 90%; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); }
        .pb-left.fia-bg .pb-img { filter: brightness(0) invert(1); } 
        .pb-right { flex: 1; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff), linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff); background-size: 10px 10px; background-color: #fafafa; }
        .pb-text { font-size: 12px; font-weight: 800; color: #333; text-transform: uppercase; }
        .pb-cost { background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 900; }
        .prediction-btn.unaffordable .pb-cost { background: #ef4444; color: white; } 

        /* LOGIN */
        .view-login { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; box-sizing: border-box; overflow-y: auto; height: 100%; }
        .login-input { padding: 15px; width: 100%; text-align: center; border: 2px solid #eee; border-radius: 10px; font-weight: bold; font-size: 18px; max-width: 400px; margin-bottom: 25px; background: #fff; }
        .login-btn { padding: 16px; width: 100%; max-width: 400px; margin-top: 20px; background: var(--brand-red); color: white; border: none; font-weight: 900; cursor: pointer; border-radius: 10px; font-size: 16px; box-shadow: 0 4px 10px rgba(225, 6, 0, 0.2); margin-bottom: 50px; }

        /* STRATEGY */
        .view-strategy { text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center; height: 100%; padding: 20px; overflow-y: auto; }
        .strategy-header-container { margin-top: 20px; margin-bottom: 30px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .big-flag { width: 100px; height: auto; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 10px; }
        .strat-race-name { font-size: 32px; font-weight: 900; font-style: italic; text-transform: uppercase; line-height: 1; color: var(--brand-dark); }
        .strat-race-date { font-size: 16px; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 10px; }
        .strat-sub { color: #888; font-size: 11px; font-weight: 800; letter-spacing: 1px; }
        .strat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; width: 100%; }
        .strat-card { background: #fff; border: 2px solid #eee; border-radius: 12px; padding: 20px; cursor: pointer; display: flex; flex-direction: column; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .mini-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; width: 60px; height: 60px; margin-bottom: 10px; opacity: 0.8; } .mg-c { border-radius: 1px; }
        
        /* ACTIONS */
        .actions-footer { padding: 15px; display: flex; gap: 10px; align-items: center; justify-content: center; width: 100%; flex-shrink: 0; border-top: 1px solid #eee; background: white; }
        .btn-action { flex: 1; padding: 14px; border-radius: 8px; font-weight: 900; font-size: 12px; text-transform: uppercase; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.2s; }
        .btn-lock { background: #22c55e; color: white; border: 1px solid #16a34a; }
        .btn-unlock { background: #ef4444; color: white; border: 1px solid #b91c1c; }
        .btn-change-strat { background: white; color: #555; border: 2px solid #ddd; box-shadow: none; }
        .btn-install-manual { background: #333; color: white; display: none; }

        /* MODAL */
        #customModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-box { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 320px; text-align: center; }
        .btn-modal { padding: 12px 24px; border-radius: 8px; font-weight: 800; cursor: pointer; border: none; margin: 5px; font-size: 14px; }
        .btn-confirm { background: var(--brand-red); color: white; }
        .btn-cancel { background: #eee; color: #333; }
        
        /* INSTALL MODAL */
        #installModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .install-box { background: white; width: 85%; max-width: 320px; border-radius: 16px; padding: 30px 20px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .install-icon { width: 60px; height: 60px; background: #e10600; border-radius: 12px; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px; font-weight: bold; }
        .install-btn { width: 100%; padding: 14px; background: #22c55e; color: white; border: none; border-radius: 8px; font-weight: 900; font-size: 14px; margin-top: 15px; cursor: pointer; box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3); }
        .install-dismiss { width: 100%; padding: 12px; background: transparent; color: #888; border: none; font-weight: 700; font-size: 12px; margin-top: 5px; cursor: pointer; }

        /* STANDINGS & RULES */
        .score-box { text-align: center; margin-bottom: 20px; padding: 25px; background: #fff; border-radius: 12px; border: 1px solid #eee; box-shadow: var(--card-shadow); }
        .score-val { font-size: 42px; font-weight: 900; color: var(--brand-dark); line-height: 1; }
        .rules-card { background: white; border: 1px solid #eee; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .rule-step { display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start; }
        .step-num { flex: 0 0 30px; height: 30px; background: var(--brand-red); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 14px; }
        .step-content { flex: 1; }
        .step-title { font-weight: 900; font-size: 14px; margin-bottom: 5px; text-transform: uppercase; color: #333; }
        .step-desc { font-size: 13px; color: #666; line-height: 1.4; margin: 0; }
        .chip-example { display: flex; align-items: center; gap: 10px; margin-top: 5px; background: #f9f9f9; padding: 8px; border-radius: 6px; border: 1px solid #eee; }
        .ce-text { font-size: 11px; font-weight: 800; color: #333; text-transform: uppercase; }

    </style>
</head>
<body>

<script>
  // Service Worker
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

  // PWA Logic
  let deferredPrompt;
  const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
  const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installModal').classList.remove('hidden');
    document.querySelector('.btn-install-manual').style.display = 'flex';
  });

  // Force show on iOS or if not installed (Debug Mode)
  setTimeout(() => {
      if (!isInStandaloneMode && !sessionStorage.getItem('installDismissed')) {
          document.getElementById('installModal').classList.remove('hidden');
      }
  }, 1500);

  async function triggerInstall() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
            deferredPrompt = null;
            document.getElementById('installModal').classList.add('hidden');
        }
    } else {
        if(isIos) {
            alert("To install: Tap the Share Button below (Square with Arrow), then scroll down to 'Add to Home Screen'.");
        } else {
            alert("To install: Tap the 3 dots in your browser menu -> Install App.");
        }
        document.getElementById('installModal').classList.add('hidden');
    }
  }

  function dismissInstall() {
      document.getElementById('installModal').classList.add('hidden');
      sessionStorage.setItem('installDismissed', 'true');
  }
</script>

<div id="installModal" class="hidden">
    <div class="install-box">
        <div class="install-icon">F1</div>
        <h3 style="margin:0; font-style:italic; font-size:22px; color:#222;">INSTALL APP</h3>
        <p style="font-size:13px; color:#666; margin-top:5px; line-height:1.5;">Install F1 Pick'Em for the best fullscreen experience.</p>
        <button class="install-btn" onclick="triggerInstall()">INSTALL NOW</button>
        <button class="install-dismiss" onclick="dismissInstall()">CONTINUE IN BROWSER</button>
    </div>
</div>

<div id="customModal" class="hidden">
    <div class="modal-box">
        <h3 id="modalTitle" style="margin-top:0; color:#e10600; font-style:italic; font-size:20px;">RACE CONTROL</h3>
        <p id="modalText" style="font-size:14px; color:#555; margin-bottom:20px; line-height:1.4;">Text</p>
        <div id="modalActions"></div>
    </div>
</div>

<header>
    <div class="logo-area" onclick="location.reload()">
        <img src="images/logotop.png" class="header-logo" alt="F1 Pick Em">
    </div>
    <div class="race-scroll-area" id="raceBar"></div>
    <div class="user-area" id="displayTeamName">GUEST</div>
</header>

<div class="main-stage">
    
    <div class="panel" id="marketPanel">
        <div class="mobile-close-btn" onclick="closeMobileMarket()">CLOSE MARKET √ó</div>
        <div class="tab-header" id="marketTabs">
            <div class="tab-btn active" id="tabBtn-drivers" onclick="showMarketTab('drivers')">DRIVERS</div>
            <div class="tab-btn" id="tabBtn-teams" onclick="showMarketTab('teams')">TEAMS</div>
            <div class="tab-btn" id="tabBtn-fia" onclick="showMarketTab('fia')">FIA</div>
        </div>
        <div id="marketContent" style="flex:1; overflow-y:auto; position:relative;">
            <div id="drivers-root" class="market-grid-drivers"></div>
            <div id="teams-root" class="market-list-teams" style="display:none;"></div>
            <div id="fia-root" class="prediction-list" style="display:none;"></div>
            <div id="market-detail" class="market-detail-view">
                <div class="market-detail-header">
                    <div class="back-btn" onclick="backToRoot()">‚Üê</div>
                    <div id="detail-title">Entity Name</div>
                </div>
                <div id="detail-list" class="prediction-list"></div>
            </div>
        </div>
    </div>

    <div class="active-panel" id="mainPanel">
        
        <div id="view-login" class="view-login">
            <h2 style="font-style:italic; font-size:24px; margin-bottom:20px;">TEAM PRINCIPAL LOGIN</h2>
            <input type="text" id="teamNameInput" class="login-input" placeholder="Enter Team Name">
            <button class="login-btn" onclick="login()">ENTER PADDOCK</button>
        </div>

        <div id="view-strategy" class="view-strategy hidden">
            <div class="strategy-header-container">
                <img id="stratFlag" src="" class="big-flag">
                <div id="stratRaceName" class="strat-race-name">AUSTRALIA</div>
                <div id="stratRaceDate" class="strat-race-date">MAR 8</div>
                <div class="strat-sub">SELECT GRID FORMATION</div>
            </div>
            <div class="strat-grid">
                <div class="strat-card" onclick="confirmStrategy('balanced')"><div class="mini-grid"><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-team)"></div></div><strong>Balanced</strong></div>
                <div class="strat-card" onclick="confirmStrategy('team')"><div class="mini-grid"><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-fia)"></div></div><strong>Constructor</strong></div>
                <div class="strat-card" onclick="confirmStrategy('chaos')"><div class="mini-grid"><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div></div><strong>FIA / Chaos</strong></div>
                <div class="strat-card" onclick="confirmStrategy('driver')"><div class="mini-grid"><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div></div><strong>Driver Focus</strong></div>
            </div>
        </div>

        <div id="view-game" class="view-game hidden" style="width:100%; height:100%; display:flex; flex-direction:column;">
            <div id="raceHeader">
                <div class="rh-left"><img id="rhFlag" src="" class="rh-flag"><div><div id="rhTitle" class="rh-title">RACE</div><div id="rhDate" class="rh-date">DATE</div></div></div>
                <div class="budget-hud"><span style="font-size:9px; font-weight:800; color:#888;">CAP SPACE</span><div class="budget-hud-val" id="hudBudgetVal">$100M</div><div class="budget-hud-bar-bg"><div class="budget-hud-bar-fill" id="hudBudgetBar"></div></div></div>
            </div>
            <div class="grid-container"><div id="grid" class="bingo-grid"></div></div>
            <div class="actions-footer">
                <button id="lockBtn" class="btn-action btn-lock" onclick="toggleUserLock()">üîí LOCK CARD</button>
                <button id="unlockBtn" class="btn-action btn-unlock" onclick="toggleUserLock()">üîì UNLOCK CARD</button>
                <button class="btn-action btn-change-strat" onclick="changeStrategy()">‚öô SETUP</button>
                <button class="btn-action btn-install-manual" onclick="triggerInstall()">‚¨á INSTALL APP</button>
            </div>
        </div>
        
        <div id="view-standings" class="hidden" style="padding:20px; overflow-y:auto; height:100%;">
            <div class="score-box"><div class="score-val" id="scoreDisplay">0</div><div class="score-lbl">Total Points</div></div>
            <div style="text-align:center; color:#888; font-size:12px;">Leaderboard updating...</div>
        </div>

        <div id="view-rules" class="hidden" style="padding:20px; overflow-y:auto; height:100%;">
            <div class="rules-card">
                <div class="rule-step">
                    <div class="step-num">1</div>
                    <div class="step-content"><div class="step-title">Select Strategy</div><div class="step-desc">Choose a grid layout that fits your style.</div></div>
                </div>
                <div class="rule-step">
                    <div class="step-num">2</div>
                    <div class="step-content">
                        <div class="step-title">Fill The Grid</div>
                        <div class="step-desc">Tap a slot to open the market and pick a prediction.</div>
                    </div>
                </div>
                <div class="rule-step">
                    <div class="step-num">3</div>
                    <div class="step-content"><div class="step-title">Manage Budget</div><div class="step-desc">You have <strong>$100M</strong>. High probability events cost more!</div></div>
                </div>
            </div>
            <div class="rules-card">
                <div class="step-title" style="margin-bottom:15px; border-bottom:none;">SCORING</div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px;"><span>Correct Tile</span><b>10 PTS</b></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px;"><span>Line Bonus</span><b>+30 PTS</b></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px;"><span>4 Corners</span><b>+50 PTS</b></div>
                <div style="display:flex; justify-content:space-between; font-size:13px;"><span>Full Card</span><b>+100 PTS</b></div>
            </div>
        </div>
    </div>

    <div class="panel" id="desktopRightPanel">
        <div class="tab-header"><div class="tab-btn active">STANDINGS</div></div>
        <div style="padding:20px;"><div class="score-box"><div class="score-val" id="deskScoreDisplay">0</div><div class="score-lbl">POINTS</div></div></div>
    </div>
</div>

<div class="mobile-nav">
    <div class="nav-item active" onclick="switchMobileView('game', this)"><div class="nav-icon">‚äû</div>GRID</div>
    <div class="nav-item" onclick="switchMobileView('standings', this)"><div class="nav-icon">üèÜ</div>SCORE</div>
    <div class="nav-item" onclick="switchMobileView('rules', this)"><div class="nav-icon">‚Ñπ</div>RULES</div>
</div>

<script>
    class DataManager {
        constructor() { this.type = 'local'; }
        save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
        load(key) { const d = localStorage.getItem(key); return d ? JSON.parse(d) : null; }
    }
    const db = new DataManager();

    let activeRace = 'aus';
    let currentGrid = Array(9).fill(null);
    let verifiedResults = [];
    let isGridLocked = false;
    let isUserLocked = false;
    const BUDGET_CAP = 100;
    let activeMarketTab = 'drivers';

    const templates = {
        balanced: ['driver','team','driver', 'team','driver','fia', 'driver','fia','team'],
        team:     ['team','team','driver', 'team','team','team', 'driver','team','fia'],
        chaos:    ['fia','fia','driver',   'fia','fia','fia',    'team','fia','driver'],
        driver:   ['driver','driver','team', 'driver','driver','driver', 'fia','driver','team']
    };

    window.onload = () => {
        if(typeof BINGO_CONFIG === 'undefined') return alert("Error: bingo_data.js missing.");
        const savedRace = localStorage.getItem('current_race_id');
        if(savedRace) activeRace = savedRace;

        renderRaces();
        buildMarketGrids(); 
        
        const savedName = localStorage.getItem('f1_team_name');
        const savedGrid = db.load(`grid_${activeRace}`);
        
        if(savedName) document.getElementById('teamNameInput').value = savedName;
        if(savedName && savedGrid) login(true);
        
        setInterval(checkLockStatus, 1000);
        updateBudgetUI();
    };

    function switchMobileView(view, btn) {
        ['game','standings','rules','strategy','login'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(btn) btn.classList.add('active');
    }

    function showMarketTab(tab) {
        activeMarketTab = tab;
        document.querySelectorAll('#marketTabs .tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tabBtn-${tab}`).classList.add('active');
        
        document.getElementById('drivers-root').style.display = 'none';
        document.getElementById('teams-root').style.display = 'none';
        document.getElementById('fia-root').style.display = 'none';
        document.getElementById('market-detail').classList.remove('active');

        // Fix layout visibility based on tab
        if(tab === 'drivers') {
            document.getElementById('drivers-root').style.display = 'grid';
        } else if (tab === 'teams') {
            document.getElementById('teams-root').style.display = 'flex';
        } else {
            document.getElementById('fia-root').style.display = 'block';
        }
    }

    function login(auto) {
        const name = document.getElementById('teamNameInput').value;
        if(!auto) {
            if(!name) return showModal("MISSING INFO", "Please enter a team name.", false);
            localStorage.setItem('f1_team_name', name);
        }
        document.getElementById('displayTeamName').innerText = name.toUpperCase();
        const savedGrid = db.load(`grid_${activeRace}`);
        const ul = localStorage.getItem(`userLock_${activeRace}`);
        if(ul==='true') isUserLocked = true;

        if(savedGrid) { currentGrid = savedGrid; switchMobileView('game'); renderRaceHeader(); renderGrid(); }
        else { 
            switchMobileView('strategy'); 
            const r = BINGO_CONFIG.races.find(r=>r.id===activeRace); 
            document.getElementById('stratFlag').src = `https://flagcdn.com/w160/${r.c}.png`;
            document.getElementById('stratRaceName').innerText = r.n.toUpperCase();
            document.getElementById('stratRaceDate').innerText = r.d.toUpperCase();
        }
        updateActionButtons();
    }

    function buildMarketGrids() {
        const dRoot = document.getElementById('drivers-root');
        BINGO_CONFIG.drivers.filter(d=>d.team!=='FIA').forEach(d => {
            dRoot.appendChild(createDriverCard(d));
        });

        const tRoot = document.getElementById('teams-root');
        BINGO_CONFIG.constructors.filter(c=>c.type==='Team').forEach(t => {
            tRoot.appendChild(createTeamCard(t));
        });

        const fRoot = document.getElementById('fia-root');
        BINGO_CONFIG.templates.fia.forEach(f => {
            fRoot.appendChild(createPredictionBtn('Race Control', f.t, f.c, 'fia', 'Race Control', 'FIA'));
        });
    }

    function createDriverCard(d) {
        const div = document.createElement('div');
        div.className = 'driver-card-market';
        div.style.setProperty('--team-color', d.color);
        div.innerHTML = `<img src="${d.img}" class="dcm-img"><div class="dcm-name">${d.name}</div>`;
        div.onclick = () => openDrillDown(d, 'driver');
        return div;
    }

    function createTeamCard(t) {
        const div = document.createElement('div');
        div.className = 'team-card-market';
        div.style.setProperty('--team-color', t.color);
        div.innerHTML = `<div class="tcm-name">${t.name}</div><img src="${t.img}" class="tcm-img">`;
        div.onclick = () => openDrillDown(t, 'team');
        return div;
    }

    function openDrillDown(entity, type) {
        document.getElementById('drivers-root').style.display = 'none';
        document.getElementById('teams-root').style.display = 'none';
        
        const detail = document.getElementById('market-detail');
        detail.classList.add('active');
        document.getElementById('detail-title').innerText = entity.name.toUpperCase();
        
        const list = document.getElementById('detail-list');
        list.innerHTML = ''; 

        // Live Budget Calc for "Red Price" Check
        const currentSpent = currentGrid.reduce((sum, item) => sum + (item ? item.cost : 0), 0);
        const remaining = BUDGET_CAP - currentSpent;

        if(type === 'driver') {
            const opts = [...BINGO_CONFIG.templates.quali.map(t=>({...t,s:'QUALI'})), ...BINGO_CONFIG.templates.race.map(t=>({...t,s:'RACE'})), ...BINGO_CONFIG.templates.bonus.map(t=>({...t,s:'BONUS'}))];
            opts.forEach(o => {
                const cost = (entity.price||0) + o.c + (entity.tier===1 && o.t.includes('Points')?20:0);
                const isExpensive = cost > remaining;
                list.appendChild(createPredictionBtn(entity.name, o.t, cost, 'driver', entity.name, o.s, entity, isExpensive));
            });
        } else {
            BINGO_CONFIG.templates.team.forEach(o => {
                let cost = (entity.price||0) + o.c;
                // ** LOGIC FIX FOR TEAM TIER 1 TAX **
                if(entity.tier === 1 && o.t.includes('One Driver')) cost += 28; // Special case for "One Driver in Points"
                else if(entity.tier === 1 && o.t.includes('Double')) cost += 15;
                
                const isExpensive = cost > remaining;
                list.appendChild(createPredictionBtn(entity.name, o.t, cost, 'team', entity.name, 'TEAM', entity, isExpensive));
            });
        }
    }

    function backToRoot() {
        document.getElementById('market-detail').classList.remove('active');
        showMarketTab(activeMarketTab);
    }

    function createPredictionBtn(displayOwner, text, cost, type, dName, sub, entity, isExpensive) {
        const div = document.createElement('div');
        
        let img = 'images/fia.png';
        let col = '#333';
        let isFia = false;
        let isTeam = false;

        if(entity) { 
            img = entity.img; col = entity.color; 
            if(type === 'team') isTeam = true;
        } else { isFia = true; } 

        div.className = `prediction-btn ${isTeam ? 'team-mode' : ''} ${isExpensive ? 'unaffordable' : ''}`;

        div.innerHTML = `
            <div class="pb-left ${isFia?'fia-bg':''}" style="background:${col}"><img src="${img}" class="pb-img"></div>
            <div class="pb-right"><div class="pb-text">${text}</div><div class="pb-cost">$${cost}M</div></div>
        `;
        // Allow clicking even if expensive, so they see the modal
        div.onclick = () => fillSlot(`${displayOwner} ${text}`, type, cost, dName, sub);
        return div;
    }

    // --- GAMEPLAY FUNCS ---
    function confirmStrategy(type) {
        currentGrid = templates[type].map(t => null);
        renderGridStructure(templates[type]);
        switchMobileView('game');
        renderRaceHeader();
        db.save(`grid_${activeRace}`, currentGrid);
    }

    function changeStrategy() {
        if(isGridLocked || isUserLocked) return;
        showModal("CHANGE SETUP?", "Wipe grid?", true, () => { db.save(`grid_${activeRace}`, null); localStorage.removeItem(`userLock_${activeRace}`); location.reload(); });
    }

    function renderGridStructure(pattern) {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        pattern.forEach((type, i) => {
            const slot = document.createElement('div');
            slot.dataset.index = i;
            slot.className = 'slot'; 
            slot.dataset.req = type; 
            slot.innerText = type === 'fia' ? "FIA" : type.toUpperCase();
            slot.onclick = () => handleSlotClick(i, type);
            grid.appendChild(slot);
        });
    }

    function renderGrid() {
        const slots = document.querySelectorAll('.slot');
        slots.forEach(s => {
            const idx = parseInt(s.dataset.index);
            const data = currentGrid[idx];
            if(data) {
                let drv = BINGO_CONFIG.drivers.find(d => d.name === data.driver);
                if(!drv) drv = BINGO_CONFIG.constructors.find(c => c.name === data.driver);
                if(!drv && data.type === 'fia') drv = {name:'RC', color:'#333', img:'images/fia.png'};

                s.style.setProperty('--team-color-hex', drv.color);
                s.style.setProperty('--cat-text-color', data.type==='driver'?'#ff9500':(data.type==='team'?'#00d2be':'#e10600'));
                s.className = `slot filled`; s.dataset.type = data.type; s.onclick = null;
                
                s.innerHTML = `
                    <div class="remove-pick-btn" onclick="removePick(${idx}); event.stopPropagation();">√ó</div>
                    <div class="slot-img-container"><img src="${drv.img}" class="slot-img"><div class="slot-price-tag">$${data.cost}M</div></div>
                    <div class="slot-text-container"><div class="slot-sub">${data.subtype}</div><div class="slot-main">${data.text.replace(data.driver,'').trim()}</div></div>
                `;
            } else {
                s.className = 'slot'; s.removeAttribute('style'); delete s.dataset.type;
                s.innerText = s.dataset.req === 'fia' ? "FIA" : s.dataset.req.toUpperCase();
                s.onclick = () => handleSlotClick(idx, s.dataset.req);
            }
        });
        updateScore(); updateBudgetUI(); updateActionButtons();
    }

    function handleSlotClick(idx, type) {
        if(currentGrid[idx] || isGridLocked || isUserLocked) return;
        const panel = document.getElementById('marketPanel');
        if(window.innerWidth <= 1024) panel.classList.add('mobile-modal');
        panel.dataset.targetIndex = idx;
        
        backToRoot(); 
        let tab = 'drivers';
        if(type === 'team') tab = 'teams';
        if(type === 'fia') tab = 'fia';
        showMarketTab(tab);
    }

    function closeMobileMarket() { document.getElementById('marketPanel').classList.remove('mobile-modal'); backToRoot(); }

    function fillSlot(text, type, cost, dName, sub) {
        const panel = document.getElementById('marketPanel');
        let tIdx = parseInt(panel.dataset.targetIndex);
        if(isNaN(tIdx)) { 
             const slots = document.querySelectorAll('.slot');
             for(let i=0; i<slots.length; i++) { if(!currentGrid[i] && slots[i].dataset.req === type) { tIdx = i; break; } }
             if(tIdx === undefined) return alert("No slot");
        }

        const spent = currentGrid.reduce((s,i)=>s+(i?i.cost:0),0);
        if(spent + cost > BUDGET_CAP) return showModal("OVER BUDGET", "You cannot afford this pick.", false);
        
        // ** LOGIC UPDATE: ALLOW MULTIPLE FIA **
        // Check for duplicates only if type is NOT 'fia'
        if(type !== 'fia' && dName) {
            const conflict = currentGrid.some(x => x && x.driver === dName);
            if(conflict) return showModal("RULE VIOLATION", "You can only select one pick per driver/team per race.", false);
        }

        currentGrid[tIdx] = { text, type, driver: dName, subtype: sub, cost };
        db.save(`grid_${activeRace}`, currentGrid);
        renderGrid();
        closeMobileMarket();
        delete panel.dataset.targetIndex;
    }

    function removePick(idx) {
        if(isGridLocked || isUserLocked) return;
        currentGrid[idx] = null; db.save(`grid_${activeRace}`, currentGrid); renderGrid();
    }

    function renderRaces() {
        const bar = document.getElementById('raceBar');
        BINGO_CONFIG.races.forEach(r => {
            const d = document.createElement('div'); d.className = `race-card ${r.id===activeRace?'active':''}`;
            d.onclick = () => { activeRace = r.id; localStorage.setItem('current_race_id', activeRace); location.reload(); };
            d.innerHTML = `<img src="https://flagcdn.com/w40/${r.c}.png" class="race-flag-img"><span class="race-name">${r.n}</span>`;
            bar.appendChild(d);
        });
        renderRaceHeader();
    }

    function renderRaceHeader() {
        const r = BINGO_CONFIG.races.find(x => x.id === activeRace);
        document.getElementById('rhFlag').src = `https://flagcdn.com/w160/${r.c}.png`;
        document.getElementById('rhTitle').innerText = r.n;
        document.getElementById('rhDate').innerText = r.d;
        
        document.getElementById('stratFlag').src = `https://flagcdn.com/w160/${r.c}.png`;
        document.getElementById('stratRaceName').innerText = r.n.toUpperCase();
        document.getElementById('stratRaceDate').innerText = r.d.toUpperCase();
    }

    function checkLockStatus() {
        const r = BINGO_CONFIG.races.find(x => x.id === activeRace);
        if(r.lockTime && new Date(r.lockTime)-new Date() <= 0) isGridLocked = true;
        updateActionButtons();
    }

    function updateActionButtons() {
        const l = document.getElementById('lockBtn'), u = document.getElementById('unlockBtn');
        const full = currentGrid.every(x=>x);
        if(isGridLocked || isUserLocked) {
            l.style.display = 'none';
            u.style.display = isUserLocked && !isGridLocked ? 'flex' : 'none';
            document.getElementById('grid').classList.add('grid-locked');
        } else {
            document.getElementById('grid').classList.remove('grid-locked');
            u.style.display = 'none';
            l.style.display = full ? 'flex' : 'none';
        }
    }

    function toggleUserLock() {
        isUserLocked = !isUserLocked;
        localStorage.setItem(`userLock_${activeRace}`, isUserLocked);
        updateActionButtons();
    }

    function updateScore() { /* Score logic */ }
    function updateBudgetUI() {
        const rem = BUDGET_CAP - currentGrid.reduce((s,i)=>s+(i?i.cost:0),0);
        document.getElementById('hudBudgetVal').innerText = `$${rem}M`;
        document.getElementById('hudBudgetBar').style.width = `${(rem/BUDGET_CAP)*100}%`;
        const c = rem < 0 ? '#e10600' : '#22c55e';
        document.getElementById('hudBudgetVal').style.color = c;
        document.getElementById('hudBudgetBar').style.backgroundColor = c;
    }

    let mCb;
    function showModal(t, txt, conf, cb) {
        document.getElementById('modalTitle').innerText = t;
        document.getElementById('modalText').innerText = txt;
        document.getElementById('modalActions').innerHTML = conf ? `<button class="btn-modal btn-cancel" onclick="closeModal()">CANCEL</button><button class="btn-modal btn-confirm" onclick="execCallback()">CONFIRM</button>` : `<button class="btn-modal btn-confirm" onclick="closeModal()">OK</button>`;
        document.getElementById('customModal').classList.remove('hidden');
        mCb = cb;
    }
    function closeModal() { document.getElementById('customModal').classList.add('hidden'); mCb = null; }
    function execCallback() { if(mCb) mCb(); closeModal(); }

</script>
</body>
</html>