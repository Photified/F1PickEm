<!DOCTYPE html>
<html lang="en" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#e10600">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>F1 PICKEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,400;0,700;0,900;1,400&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script src="bingo_data.js"></script>

    <style>
        :root {
            --brand-red: #e10600; --brand-dark: #15151e; --bg-body: #f8f9fa;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.08);
            --c-driver: #ff9500; --c-team: #00d2be; --c-fia: #e10600; 
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        body { font-family: 'Titillium Web', sans-serif; background: var(--bg-body); color: var(--brand-dark); margin: 0; height: 100dvh; width: 100vw; display: flex; flex-direction: column; overflow: hidden; }
        .hidden { display: none !important; }

        /* LOADING SPINNER */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--brand-red); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* HEADER */
        header { background: white; border-bottom: 3px solid var(--brand-red); height: 60px; flex: 0 0 60px; display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); z-index: 20; position: relative; }
        .logo-area { padding: 0 15px; height: 100%; display: flex; align-items: center; border-right: 1px solid #eee; cursor: pointer; }
        .header-logo { max-height: 28px; width: auto; }
        
        /* SCROLL ARROWS */
        .scroll-arrow { display: none; width: 30px; height: 100%; background: #fff; align-items: center; justify-content: center; cursor: pointer; z-index: 30; font-weight: 900; color: #888; user-select: none; transition: 0.2s; }
        .scroll-arrow:hover { background: #f5f5f5; color: var(--brand-red); }
        .scroll-arrow.left { border-right: 1px solid #eee; }
        .scroll-arrow.right { border-left: 1px solid #eee; }
        @media (min-width: 1024px) { .scroll-arrow { display: flex; } }

        .race-scroll-area { flex: 1; display: flex; flex-direction: row; align-items: center; overflow-x: auto; height: 100%; scrollbar-width: none; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
        .race-card { flex: 0 0 auto; min-width: 70px; padding: 0 12px; height: 100%; display: inline-flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid #f5f5f5; cursor: pointer; opacity: 0.5; transition: 0.2s; }
        .race-card.active { opacity: 1; background: #fff; border-bottom: 4px solid var(--brand-red); }
        .race-flag-img { width: 24px; height: 16px; object-fit: cover; border-radius: 2px; margin-bottom: 4px; }
        .race-name { font-size: 9px; font-weight: 800; text-transform: uppercase; white-space: nowrap; }
        .user-area { padding: 0 15px; font-weight: 800; font-size: 12px; border-left: 1px solid #eee; height: 100%; display: flex; align-items: center; background: #fff; z-index: 25; cursor:pointer; }

        /* MAIN STAGE */
        .main-stage { flex: 1; display: grid; grid-template-columns: 320px 1fr 300px; padding: 20px; gap: 20px; overflow: hidden; min-height: 0; }
        .panel { background: white; border-radius: 12px; box-shadow: var(--card-shadow); overflow: hidden; display: flex; flex-direction: column; border: 1px solid #e0e0e0; height: 100%; }
        .active-panel { background: white; border-radius: 12px; border: 1px solid #e0e0e0; padding: 0; display: flex; flex-direction: column; overflow: hidden; height: 100%; min-height: 0; position: relative; }
        .view-scrollable { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* FILTER TOGGLE */
        .filter-bar { padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; font-size: 12px; font-weight: 800; color: #555; }
        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--brand-red); }
        input:checked + .slider:before { transform: translateX(14px); }

        /* LOGIN / BUTTONS */
        .view-login { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; height: 100%; overflow-y: auto; }
        .login-btn-google { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 24px; background: white; color: #333; border: 1px solid #ccc; font-weight: 700; cursor: pointer; border-radius: 8px; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: 100%; max-width: 300px; transition: 0.2s; }
        .login-btn-google:active { transform: scale(0.98); background: #f5f5f5; }
        .google-icon { width: 20px; height: 20px; }
        .primary-btn { width: 100%; padding: 14px; background: var(--brand-red); color: white; border: none; font-weight: 900; cursor: pointer; border-radius: 8px; font-size: 16px; box-shadow: 0 4px 10px rgba(225, 6, 0, 0.2); margin-top: 20px; }

        /* SETUP & PROFILE */
        .setup-input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; font-size: 16px; margin-bottom: 15px; font-weight: bold; background: white; }
        .setup-label { width: 100%; text-align: left; font-size: 11px; font-weight: 900; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .profile-card { background: white; padding: 40px 25px; border-radius: 15px; text-align: center; box-shadow: var(--card-shadow); width: 100%; max-width: 350px; border: 1px solid #eee; }
        .logout-btn { margin-top: 30px; background: #333; color: white; border: none; padding: 12px 30px; font-weight: 900; border-radius: 8px; cursor: pointer; width: 100%; }

        /* LEADERBOARD & RULES */
        .leaderboard-row { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: white; }
        .leaderboard-row:first-child { background: #f9f9f9; border-top: 1px solid #eee; border-radius: 8px 8px 0 0; }
        .lb-rank { width: 40px; font-weight: 900; color: #888; font-style: italic; font-size: 16px; }
        .lb-user { flex: 1; font-weight: 800; font-size: 15px; text-transform: uppercase; color: #222; }
        .lb-pts { font-weight: 900; color: var(--brand-red); width: 60px; text-align: right; font-size: 16px; }
        .score-box { text-align: center; margin-bottom: 20px; padding: 25px; background: #fff; border-radius: 12px; border: 1px solid #eee; box-shadow: var(--card-shadow); }
        .score-val { font-size: 42px; font-weight: 900; color: var(--brand-dark); line-height: 1; }
        .score-lbl { font-size: 12px; font-weight: 700; color: #888; text-transform: uppercase; margin-top: 5px; letter-spacing: 1px; }
        .rules-card { background: white; border: 1px solid #eee; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .rule-step { display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start; }
        .step-num { flex: 0 0 30px; height: 30px; background: var(--brand-red); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 14px; }
        .step-content { flex: 1; }
        .step-title { font-weight: 900; font-size: 14px; margin-bottom: 5px; text-transform: uppercase; color: #333; }
        .step-desc { font-size: 13px; color: #666; line-height: 1.4; margin: 0; }
        .chip-example { display: flex; align-items: center; gap: 10px; margin-top: 5px; background: #f9f9f9; padding: 8px; border-radius: 6px; border: 1px solid #eee; }
        .ce-text { font-size: 11px; font-weight: 800; color: #333; text-transform: uppercase; }

        /* STRATEGY SCREEN */
        .view-strategy { text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center; height: 100%; padding: 20px; overflow-y: auto; }
        .strategy-header-container { margin-top: 20px; margin-bottom: 30px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .big-flag { width: 100px; height: auto; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 10px; }
        .strat-race-name { font-size: 32px; font-weight: 900; font-style: italic; text-transform: uppercase; line-height: 1; color: var(--brand-dark); }
        .strat-race-date { font-size: 16px; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 10px; }
        .strat-sub { color: #888; font-size: 11px; font-weight: 800; letter-spacing: 1px; }
        .strat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; width: 100%; }
        .strat-card { background: #fff; border: 2px solid #eee; border-radius: 12px; padding: 20px; cursor: pointer; display: flex; flex-direction: column; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .mini-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; width: 60px; height: 60px; margin-bottom: 10px; opacity: 0.8; } 
        .mg-c { border-radius: 1px; width: 100%; height: 100%; }

        /* MODALS */
        #customModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-box { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 320px; text-align: center; }
        .btn-modal { padding: 12px 24px; border-radius: 8px; font-weight: 800; cursor: pointer; border: none; margin: 5px; font-size: 14px; }
        .btn-confirm { background: var(--brand-red); color: white; }
        .btn-cancel { background: #eee; color: #333; }
        
        #installModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .install-box { background: white; width: 85%; max-width: 320px; border-radius: 16px; padding: 30px 20px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .install-icon { width: 60px; height: 60px; background: #e10600; border-radius: 12px; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px; font-weight: bold; }
        .install-btn { width: 100%; padding: 14px; background: #22c55e; color: white; border: none; border-radius: 8px; font-weight: 900; font-size: 14px; margin-top: 15px; cursor: pointer; box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3); }
        .install-dismiss { width: 100%; padding: 12px; background: transparent; color: #888; border: none; font-weight: 700; font-size: 12px; margin-top: 5px; cursor: pointer; }
        .manual-install-btn { display: none; width: 100%; padding: 14px; background: #333; color: white; border: none; border-radius: 8px; font-weight: 900; font-size: 14px; margin-top: 20px; cursor: pointer; }

        /* GAME HEADER & CONTROLS */
        #raceHeader { padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; height: 70px; }
        .rh-left { display: flex; align-items: center; gap: 12px; }
        .rh-flag { width: 45px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .rh-title { font-size: 18px; font-weight: 900; font-style: italic; text-transform: uppercase; line-height: 1; }
        .rh-date { font-size: 11px; color: #888; font-weight: 700; margin-top: 2px; }
        .rh-right-group { display: flex; align-items: center; gap: 8px; }
        .header-btn { width: 38px; height: 38px; border-radius: 8px; border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s; }
        .header-btn:active { transform: scale(0.95); }
        .hb-setup { background: white; border: 1px solid #ddd; color: #555; }
        .hb-lock { background: #22c55e; color: white; display: none; } 
        .hb-unlock { background: #ef4444; color: white; display: none; } 
        .budget-hud { background: #f4f4f8; padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; border-left: 4px solid #22c55e; display: flex; flex-direction: column; align-items: flex-end; min-width: 70px; height: 38px; justify-content: center; }
        .budget-hud-val { font-size: 14px; font-weight: 900; color: #22c55e; line-height: 1; }
        .budget-hud-bar-bg { width: 100%; height: 4px; background: #e0e0e0; margin-top: 4px; border-radius: 3px; }
        .budget-hud-bar-fill { height: 100%; background: #22c55e; width: 50%; border-radius: 3px; transition: 0.3s; }

        /* GRID CONTAINER - THE FIX v3 */
        .grid-container { 
            flex: 1; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            height: 100%; 
            min-height: 0; 
            position: relative;
        }
        
        /* THE ACTUAL GRID - FIXED FOR MOBILE & DESKTOP */
        .bingo-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr); 
            gap: 8px; 
            
            /* Desktop Default: Constrained by Height */
            height: 100%; 
            max-height: 100%;
            width: auto;
            aspect-ratio: 3/4; 
            max-width: 100%;
            margin: 0 auto; 
            flex-shrink: 1;
        }
        
        /* MOBILE OVERRIDE: Constrained by Width */
        @media (max-width: 600px) {
            .bingo-grid {
                width: 100%;
                height: auto; /* Allow height to adjust based on width */
                max-height: 100%; /* prevent overflow */
            }
        }
        
        .slot { background: #fafafa; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; position: relative; cursor: pointer; user-select: none; transition: 0.2s; text-transform: uppercase; color: #aaa; width: 100%; height: 100%; overflow: hidden; }
        .slot:active { transform: scale(0.98); background: #eee; }
        .slot[data-req="driver"] { background: #fff8e6; border-color: var(--c-driver); color: var(--c-driver); }
        .slot[data-req="team"] { background: #e0fbf8; border-color: var(--c-team); color: var(--c-team); }
        .slot[data-req="fia"] { background: #fff2f2; border-color: var(--c-fia); color: var(--c-fia); }
        .slot.filled { background: white !important; border: 1px solid #ddd !important; padding: 0; overflow: hidden; display: flex; flex-direction: column; text-align: left; box-shadow: 0 4px 10px rgba(0,0,0,0.08); border-radius: 8px; }
        .slot.filled::before { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 0; border-style: solid; border-width: 24px 24px 0 0; z-index: 5; }
        .slot.filled[data-type="driver"]::before { border-color: var(--c-driver) transparent transparent transparent; }
        .slot.filled[data-type="team"]::before { border-color: var(--c-team) transparent transparent transparent; }
        .slot.filled[data-type="fia"]::before { border-color: var(--c-fia) transparent transparent transparent; }
        
        .slot-img-container { width: 100%; height: 60%; display: flex; align-items: flex-end; justify-content: center; background-color: var(--team-color-hex); position: relative; overflow: hidden; }
        .slot-img { z-index: 2; transition: 0.2s; }
        .slot.filled[data-type="driver"] .slot-img { width: 100%; height: 100%; object-fit: cover; object-position: top center; margin-bottom: 0; }
        .slot.filled[data-type="team"] .slot-img { width: 80%; height: auto; max-height: 80%; object-fit: contain; margin-bottom: 5px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
        
        /* FIA LOGO FIX: CENTERED & NO MARGIN */
        .slot.filled[data-type="fia"] .slot-img-container { align-items: center; }
        .slot.filled[data-type="fia"] .slot-img { width: 50%; height: auto; margin-bottom: 0; filter: brightness(0) invert(1); opacity: 0.8; }
        
        .slot-price-tag { background: rgba(0,0,0,0.8); color: white; font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 12px; position: absolute; bottom: 4px; right: 4px; z-index: 10; border: 1px solid rgba(255,255,255,0.2); }
        .slot-text-container { width: 100%; height: 40%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 2px 4px; background: white; border-top: 1px solid rgba(0,0,0,0.05); }
        .slot-sub { font-size: 7px; text-transform: uppercase; font-weight: 900; color: var(--cat-text-color); margin-bottom: 2px; letter-spacing: 0.5px; opacity: 0.7; }
        .slot-main { font-size: 10px; font-weight: 900; line-height: 1.1; color: #222; text-transform: uppercase; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        @media (min-width: 380px) { .slot-main { font-size: 11px; } }
        .remove-pick-btn { position: absolute; top: 4px; left: 4px; width: 22px; height: 22px; background: rgba(0,0,0,0.3); color: #fff; display: flex; align-items: center; justify-content: center; z-index: 15; border-radius: 50%; font-size: 12px; font-weight: bold; cursor: pointer; backdrop-filter: blur(2px); }
        .slot.matched { opacity: 1; box-shadow: inset 0 0 0 3px var(--score-win); transform: scale(1.02); z-index: 5; }
        .slot.matched::after { content: '‚úì'; position: absolute; top: 4px; right: 4px; background: var(--score-win); color: black; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 20; }

        /* MARKET STYLES */
        .tab-header { display: flex; border-bottom: 1px solid #eee; background: #f9f9f9; flex-shrink: 0; height: 45px; }
        .tab-btn { flex: 1; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px; cursor: pointer; color: #888; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn.active { background: white; color: #000; }
        #tabBtn-drivers.active { border-bottom-color: var(--c-driver); color: var(--c-driver); }
        #tabBtn-teams.active { border-bottom-color: var(--c-team); color: var(--c-team); }
        #tabBtn-fia.active { border-bottom-color: var(--c-fia); color: var(--c-fia); }
        .market-grid-drivers { padding: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; box-sizing: border-box; }
        .driver-card-market { background: var(--team-color); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 140px; cursor: pointer; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: opacity 0.3s; }
        .driver-card-market.dimmed { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        .dcm-img { width: 100%; height: 80%; object-fit: cover; object-position: top center; margin-bottom: 0; z-index: 1; filter: drop-shadow(0 0 5px rgba(0,0,0,0.2)); margin-top: 30px; }
        .dcm-name { width: 100%; background: rgba(20,20,30,0.9); color: white; font-size: 9px; font-weight: 800; text-align: center; padding: 5px 2px; z-index: 2; text-transform: uppercase; line-height: 1; }
        .market-list-teams { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .team-card-market { width: 100%; height: 90px; background: white; border-radius: 8px; border: 1px solid #eee; border-left: 8px solid var(--team-color); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: opacity 0.3s; }
        .team-card-market.dimmed { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        .tcm-name { font-size: 16px; font-weight: 900; text-transform: uppercase; color: #333; }
        .tcm-img { height: 100%; width: 120px; object-fit: contain; object-position: center; }
        .market-detail-view { display: none; flex-direction: column; height: 100%; background: #f4f4f8; }
        .market-detail-view.active { display: flex; }
        .market-detail-header { background: white; padding: 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; font-weight: 900; font-size: 16px; color: #333; position: sticky; top: 0; z-index: 10; }
        .back-btn { font-size: 20px; cursor: pointer; color: #888; }
        .prediction-list { padding: 15px; overflow-y: auto; }
        .prediction-btn { background: white; border-radius: 8px; overflow: hidden; display: flex; height: 55px; margin-bottom: 10px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #ddd; transition: 0.2s; }
        .prediction-btn:active { transform: scale(0.98); }
        .prediction-btn.unaffordable { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        .pb-left { width: 55px; background: var(--team-color); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .pb-img { width: 100%; height: 100%; object-fit: cover; object-position: top center; }
        .prediction-btn.team-mode .pb-left { width: 80px; } 
        .prediction-btn.team-mode .pb-img { width: 90%; height: 90%; object-fit: contain; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        
        /* FIA MARKET FIX: CENTERED */
        .pb-left.fia-bg .pb-img { 
            filter: brightness(0) invert(1); 
            width: 50%; 
            object-fit: contain;
            object-position: center; /* FIXED HERE */
        } 
        
        .pb-right { flex: 1; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff), linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff); background-size: 10px 10px; background-color: #fafafa; }
        .pb-text { font-size: 12px; font-weight: 800; color: #333; text-transform: uppercase; }
        .pb-cost { background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 900; }
        .prediction-btn.unaffordable .pb-cost { background: #ef4444; color: white; } 

        /* MOBILE OVERRIDES */
        @media (max-width: 1024px) {
            .main-stage { grid-template-columns: 1fr; padding: 10px; padding-bottom: 0 !important; }
            .panel { display: none; } 
            .view-scrollable { padding-bottom: 120px !important; }
            .bingo-grid { padding-bottom: 120px !important; }
            .panel.mobile-modal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; border-radius: 0; animation: slideUp 0.25s ease-out; }
            .mobile-close-btn { display: block !important; }
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .mobile-close-btn { display: none; padding: 15px; background: #333; color: white; text-align: center; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }

        /* MOBILE NAV */
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: white; border-top: 1px solid #ddd; z-index: 1000; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); padding-bottom: 15px; }
        .nav-item { flex: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: #888; text-transform: uppercase; cursor: pointer; }
        .nav-item.active { color: var(--brand-red); background: #fff5f5; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }
        @media (max-width: 1024px) { .mobile-nav { display: flex; } }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="margin-top:15px; font-weight:900; letter-spacing:1px; font-size:12px; color:#555;">STARTING ENGINE...</div>
</div>

<div id="installModal" class="hidden">
    <div class="install-box">
        <div class="install-icon">F1</div>
        <h3 style="margin:0; font-style:italic; font-size:22px; color:#222;">INSTALL APP</h3>
        <p style="font-size:13px; color:#666; margin-top:5px; line-height:1.5;">Install F1 Pick'Em for the best fullscreen experience.</p>
        <button class="install-btn" onclick="triggerInstall()">INSTALL NOW</button>
        <button class="install-dismiss" onclick="dismissInstall()">CONTINUE IN BROWSER</button>
    </div>
</div>

<div id="customModal" class="hidden">
    <div class="modal-box">
        <h3 id="modalTitle" style="margin-top:0; color:#e10600; font-style:italic; font-size:20px;">RACE CONTROL</h3>
        <p id="modalText" style="font-size:14px; color:#555; margin-bottom:20px; line-height:1.4;">Text</p>
        <div id="modalActions"></div>
    </div>
</div>

<header>
    <div class="logo-area" onclick="location.reload()">
        <img src="images/logotop.png" class="header-logo" alt="F1 Pick Em">
    </div>
    
    <div class="scroll-arrow left" onclick="scrollRaces(-200)">&#8249;</div>
    <div class="race-scroll-area" id="raceBar"></div>
    <div class="scroll-arrow right" onclick="scrollRaces(200)">&#8250;</div>
    
    <div class="user-area" id="displayTeamName" onclick="switchMobileView('profile')">GUEST</div>
</header>

<div class="main-stage">
    
    <div class="panel" id="marketPanel">
        <div class="mobile-close-btn" onclick="closeMobileMarket()">CLOSE MARKET √ó</div>
        
        <div class="filter-bar">
            <span>AFFORDABLE ONLY</span>
            <label class="toggle-switch">
                <input type="checkbox" id="budgetFilterToggle" onchange="applyBudgetFilter()">
                <span class="slider"></span>
            </label>
        </div>

        <div class="tab-header" id="marketTabs">
            <div class="tab-btn active" id="tabBtn-drivers" onclick="showMarketTab('drivers')">DRIVERS</div>
            <div class="tab-btn" id="tabBtn-teams" onclick="showMarketTab('teams')">TEAMS</div>
            <div class="tab-btn" id="tabBtn-fia" onclick="showMarketTab('fia')">FIA</div>
        </div>
        <div id="marketContent" style="flex:1; overflow-y:auto; position:relative;">
            <div id="drivers-root" class="market-grid-drivers"></div>
            <div id="teams-root" class="market-list-teams" style="display:none;"></div>
            <div id="fia-root" class="prediction-list" style="display:none;"></div>
            <div id="market-detail" class="market-detail-view">
                <div class="market-detail-header">
                    <div class="back-btn" onclick="backToRoot()">‚Üê</div>
                    <div id="detail-title">Entity Name</div>
                </div>
                <div id="detail-list" class="prediction-list"></div>
            </div>
        </div>
    </div>

    <div class="active-panel" id="mainPanel">
        
        <div id="view-login" class="view-login">
            <h2 style="font-style:italic; font-size:24px; margin-bottom:20px;">TEAM PRINCIPAL LOGIN</h2>
            <button class="login-btn-google" onclick="loginWithGoogle()">
                <svg class="google-icon" viewBox="0 0 48 48">
                    <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/>
                    <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/>
                    <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/>
                    <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/>
                </svg>
                Sign in with Google
            </button>
        </div>

        <div id="view-setup" class="view-login hidden" style="justify-content:flex-start; padding-top:40px;">
            <h2 style="font-style:italic; font-size:24px; margin-bottom:20px;">CREATE YOUR TEAM</h2>
            
            <div class="setup-label">Team Name</div>
            <input type="text" id="setupTeamName" class="setup-input" placeholder="e.g. Red Bull Racing">
            
            <button class="primary-btn" onclick="completeSetup()">COMPLETE REGISTRATION</button>
        </div>

        <div id="view-profile" class="view-login hidden">
            <div class="profile-card">
                <h2 style="font-style:italic; margin-bottom:5px; text-transform:uppercase; font-size:24px;" id="profileName">PLAYER NAME</h2>
                <div style="font-size:12px; color:#888; font-weight:700;" id="profileEmail">player@email.com</div>
                <button class="logout-btn" onclick="signOut()">LOG OUT</button>
            </div>
        </div>

        <div id="view-strategy" class="view-strategy hidden">
            <div class="strategy-header-container">
                <img id="stratFlag" src="" class="big-flag">
                <div id="stratRaceName" class="strat-race-name">AUSTRALIA</div>
                <div id="stratRaceDate" class="strat-race-date">MAR 8</div>
                <div class="strat-sub">SELECT GRID FORMATION</div>
            </div>
            <div class="strat-grid">
                <div class="strat-card" onclick="confirmStrategy('balanced')"><div class="mini-grid"><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-team)"></div></div><strong>Balanced</strong></div>
                <div class="strat-card" onclick="confirmStrategy('team')"><div class="mini-grid"><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-fia)"></div></div><strong>Constructor</strong></div>
                <div class="strat-card" onclick="confirmStrategy('chaos')"><div class="mini-grid"><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div></div><strong>FIA / Chaos</strong></div>
                <div class="strat-card" onclick="confirmStrategy('driver')"><div class="mini-grid"><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div></div><strong>Driver Focus</strong></div>
            </div>
        </div>

        <div id="view-game" class="view-game hidden" style="width:100%; height:100%; display:flex; flex-direction:column; min-height:0;">
            <div id="raceHeader">
                <div class="rh-left"><img id="rhFlag" src="" class="rh-flag"><div><div id="rhTitle" class="rh-title">RACE</div><div id="rhDate" class="rh-date">DATE</div></div></div>
                <div class="rh-right-group">
                    <button id="headerLockBtn" class="header-btn hb-lock" onclick="toggleUserLock()">üîí</button>
                    <button id="headerUnlockBtn" class="header-btn hb-unlock" onclick="toggleUserLock()">üîì</button>
                    <button class="header-btn hb-setup" onclick="changeStrategy()">‚öô</button>
                    <div class="budget-hud"><span style="font-size:9px; font-weight:800; color:#888;">CAP SPACE</span><div class="budget-hud-val" id="hudBudgetVal">$100M</div><div class="budget-hud-bar-bg"><div class="budget-hud-bar-fill" id="hudBudgetBar"></div></div></div>
                </div>
            </div>
            <div class="grid-container"><div id="grid" class="bingo-grid"></div></div>
        </div>
        
        <div id="view-standings" class="view-scrollable hidden">
            <div style="padding:20px;">
                <div class="score-box"><div class="score-val" id="myTotalScore">0</div><div class="score-lbl">My Total Points</div></div>
                <h3 style="margin:20px 0 10px 0; font-style:italic;">SEASON STANDINGS</h3>
                <div id="leaderboardList" style="background:white; border-radius:12px; overflow:hidden; border:1px solid #eee; box-shadow:var(--card-shadow);">
                    <div style="padding:20px; text-align:center; color:#888;">Loading standings...</div>
                </div>
            </div>
        </div>

        <div id="view-rules" class="view-scrollable hidden">
            <div id="rulesContentMobile"></div> 
            <button class="manual-install-btn" onclick="triggerInstall()">‚¨á INSTALL APP</button>
        </div>
    </div>

    <div class="panel" id="desktopRightPanel">
        <div class="tab-header">
            <div class="tab-btn active" id="dtTab-standings" onclick="showDesktopTab('standings')">STANDINGS</div>
            <div class="tab-btn" id="dtTab-rules" onclick="showDesktopTab('rules')">RULES</div>
        </div>
        
        <div id="dt-standings" class="view-scrollable">
            <div style="padding:20px;">
                <div class="score-box"><div class="score-val" id="deskScoreDisplay">0</div><div class="score-lbl">POINTS</div></div>
                <div id="deskLeaderboardList" style="margin-top:20px; background:white; border-radius:12px; overflow:hidden; border:1px solid #eee;"></div>
            </div>
        </div>
        
        <div id="dt-rules" style="padding:20px; display:none; overflow-y:auto; height:100%;">
            <div id="rulesContentDesktop"></div>
        </div>
    </div>
</div>

<div class="mobile-nav">
    <div class="nav-item active" onclick="switchMobileView('game', this)"><div class="nav-icon">‚äû</div>GRID</div>
    <div class="nav-item" onclick="switchMobileView('standings', this)"><div class="nav-icon">üèÜ</div>SCORE</div>
    <div class="nav-item" onclick="switchMobileView('rules', this)"><div class="nav-icon">‚Ñπ</div>RULES</div>
</div>

<script>
  // Service Worker
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

  // --- FIREBASE CONFIGURATION ---
  const firebaseConfig = {
  apiKey: "AIzaSyA4tMo0m5HMYVUqpavy1ELkAUNsRd3c9gA",
  authDomain: "f1-pickem-25550.firebaseapp.com",
  projectId: "f1-pickem-25550",
  storageBucket: "f1-pickem-25550.firebasestorage.app",
  messagingSenderId: "698392572260",
  appId: "1:698392572260:web:0ffda4c77e17d2a4f50a71"
  };
  // ------------------------------

  // Init Firebase
  let db = null;
  let auth = null;
  let currentUser = null;
  let userProfile = null; 

  try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      auth = firebase.auth();
      console.log("Firebase & Auth Initialized");
  } catch(e) {
      console.error("Firebase Init Error:", e);
  }

  // PWA Logic
  let deferredPrompt;
  function isPWA() { return (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone === true); }
  function isMobile() { return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent); }

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (!localStorage.getItem('installDismissed') && !isPWA() && isMobile()) {
        document.getElementById('installModal').classList.remove('hidden');
    }
    document.querySelectorAll('.manual-install-btn').forEach(b => b.style.display = 'block');
  });

  window.onload = async () => {
      if(typeof BINGO_CONFIG === 'undefined') return alert("Error: bingo_data.js missing.");
      
      const savedRace = localStorage.getItem('current_race_id');
      if(savedRace) activeRace = savedRace;

      renderRaces();
      buildMarketGrids(); 
      renderDesktopRules();

      // AUTH STATE LISTENER (Auto-login)
      auth.onAuthStateChanged(async (user) => {
          if (user) {
              currentUser = user;
              await loadUserData(user.uid);
          } else {
              document.getElementById('loadingOverlay').classList.add('hidden');
              switchMobileView('login');
          }
      });

      setInterval(checkLockStatus, 1000);
      loadStandings(); 
      
      setTimeout(() => {
          if (!isPWA() && !localStorage.getItem('installDismissed') && isMobile()) {
              if (!deferredPrompt) {
                  // document.getElementById('installModal').classList.remove('hidden');
              }
          }
      }, 2000);
  };

  function scrollRaces(amount) {
      document.getElementById('raceBar').scrollLeft += amount;
  }

  async function triggerInstall() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') { deferredPrompt = null; document.getElementById('installModal').classList.add('hidden'); }
    } else {
        const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
        alert(isIos ? "Tap Share -> Add to Home Screen" : "Menu -> Install App");
        document.getElementById('installModal').classList.add('hidden');
    }
  }

  function dismissInstall() {
      document.getElementById('installModal').classList.add('hidden');
      localStorage.setItem('installDismissed', 'true');
  }

  /* APP LOGIC */
  let activeRace = 'aus';
  let currentGrid = Array(9).fill(null);
  let currentStrategy = null; 
  let isGridLocked = false;
  let isUserLocked = false;
  const BUDGET_CAP = 100;
  let activeMarketTab = 'drivers';

  const templates = {
        balanced: ['driver','team','driver', 'team','driver','fia', 'driver','fia','team'],
        team:     ['team','team','driver', 'team','team','team', 'driver','team','fia'],
        chaos:    ['fia','fia','driver',   'fia','fia','fia',    'team','fia','driver'],
        driver:   ['driver','driver','team', 'driver','driver','driver', 'fia','driver','team']
  };

  function switchMobileView(view, btn) {
        ['game','standings','rules','strategy','login', 'profile', 'setup'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(view === 'standings') loadStandings(); 
  }

  function showDesktopTab(tab) {
        document.querySelectorAll('#desktopRightPanel .tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`dtTab-${tab}`).classList.add('active');
        document.getElementById('dt-standings').style.display = 'none';
        document.getElementById('dt-rules').style.display = 'none';
        document.getElementById(`dt-${tab}`).style.display = 'block';
  }

  function renderDesktopRules() {
        const html = `
            <div class="rules-card">
                <div class="rule-step"><div class="step-num">1</div><div class="step-content"><div class="step-title">Strategy</div><div class="step-desc">Pick your grid layout. Each grid has a different strategy!</div></div></div>
                <div class="rule-step"><div class="step-num">2</div><div class="step-content"><div class="step-title">Fill Grid</div><div class="step-desc">Tap slots to predict. One prediction per driver and team.</div></div></div>
                <div class="rule-step"><div class="step-num">3</div><div class="step-content"><div class="step-title">$100M Cap</div><div class="step-desc">Manage your budget. Higher probability predictions cost more.</div></div></div>
            </div>
            <div class="rules-card">
                <div class="step-title" style="margin-bottom:15px; border-bottom:none;">SCORING</div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px;"><span>Correct Tile</span><b>10 PTS</b></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px;"><span>Line Bonus</span><b>+30 PTS</b></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px;"><span>4 Corners</span><b>+50 PTS</b></div>
                <div style="display:flex; justify-content:space-between; font-size:13px;"><span>Full Card</span><b>+100 PTS</b></div>
            </div>
        `;
        document.getElementById('rulesContentMobile').innerHTML = html;
        document.getElementById('rulesContentDesktop').innerHTML = html;
  }

  function showMarketTab(tab) {
        activeMarketTab = tab;
        document.querySelectorAll('#marketTabs .tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tabBtn-${tab}`).classList.add('active');
        
        document.getElementById('drivers-root').style.display = 'none';
        document.getElementById('teams-root').style.display = 'none';
        document.getElementById('fia-root').style.display = 'none';
        document.getElementById('market-detail').classList.remove('active');

        if(tab === 'drivers') {
            document.getElementById('drivers-root').style.display = 'grid';
        } else if (tab === 'teams') {
            document.getElementById('teams-root').style.display = 'flex';
        } else {
            document.getElementById('fia-root').style.display = 'block';
        }
        applyBudgetFilter(); // Re-apply filter when tab changes
  }

  // --- FIREBASE AUTH & DATA LOGIC ---
  
  function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
          .catch((error) => {
              console.error("Login Failed:", error);
              showModal("Login Error", error.message, false);
          });
  }

  function signOut() {
      auth.signOut().then(() => {
          location.reload();
      });
  }

  async function loadUserData(uid) {
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        try {
            const docRef = db.collection('users').doc(uid);
            const doc = await docRef.get();
            
            if(doc.exists) {
                const data = doc.data();
                userProfile = data; 
                
                // Update Profile View UI
                document.getElementById('displayTeamName').innerText = (data.teamName || "RACER").toUpperCase();
                document.getElementById('profileName').innerText = (data.teamName || "RACER").toUpperCase();
                document.getElementById('profileEmail').innerText = currentUser.email;

                currentGrid = data[`grid_${activeRace}`] || null;
                currentStrategy = data[`strat_${activeRace}`] || 'balanced'; 
                
                if(currentGrid) {
                    switchMobileView('game');
                    renderRaceHeader();
                    renderGridStructure(templates[currentStrategy] || templates['balanced']);
                    renderGrid();
                } else {
                    switchMobileView('strategy');
                    renderStrategyHeader();
                }
            } else {
                // NEW USER -> GOTO SETUP
                switchMobileView('setup');
            }
        } catch(e) {
            console.error("Load Data Error:", e);
        }
        
        document.getElementById('loadingOverlay').classList.add('hidden');
        updateActionButtons();
  }

  async function completeSetup() {
      const tName = document.getElementById('setupTeamName').value;
      
      if(!tName) return alert("Please enter a Team Name");

      document.getElementById('loadingOverlay').classList.remove('hidden');
      
      try {
          await db.collection('users').doc(currentUser.uid).set({
              email: currentUser.email,
              displayName: currentUser.displayName,
              teamName: tName,
              totalPoints: 0,
              createdAt: new Date()
          });
          // Reload to fetch new profile
          await loadUserData(currentUser.uid);
      } catch(e) {
          console.error("Setup Error", e);
          alert("Error saving profile.");
          document.getElementById('loadingOverlay').classList.add('hidden');
      }
  }

  async function saveGrid() {
      if(!currentUser) return;
      try {
          await db.collection('users').doc(currentUser.uid).set({
              [`grid_${activeRace}`]: currentGrid,
              [`strat_${activeRace}`]: currentStrategy, 
              last_updated: new Date()
          }, { merge: true });
      } catch(e) { console.error("Save error", e); }
  }

  // --- LEADERBOARD LOGIC ---
  async function loadStandings() {
      if(!db) return;
      
      const listMobile = document.getElementById('leaderboardList');
      const listDesk = document.getElementById('deskLeaderboardList');
      
      try {
          const snapshot = await db.collection('users').orderBy('totalPoints', 'desc').limit(50).get();
          let html = '';
          let rank = 1;
          
          snapshot.forEach(doc => {
              const u = doc.data();
              html += `
                <div class="leaderboard-row">
                    <div class="lb-rank">${rank}</div>
                    <div class="lb-user">
                        ${u.teamName || "Racer"}
                    </div>
                    <div class="lb-pts">${u.totalPoints || 0}</div>
                </div>
              `;
              rank++;
              
              if(currentUser && doc.id === currentUser.uid) {
                  document.getElementById('myTotalScore').innerText = u.totalPoints || 0;
                  document.getElementById('deskScoreDisplay').innerText = u.totalPoints || 0;
              }
          });
          
          listMobile.innerHTML = html;
          listDesk.innerHTML = html;
      } catch(e) {
          console.error("Leaderboard Error", e);
      }
  }

  // --- END AUTH LOGIC ---

  function renderStrategyHeader() {
        const r = BINGO_CONFIG.races.find(r=>r.id===activeRace); 
        document.getElementById('stratFlag').src = `https://flagcdn.com/w160/${r.c}.png`;
        document.getElementById('stratRaceName').innerText = r.n.toUpperCase();
        document.getElementById('stratRaceDate').innerText = r.d.toUpperCase();
  }

  function buildMarketGrids() {
        const dRoot = document.getElementById('drivers-root');
        BINGO_CONFIG.drivers.filter(d=>d.team!=='FIA').forEach(d => {
            dRoot.appendChild(createDriverCard(d));
        });

        const tRoot = document.getElementById('teams-root');
        BINGO_CONFIG.constructors.filter(c=>c.type==='Team').forEach(t => {
            tRoot.appendChild(createTeamCard(t));
        });

        const fRoot = document.getElementById('fia-root');
        BINGO_CONFIG.templates.fia.forEach(f => {
            fRoot.appendChild(createPredictionBtn('Race Control', f.t, f.c, 'fia', 'Race Control', 'FIA'));
        });
  }

  function createDriverCard(d) {
        const div = document.createElement('div');
        div.className = 'driver-card-market';
        div.dataset.price = d.price || 0; // Store price for filtering
        div.dataset.name = d.name; // Tag for selection filtering
        div.style.setProperty('--team-color', d.color);
        div.innerHTML = `<img src="${d.img}" class="dcm-img"><div class="dcm-name">${d.name}</div>`;
        div.onclick = () => openDrillDown(d, 'driver');
        return div;
  }

  function createTeamCard(t) {
        const div = document.createElement('div');
        div.className = 'team-card-market';
        div.dataset.price = t.price || 0; // Store price for filtering
        div.dataset.name = t.name; // Tag for selection filtering
        div.style.setProperty('--team-color', t.color);
        // FORCE CAR IMAGE IN MARKET
        const carImg = t.img.replace('team_', 'car_');
        div.innerHTML = `<div class="tcm-name">${t.name}</div><img src="${carImg}" class="tcm-img">`;
        div.onclick = () => openDrillDown(t, 'team');
        return div;
  }

  function openDrillDown(entity, type) {
        document.getElementById('drivers-root').style.display = 'none';
        document.getElementById('teams-root').style.display = 'none';
        
        const detail = document.getElementById('market-detail');
        detail.classList.add('active');
        document.getElementById('detail-title').innerText = entity.name.toUpperCase();
        
        const list = document.getElementById('detail-list');
        list.innerHTML = ''; 

        const currentSpent = currentGrid ? currentGrid.reduce((sum, item) => sum + (item ? item.cost : 0), 0) : 0;
        const remaining = BUDGET_CAP - currentSpent;

        if(type === 'driver') {
            const opts = [...BINGO_CONFIG.templates.quali.map(t=>({...t,s:'QUALI'})), ...BINGO_CONFIG.templates.race.map(t=>({...t,s:'RACE'})), ...BINGO_CONFIG.templates.bonus.map(t=>({...t,s:'BONUS'}))];
            opts.forEach(o => {
                const cost = (entity.price||0) + o.c + (entity.tier===1 && o.t.includes('Points')?20:0);
                const isExpensive = cost > remaining;
                list.appendChild(createPredictionBtn(entity.name, o.t, cost, 'driver', entity.name, o.s, entity, isExpensive));
            });
        } else {
            BINGO_CONFIG.templates.team.forEach(o => {
                let cost = (entity.price||0) + o.c;
                if(entity.tier === 1 && o.t.includes('One Driver')) cost += 28;
                else if(entity.tier === 1 && o.t.includes('Double')) cost += 15;
                
                const isExpensive = cost > remaining;
                list.appendChild(createPredictionBtn(entity.name, o.t, cost, 'team', entity.name, 'TEAM', entity, isExpensive));
            });
        }
  }

  function backToRoot() {
        document.getElementById('market-detail').classList.remove('active');
        showMarketTab(activeMarketTab);
  }

  function createPredictionBtn(displayOwner, text, cost, type, dName, sub, entity, isExpensive) {
        const div = document.createElement('div');
        
        let img = 'images/fia.png';
        let col = '#333';
        let isTeam = false;
        let isFia = false;

        if(entity) { 
            img = entity.img; col = entity.color; 
            if(type === 'team') isTeam = true;
        } else { isFia = true; } 

        div.className = `prediction-btn ${isTeam ? 'team-mode' : ''} ${isExpensive ? 'unaffordable' : ''}`;
        
        // Metadata for filtering
        div.dataset.price = cost;
        div.dataset.name = text;
        div.dataset.owner = displayOwner;

        div.innerHTML = `
            <div class="pb-left ${isFia?'fia-bg':''}" style="background:${col}"><img src="${img}" class="pb-img"></div>
            <div class="pb-right"><div class="pb-text">${text}</div><div class="pb-cost">$${cost}M</div></div>
        `;
        div.onclick = () => fillSlot(`${displayOwner} ${text}`, type, cost, dName, sub);
        return div;
  }
  
  // NEW BUDGET FILTER LOGIC
  function applyBudgetFilter() {
      const isAffordableOnly = document.getElementById('budgetFilterToggle').checked;
      const currentSpent = currentGrid ? currentGrid.reduce((sum, item) => sum + (item ? item.cost : 0), 0) : 0;
      const remaining = BUDGET_CAP - currentSpent;
      
      // Get list of selected names from grid
      const selectedNames = currentGrid.filter(s => s).map(s => s.driver);
      const selectedTexts = currentGrid.filter(s => s).map(s => s.text);

      // Filter Drivers
      document.querySelectorAll('.driver-card-market').forEach(card => {
          const price = parseInt(card.dataset.price || 0);
          const name = card.dataset.name;
          const isSelected = selectedNames.includes(name);
          
          if (price + 5 > remaining || isSelected) {
              card.classList.add('dimmed');
              if (isAffordableOnly && !isSelected) card.style.display = 'none'; // Keep selected visible but dimmed
              else card.style.display = 'flex';
          } else {
              card.classList.remove('dimmed');
              card.style.display = 'flex';
          }
      });
      
      // Filter Teams
      document.querySelectorAll('.team-card-market').forEach(card => {
          const price = parseInt(card.dataset.price || 0);
          const name = card.dataset.name;
          const isSelected = selectedNames.includes(name);

          if (price + 5 > remaining || isSelected) {
               card.classList.add('dimmed');
               if (isAffordableOnly && !isSelected) card.style.display = 'none';
               else card.style.display = 'flex';
          } else {
               card.classList.remove('dimmed');
               card.style.display = 'flex';
          }
      });

      // Filter FIA
        document.querySelectorAll('#fia-root .prediction-btn').forEach(btn => {
            const price = parseInt(btn.dataset.price || 0);
            const fullName = `${btn.dataset.owner} ${btn.dataset.name}`;
            const isSelected = selectedTexts.includes(fullName);

            if (price > remaining || isSelected) {
                btn.classList.add('unaffordable'); // Reuse existing class for dimming
                if (isAffordableOnly && !isSelected) btn.style.display = 'none';
                else btn.style.display = 'flex';
            } else {
                btn.classList.remove('unaffordable');
                btn.style.display = 'flex';
            }
        });
  }

  function confirmStrategy(type) {
        currentStrategy = type; // Save global
        currentGrid = templates[type].map(t => null);
        renderGridStructure(templates[type]);
        switchMobileView('game');
        renderRaceHeader();
        saveGrid(); 
  }

  function changeStrategy() {
        if(isGridLocked || isUserLocked) return;
        showModal("CHANGE SETUP?", "Wipe grid?", true, async () => { 
            currentGrid = null;
            await saveGrid();
            location.reload(); 
        });
  }

  function renderGridStructure(pattern) {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        pattern.forEach((type, i) => {
            const slot = document.createElement('div');
            slot.dataset.index = i;
            slot.className = 'slot'; 
            slot.dataset.req = type; 
            slot.innerText = type === 'fia' ? "FIA" : type.toUpperCase();
            slot.onclick = () => handleSlotClick(i, type);
            grid.appendChild(slot);
        });
  }

  function renderGrid() {
        const slots = document.querySelectorAll('.slot');
        if(!currentGrid) return; 

        slots.forEach((s, idx) => {
            const data = currentGrid[idx];
            if(data) {
                let drv = BINGO_CONFIG.drivers.find(d => d.name === data.driver);
                if(!drv) drv = BINGO_CONFIG.constructors.find(c => c.name === data.driver);
                if(!drv && data.type === 'fia') drv = {name:'RC', color:'#333', img:'images/fia.png'};

                s.style.setProperty('--team-color-hex', drv.color);
                s.style.setProperty('--cat-text-color', data.type==='driver'?'#ff9500':(data.type==='team'?'#00d2be':'#e10600'));
                s.className = `slot filled`; s.dataset.type = data.type; s.onclick = null;
                
                // FORCE TEAM LOGO IN GRID (Swap back if it was saved as car)
                let displayImg = drv.img;
                if(data.type === 'team') {
                    if(displayImg.includes('car_')) displayImg = displayImg.replace('car_', 'team_');
                }

                s.innerHTML = `
                    <div class="remove-pick-btn" onclick="removePick(${idx}); event.stopPropagation();">√ó</div>
                    <div class="slot-img-container"><img src="${displayImg}" class="slot-img"><div class="slot-price-tag">$${data.cost}M</div></div>
                    <div class="slot-text-container"><div class="slot-sub">${data.subtype}</div><div class="slot-main">${data.text.replace(data.driver,'').trim()}</div></div>
                `;
            } else {
                s.className = 'slot'; s.removeAttribute('style'); delete s.dataset.type;
                s.innerText = s.dataset.req === 'fia' ? "FIA" : s.dataset.req.toUpperCase();
                s.onclick = () => handleSlotClick(idx, s.dataset.req);
            }
        });
        updateScore(); updateBudgetUI(); updateActionButtons();
  }

  function handleSlotClick(idx, type) {
        if(currentGrid[idx] || isGridLocked || isUserLocked) return;
        const panel = document.getElementById('marketPanel');
        if(window.innerWidth <= 1024) panel.classList.add('mobile-modal');
        panel.dataset.targetIndex = idx;
        
        backToRoot(); 
        let tab = 'drivers';
        if(type === 'team') tab = 'teams';
        if(type === 'fia') tab = 'fia';
        showMarketTab(tab);
  }

  function closeMobileMarket() { document.getElementById('marketPanel').classList.remove('mobile-modal'); backToRoot(); }

  function fillSlot(text, type, cost, dName, sub) {
        const panel = document.getElementById('marketPanel');
        let tIdx = parseInt(panel.dataset.targetIndex);
        if(isNaN(tIdx)) { 
             const slots = document.querySelectorAll('.slot');
             for(let i=0; i<slots.length; i++) { if(!currentGrid[i] && slots[i].dataset.req === type) { tIdx = i; break; } }
             if(tIdx === undefined) return alert("No slot");
        }

        const spent = currentGrid.reduce((s,i)=>s+(i?i.cost:0),0);
        if(spent + cost > BUDGET_CAP) return showModal("OVER BUDGET", "You cannot afford this pick.", false);
        
        if(type !== 'fia' && dName) {
            const conflict = currentGrid.some(x => x && x.driver === dName);
            if(conflict) return showModal("RULE VIOLATION", "You can only select one pick per driver/team per race.", false);
        }

        currentGrid[tIdx] = { text, type, driver: dName, subtype: sub, cost };
        saveGrid();
        renderGrid();
        closeMobileMarket();
        delete panel.dataset.targetIndex;
  }

  function removePick(idx) {
        if(isGridLocked || isUserLocked) return;
        currentGrid[idx] = null; 
        saveGrid(); 
        renderGrid();
  }

  function renderRaces() {
        const bar = document.getElementById('raceBar');
        BINGO_CONFIG.races.forEach(r => {
            const d = document.createElement('div'); d.className = `race-card ${r.id===activeRace?'active':''}`;
            d.onclick = () => { 
                activeRace = r.id; 
                localStorage.setItem('current_race_id', activeRace); 
                // Force reload to re-fetch data for new race ID
                location.reload();
            };
            d.innerHTML = `<img src="https://flagcdn.com/w40/${r.c}.png" class="race-flag-img"><span class="race-name">${r.n}</span>`;
            bar.appendChild(d);
        });
        renderRaceHeader();
  }

  function renderRaceHeader() {
        const r = BINGO_CONFIG.races.find(x => x.id === activeRace);
        document.getElementById('rhFlag').src = `https://flagcdn.com/w160/${r.c}.png`;
        document.getElementById('rhTitle').innerText = r.n;
        document.getElementById('rhDate').innerText = r.d;
        
        document.getElementById('stratFlag').src = `https://flagcdn.com/w160/${r.c}.png`;
        document.getElementById('stratRaceName').innerText = r.n.toUpperCase();
        document.getElementById('stratRaceDate').innerText = r.d.toUpperCase();
  }

  function checkLockStatus() {
        const r = BINGO_CONFIG.races.find(x => x.id === activeRace);
        if(r.lockTime && new Date(r.lockTime)-new Date() <= 0) isGridLocked = true;
        updateActionButtons();
  }

  function updateActionButtons() {
        const lockBtn = document.getElementById('headerLockBtn');
        const unlockBtn = document.getElementById('headerUnlockBtn');
        const full = currentGrid && currentGrid.every(x=>x);
        
        lockBtn.style.display = 'none';
        unlockBtn.style.display = 'none';

        if(isGridLocked) {
            document.getElementById('grid').classList.add('grid-locked');
        } else if(isUserLocked) {
            document.getElementById('grid').classList.add('grid-locked');
            unlockBtn.style.display = 'flex'; 
        } else {
            document.getElementById('grid').classList.remove('grid-locked');
            if(full) lockBtn.style.display = 'flex'; 
        }
  }

  function toggleUserLock() {
        isUserLocked = !isUserLocked;
        localStorage.setItem(`userLock_${activeRace}`, isUserLocked);
        updateActionButtons();
  }

  function updateScore() { /* Score logic */ }
  function updateBudgetUI() {
        const rem = BUDGET_CAP - (currentGrid ? currentGrid.reduce((s,i)=>s+(i?i.cost:0),0) : 0);
        document.getElementById('hudBudgetVal').innerText = `$${rem}M`;
        document.getElementById('hudBudgetBar').style.width = `${(rem/BUDGET_CAP)*100}%`;
        const c = rem < 0 ? '#e10600' : '#22c55e';
        document.getElementById('hudBudgetVal').style.color = c;
        document.getElementById('hudBudgetBar').style.backgroundColor = c;
        
        applyBudgetFilter(); // Update filter when budget changes
  }

  let mCb;
  function showModal(t, txt, conf, cb) {
        document.getElementById('modalTitle').innerText = t;
        document.getElementById('modalText').innerText = txt;
        document.getElementById('modalActions').innerHTML = conf ? `<button class="btn-modal btn-cancel" onclick="closeModal()">CANCEL</button><button class="btn-modal btn-confirm" onclick="execCallback()">CONFIRM</button>` : `<button class="btn-modal btn-confirm" onclick="closeModal()">OK</button>`;
        document.getElementById('customModal').classList.remove('hidden');
        mCb = cb;
  }
  function closeModal() { document.getElementById('customModal').classList.add('hidden'); mCb = null; }
  function execCallback() { if(mCb) mCb(); closeModal(); }

</script>
</body>
</html>