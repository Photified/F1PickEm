<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 2026: CHAMPIONSHIP BINGO</title>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,400;0,700;0,900;1,400&display=swap" rel="stylesheet">
    <script src="bingo_data.js"></script>

    <style>
        :root {
            --brand-red: #e10600; --brand-dark: #15151e; --bg-body: #f4f4f8;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.08);
            /* Colors */
            --c-driver: #ff9500; 
            --c-team: #00d2be; 
            --c-chaos: #e10600; /* Maps to FIA events */
            --score-win: #39ff14; 
        }
        body { font-family: 'Titillium Web', sans-serif; background: var(--bg-body); color: var(--brand-dark); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .hidden { display: none !important; }

        /* HEADER */
        header { background: white; border-bottom: 3px solid var(--brand-red); padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); z-index: 20; flex-shrink: 0; }
        .header-title { font-weight:900; font-style:italic; font-size:24px; cursor: pointer; user-select: none; }
        .user-profile { font-weight: 700; display: flex; align-items: center; gap: 10px; font-size: 14px; }

        /* RACE BAR */
        .race-bar { background: #fff; padding: 0; display: flex; overflow-x: auto; border-bottom: 1px solid #ddd; scrollbar-width: thin; height: 90px; flex-shrink: 0; }
        .race-card { flex: 0 0 85px; padding: 10px 5px; text-align: center; border-right: 1px solid #f0f0f0; cursor: pointer; opacity: 0.6; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .race-card:hover { opacity: 1; background: #f9f9f9; }
        .race-card.active { opacity: 1; border-bottom: 4px solid var(--brand-red); background: #fff; }
        .race-flag-img { width: 36px; height: 26px; object-fit: cover; border-radius: 3px; margin-bottom: 6px; }
        .race-name { font-size: 11px; font-weight: 800; text-transform: uppercase; line-height: 1; }

        /* MAIN LAYOUT */
        .main-stage { flex: 1; display: grid; grid-template-columns: 360px 1fr 300px; padding: 20px; gap: 20px; overflow: hidden; height: 100%; }
        .panel { background: white; border-radius: 12px; box-shadow: var(--card-shadow); overflow: hidden; display: flex; flex-direction: column; border: 1px solid #e0e0e0; height: 100%; }
        
        /* SHARED TAB HEADERS */
        .tab-header { display: flex; border-bottom: 1px solid #eee; background: #f9f9f9; flex-shrink: 0; }
        .tab-btn { 
            flex: 1; padding: 12px; text-align: center; font-weight: 800; font-size: 12px; 
            cursor: pointer; color: #888; border-bottom: 3px solid transparent; transition: 0.2s;
        }
        .tab-btn:hover { background: #f0f0f0; }
        .tab-btn.active { color: #000; border-bottom-color: var(--brand-red); background: white; }

        /* DRIVER MARKET */
        .driver-list { flex: 1; overflow-y: auto; padding: 10px; background: #f4f4f8; }
        .driver-row { background: white; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; overflow: hidden; transition: 0.2s; }
        .driver-header { padding: 12px 15px; display: flex; align-items: center; gap: 15px; cursor: pointer; background: linear-gradient(90deg, transparent 95%, #fafafa); }
        .driver-header:hover { background: #f5f5f5; }
        
        .helmet-icon { width: 28px; height: 28px; background: var(--team-color); border-radius: 50% 50% 10% 10%; border: 2px solid #333; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .helmet-icon::after { content: ''; position: absolute; top: 8px; left: 2px; right: 2px; height: 8px; background: rgba(0,0,0,0.6); border-radius: 2px; }
        .driver-header[data-team="FIA"] .helmet-icon { border-radius: 4px; background: #333; }
        .driver-header[data-team="FIA"] .helmet-icon::after { display: none; }
        .driver-header[data-team="FIA"] .helmet-icon::before { content: 'üèÅ'; position: absolute; top: 2px; left: 4px; font-size: 16px; }

        .driver-name { font-weight: 800; font-size: 14px; color: #333; }
        .driver-team { font-size: 10px; color: #888; text-transform: uppercase; margin-top:2px; }

        /* NESTED ACCORDION */
        .driver-content { display: none; padding: 10px; background: #fff; border-top: 1px solid #eee; }
        .driver-row.open .driver-content { display: flex; flex-direction: column; gap: 5px; }
        .driver-row.open .driver-header { background: #eee; border-bottom: 1px solid #ddd; }

        .sub-btn { background: #f8f9fa; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #555; transition: 0.1s; border-left-width: 6px; border-left-style: solid; }
        .sub-btn:hover { background: #f0f0f0; color: #000; }
        .sub-btn.active { background: #f4f4f4; color: #000; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
        .sub-btn.driver { border-left-color: var(--c-driver); }
        .sub-btn.team { border-left-color: var(--c-team); }
        .sub-btn.chaos { border-left-color: var(--c-chaos); }

        .sub-content { display: none; grid-template-columns: 1fr; gap: 6px; padding: 8px 5px; animation: fadeIn 0.2s; }
        .sub-btn.active + .sub-content { display: grid; }

        .chip { padding: 8px 10px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; font-weight: 700; cursor: grab; text-align: left; border-left-width: 5px; border-left-style: solid; transition: 0.1s; }
        .chip:hover { transform: translateX(3px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .chip.driver { border-left-color: var(--c-driver); }
        .chip.team { border-left-color: var(--c-team); }
        .chip.chaos { border-left-color: var(--c-chaos); }

        /* CENTER GRID */
        .active-panel { background: white; border-radius: 12px; border: 1px solid #e0e0e0; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; height: 100%; }
        .bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr); gap: 10px; width: 100%; aspect-ratio: 1/1; max-height: 600px; }
        
        .slot { background: #fafafa; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; text-align: center; padding: 5px; font-size: 11px; font-weight: 700; position: relative; user-select: none; transition: 0.2s; width: 100%; height: 100%; box-sizing: border-box; }
        .slot[data-req="driver"] { background: #fff8e6; border-color: var(--c-driver); color: var(--c-driver); opacity: 0.8; }
        .slot[data-req="team"] { background: #e0fbf8; border-color: var(--c-team); color: var(--c-team); opacity: 0.8; }
        .slot[data-req="chaos"] { background: #fff2f2; border-color: var(--c-chaos); color: var(--c-chaos); opacity: 0.8; }

        .slot.filled { border: none !important; color: white !important; box-shadow: 0 4px 10px rgba(0,0,0,0.2); opacity: 1; font-size: 13px; line-height: 1.2; padding: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .slot.filled[data-type="driver"] { background: var(--c-driver) !important; }
        .slot.filled[data-type="team"] { background: var(--c-team) !important; }
        .slot.filled[data-type="chaos"] { background: var(--c-chaos) !important; }

        .slot.center { background: #222 !important; color: white !important; border: none !important; font-size: 16px; text-transform: uppercase; }
        .slot.matched { opacity: 1; box-shadow: inset 0 0 0 5px var(--score-win); transform: scale(1.02); z-index: 5; }
        .slot.matched::after { content: '‚úì'; position: absolute; top: -8px; right: -8px; background: var(--score-win); color: black; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        /* RIGHT PANEL (STANDINGS & RULES) */
        .right-content { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .right-content.active { display: block; }

        .score-box { text-align: center; margin-bottom: 20px; padding: 20px; background: #fafafa; border-radius: 8px; border: 1px solid #eee; }
        .score-val { font-size: 36px; font-weight: 900; color: var(--brand-dark); line-height: 1; }
        .score-lbl { font-size: 12px; font-weight: 700; color: #888; text-transform: uppercase; margin-top: 5px; }
        
        .bonus-pill { display: inline-block; padding: 4px 8px; background: var(--score-win); color: #000; border-radius: 12px; font-size: 10px; font-weight: 900; margin: 2px; }

        .rules-block { margin-bottom: 20px; }
        .rules-title { font-weight: 800; font-size: 14px; margin-bottom: 8px; text-transform: uppercase; color: var(--brand-red); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .rules-text { font-size: 12px; line-height: 1.5; color: #555; }
        .rules-list { padding-left: 20px; margin: 5px 0; font-size: 12px; color: #555; }
        .rules-list li { margin-bottom: 6px; }

        /* VIEWS */
        .view-login, .view-strategy { text-align: center; width: 100%; }
        .login-input { padding: 15px; width: 100%; margin-top: 15px; text-align: center; border: 2px solid #eee; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .login-btn { padding: 15px; width: 100%; margin-top: 15px; background: var(--brand-red); color: white; border: none; font-weight: 900; cursor: pointer; border-radius: 8px; font-size: 16px; }
        
        .strat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; max-width: 600px; width: 100%; margin-left: auto; margin-right: auto; }
        .strat-card { background: #f9f9f9; border: 2px solid #eee; border-radius: 12px; padding: 20px; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.2s; }
        .strat-card:hover { border-color: var(--brand-red); background: white; transform: translateY(-3px); }
        .mini-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; width: 60px; height: 60px; margin-bottom: 10px; opacity: 0.6; }
        .mg-c { background: #ddd; border-radius: 1px; }

        .reset-btn { width: 100%; padding: 10px; margin-top: 20px; background: #fff; border: 1px solid #ddd; color: #888; font-weight: bold; cursor: pointer; border-radius: 6px; font-size: 11px; text-transform: uppercase; }
        .reset-btn:hover { background: #ffebeb; color: var(--brand-red); border-color: var(--brand-red); }

        /* ADMIN */
        #adminPanel { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: #222; color: white; padding: 20px; border-radius: 12px; z-index: 3000; display: none; flex-direction: column; width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .admin-toggle-list { max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .admin-item { padding: 10px; background: #333; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 10px; border-radius: 4px; }
        .admin-item.checked { background: var(--brand-red); font-weight: bold; }
        
        .leaderboard { flex: 1; overflow-y: auto; padding: 10px; }
        .lb-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 13px; }

        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    </style>
</head>
<body>

<header>
    <div class="user-profile">
        <span id="displayTeamName">GUEST</span>
    </div>
    <div class="header-title" ondblclick="toggleAdmin()">F1 2026 BINGO</div>
    <button onclick="saveLocal()" style="background:var(--brand-red); color:white; border:none; padding:8px 20px; border-radius:20px; font-weight:bold; cursor:pointer;">SAVE</button>
</header>

<div id="adminPanel">
    <h3>RACE CONTROL <span onclick="toggleAdmin()" style="float:right; cursor:pointer;">&times;</span></h3>
    <div class="admin-toggle-list" id="adminList"></div>
    <button onclick="publishResults()" style="width:100%; margin-top:10px; padding:10px; background:var(--score-win); border:none; font-weight:bold; cursor:pointer;">PUBLISH</button>
</div>

<div class="race-bar" id="raceBar"></div>

<div class="main-stage">
    
    <div class="panel">
        <div class="panel-header">BINGO CHIPS</div>
        <div id="driverList" class="driver-list"></div>
    </div>

    <div class="active-panel" id="mainPanel">
        <div id="view-login" class="view-login">
            <h1 style="font-style:italic; font-size:28px;">TEAM PRINCIPAL LOGIN</h1>
            <input type="text" id="teamNameInput" class="login-input" placeholder="Enter Team Name">
            <button class="login-btn" onclick="login()">ENTER PADDOCK</button>
        </div>

        <div id="view-strategy" class="view-strategy hidden">
            <h2 id="stratRaceTitle" style="margin-top:20px;">SELECT STRATEGY</h2>
            <div class="strat-grid">
                <div class="strat-card" onclick="confirmStrategy('balanced')">
                    <div class="mini-grid"><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-chaos)"></div></div>
                    <strong>‚öñÔ∏è Balanced</strong>
                </div>
                <div class="strat-card" onclick="confirmStrategy('team')">
                    <div class="mini-grid"><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div></div>
                    <strong>üõ†Ô∏è Constructor</strong>
                </div>
                <div class="strat-card" onclick="confirmStrategy('chaos')">
                    <div class="mini-grid"><div class="mg-c" style="background:var(--c-chaos)"></div><div class="mg-c" style="background:var(--c-chaos)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-chaos)"></div><div class="mg-c" style="background:var(--c-chaos)"></div></div>
                    <strong>üö© FIA / Track</strong>
                </div>
                <div class="strat-card" onclick="confirmStrategy('driver')">
                    <div class="mini-grid"><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div></div>
                    <strong>üèéÔ∏è Driver</strong>
                </div>
            </div>
        </div>

        <div id="view-game" class="view-game hidden" style="width:100%;">
            <div id="grid" class="bingo-grid"></div>
            <button class="reset-btn" onclick="resetGrid()">Reset Card / Change Strategy</button>
        </div>
    </div>

    <div class="panel">
        <div class="tab-header">
            <div class="tab-btn active" onclick="switchRightTab('standings', this)">STANDINGS</div>
            <div class="tab-btn" onclick="switchRightTab('rules', this)">RULES & SCORING</div>
        </div>

        <div id="tab-standings" class="right-content active">
            <div class="score-box">
                <div class="score-val" id="scoreDisplay">0</div>
                <div class="score-lbl">Total Points</div>
                <div id="bonusDisplay" style="margin-top:10px;"></div>
            </div>
            <div class="leaderboard" id="leaderboardList"></div>
        </div>

        <div id="tab-rules" class="right-content">
            <div class="rules-block">
                <div class="rules-title">HOW TO PLAY</div>
                <div class="rules-text">
                    1. Select a <strong>Race Strategy</strong> to generate your grid layout.<br><br>
                    2. Drag chips from the <strong>Bingo Chips</strong> menu onto matching colored slots.<br><br>
                    3. <strong>Limit:</strong> You may only select 1 chip per category (e.g., 1 Quali result) per driver.
                </div>
            </div>

            <div class="rules-block">
                <div class="rules-title">SCORING</div>
                <ul class="rules-list">
                    <li><strong>10 PTS</strong> - Each Correct Tile</li>
                    <li><strong>+30 PTS</strong> - Per Straight Line (Row/Col)</li>
                    <li><strong>+50 PTS</strong> - 4 Corners Bonus</li>
                    <li><strong>+150 PTS</strong> - The "X" (Criss-Cross)</li>
                    <li><strong>+1000 PTS</strong> - FULL CARD (Blackout)</li>
                </ul>
            </div>

            <div class="rules-block">
                <div class="rules-title">COLOR GUIDE</div>
                <ul class="rules-list">
                    <li style="color:var(--c-driver)">‚óè <strong>ORANGE:</strong> Driver Events</li>
                    <li style="color:var(--c-team)">‚óè <strong>TEAL:</strong> Constructor Events</li>
                    <li style="color:var(--c-chaos)">‚óè <strong>RED:</strong> FIA / Track Events</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    let activeRace = 'aus';
    let currentGrid = Array(25).fill(null);
    let verifiedResults = [];

    const templates = {
        balanced: ['driver','driver','team','driver','chaos','driver','team','chaos','driver','team','team','driver','FREE','driver','team','team','chaos','driver','team','chaos','driver','team','team','driver','chaos'],
        team: ['team','team','driver','team','team','team','driver','team','chaos','team','driver','team','FREE','team','team','driver','team','chaos','team','driver','team','team','team','driver','chaos'],
        chaos: ['chaos','chaos','driver','team','chaos','chaos','driver','team','chaos','driver','driver','team','FREE','chaos','chaos','team','chaos','driver','chaos','driver','chaos','driver','chaos','team','chaos'],
        driver: ['driver','driver','driver','team','driver','driver','team','chaos','driver','driver','team','driver','FREE','driver','team','driver','chaos','team','driver','driver','driver','driver','team','driver','chaos']
    };

    window.onload = () => {
        if(typeof BINGO_CONFIG === 'undefined') return alert("Missing bingo_data.js");
        
        const savedRace = localStorage.getItem('current_race_id');
        if(savedRace) activeRace = savedRace;

        renderRaces();
        buildDriverMarket();
        
        const savedName = localStorage.getItem('f1_team_name');
        if(savedName) document.getElementById('teamNameInput').value = savedName;
        
        const savedGrid = localStorage.getItem(`grid_${activeRace}`);
        if(savedName && savedGrid) login();
    };

    function switchRightTab(tabName, btn) {
        document.querySelectorAll('.right-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        const btns = btn.parentElement.querySelectorAll('.tab-btn');
        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function buildDriverMarket() {
        const container = document.getElementById('driverList');
        BINGO_CONFIG.drivers.forEach(d => {
            const row = document.createElement('div');
            row.className = 'driver-row';
            
            row.innerHTML = `
                <div class="driver-header" onclick="toggleDriver(this)" data-team="${d.team}" style="--team-color:${d.color}">
                    <div class="helmet-icon"></div>
                    <div>
                        <div class="driver-name">${d.name}</div>
                        <div class="driver-team">${d.team}</div>
                    </div>
                </div>
                <div class="driver-content"></div>
            `;
            
            const content = row.querySelector('.driver-content');
            
            if(d.team === "FIA") {
                const btn = document.createElement('div'); btn.className = 'sub-btn chaos'; btn.innerText = "FIA / TRACK EVENTS";
                btn.onclick = () => btn.classList.toggle('active');
                content.appendChild(btn);
                const grid = document.createElement('div'); grid.className = 'sub-content';
                content.appendChild(grid);
                BINGO_CONFIG.templates.fia.forEach(t => createChip(grid, t, 'chaos', false)); 
            } else {
                createSubSection(content, "QUALIFYING", BINGO_CONFIG.templates.quali, `${d.name} `, 'driver', 'quali', d.name, 'driver');
                createSubSection(content, "RACE RESULT", BINGO_CONFIG.templates.race, `${d.name} `, 'driver', 'race', d.name, 'driver');
                createSubSection(content, "BONUS", BINGO_CONFIG.templates.bonus, `${d.name} `, 'driver', 'bonus', d.name, 'driver');
                createSubSection(content, "CONSTRUCTOR", BINGO_CONFIG.templates.team, `${d.team} `, 'team', 'team', d.name, 'team');
            }
            container.appendChild(row);
        });
    }

    function createSubSection(parent, title, items, prefix, type, subtype, driverName = null, colorClass = '') {
        const btn = document.createElement('div');
        btn.className = `sub-btn ${colorClass}`;
        btn.innerText = title;
        btn.onclick = () => btn.classList.toggle('active');
        parent.appendChild(btn);

        const grid = document.createElement('div');
        grid.className = 'sub-content';
        items.forEach(t => createChip(grid, prefix + t, type, subtype, driverName));
        parent.appendChild(grid);
    }

    function toggleDriver(header) {
        const allRows = document.querySelectorAll('.driver-row');
        allRows.forEach(r => { if(r !== header.parentElement) r.classList.remove('open'); });
        header.parentElement.classList.toggle('open');
    }

    function createChip(container, text, type, subType = '', driverName = null) {
        const chip = document.createElement('div');
        chip.className = `chip ${type}`; 
        chip.innerText = text;
        chip.draggable = true;
        chip.ondragstart = e => {
            e.dataTransfer.setData('text', text);
            e.dataTransfer.setData('type', type);
            if(driverName) e.dataTransfer.setData('exclusive_driver', driverName);
            if(subType) e.dataTransfer.setData('subtype', subType);
        };
        container.appendChild(chip);
    }

    function handleDrop(e, index, reqType) {
        e.preventDefault();
        const text = e.dataTransfer.getData('text');
        const type = e.dataTransfer.getData('type');
        const driverName = e.dataTransfer.getData('exclusive_driver');
        const subType = e.dataTransfer.getData('subtype'); 

        if(type !== reqType) return; 

        if (driverName && subType) {
            const hasConflict = currentGrid.some(item => 
                item && item.driver === driverName && item.subtype === subType
            );
            if (hasConflict) {
                alert(`Cannot add: ${driverName} already has a ${subType.toUpperCase()} prediction.`);
                return;
            }
        }
        
        currentGrid[index] = { text, type, driver: driverName, subtype: subType };
        renderGrid();
        saveLocal();
    }

    function login() {
        const name = document.getElementById('teamNameInput').value;
        if(!name) return alert("Enter Name");
        localStorage.setItem('f1_team_name', name);
        document.getElementById('displayTeamName').innerText = name.toUpperCase();
        checkLocalGrid();
    }

    function checkLocalGrid() {
        const savedGrid = localStorage.getItem(`grid_${activeRace}`);
        const savedRes = localStorage.getItem(`results_${activeRace}`);
        verifiedResults = savedRes ? JSON.parse(savedRes) : [];

        if(savedGrid) {
            currentGrid = JSON.parse(savedGrid);
            switchState('game');
            renderGrid();
        } else {
            const r = BINGO_CONFIG.races.find(r=>r.id===activeRace);
            if(r) document.getElementById('stratRaceTitle').innerText = r.n.toUpperCase();
            switchState('strategy');
        }
    }

    function switchState(view) {
        document.querySelectorAll('.view-login, .view-strategy, .view-game').forEach(e => e.classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
    }

    function confirmStrategy(type) {
        currentGrid = templates[type].map(t => t === 'FREE' ? {text:'FREE', type:'FREE'} : null);
        renderGridStructure(templates[type]);
        switchState('game');
        saveLocal();
    }

    function resetGrid() {
        if(!confirm("Are you sure? This will clear your current card.")) return;
        localStorage.removeItem(`grid_${activeRace}`);
        currentGrid = Array(25).fill(null);
        const r = BINGO_CONFIG.races.find(r=>r.id===activeRace);
        if(r) document.getElementById('stratRaceTitle').innerText = r.n.toUpperCase();
        switchState('strategy');
    }

    function renderGridStructure(pattern) {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        pattern.forEach((type, i) => {
            const slot = document.createElement('div');
            slot.dataset.index = i;
            if(type === 'FREE') {
                slot.className = 'slot center'; slot.innerHTML = "üèÅ<br>FREE";
            } else {
                slot.className = 'slot'; 
                slot.dataset.req = type; 
                slot.ondragover = e => e.preventDefault();
                slot.ondrop = e => handleDrop(e, i, type);
            }
            grid.appendChild(slot);
        });
    }

    function renderGrid() {
        const slots = document.querySelectorAll('.slot:not(.center)');
        slots.forEach(s => {
            const idx = parseInt(s.dataset.index);
            const data = currentGrid[idx];
            if(data) {
                s.innerText = data.text;
                s.className = `slot filled`;
                s.dataset.type = data.type; 
                if(verifiedResults.includes(data.text)) s.classList.add('matched');
                else s.classList.remove('matched');
            } else {
                s.innerText = s.dataset.req.toUpperCase();
                s.className = 'slot';
                delete s.dataset.type;
                s.classList.remove('matched');
            }
        });
        const center = document.querySelector('.slot.center');
        if(center) center.classList.add('matched');
        updateScore();
    }

    function renderRaces() {
        const bar = document.getElementById('raceBar');
        bar.innerHTML = '';
        BINGO_CONFIG.races.forEach(r => {
            const d = document.createElement('div');
            d.className = `race-card ${r.id === activeRace ? 'active':''}`;
            d.onclick = () => { 
                activeRace = r.id; 
                localStorage.setItem('current_race_id', activeRace);
                renderRaces(); 
                checkLocalGrid(); 
            };
            d.innerHTML = `<img src="https://flagcdn.com/w40/${r.c}.png" class="race-flag-img"><span class="race-name">${r.n}</span>`;
            bar.appendChild(d);
        });
    }

    function saveLocal() {
        localStorage.setItem(`grid_${activeRace}`, JSON.stringify(currentGrid));
    }
    
    function toggleAdmin() {
        const p = document.getElementById('adminPanel');
        p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
        if(p.style.display === 'flex') {
            const list = document.getElementById('adminList');
            list.innerHTML = '';
            let items = currentGrid.filter(x => x && x.type !== 'FREE').map(x => x.text);
            items = [...new Set(items)];
            if(items.length === 0) list.innerHTML = "<div style='color:#aaa'>Grid empty.</div>";
            items.forEach(text => {
                const item = document.createElement('div');
                const isChecked = verifiedResults.includes(text);
                item.className = `admin-item ${isChecked ? 'checked' : ''}`;
                item.innerText = text;
                item.onclick = () => item.classList.toggle('checked');
                list.appendChild(item);
            });
        }
    }

    function publishResults() {
        const checked = document.querySelectorAll('.admin-item.checked');
        verifiedResults = Array.from(checked).map(el => el.innerText);
        localStorage.setItem(`results_${activeRace}`, JSON.stringify(verifiedResults));
        renderGrid();
        document.getElementById('adminPanel').style.display = 'none';
        alert("Results Published!");
    }

    function updateScore() {
        let score = 0;
        let matches = Array(25).fill(false);
        matches[12] = true; // Free space

        currentGrid.forEach((item, i) => {
            if(!item) return;
            if(i===12) return;
            if(verifiedResults.includes(item.text)) {
                score += 10;
                matches[i] = true;
            }
        });

        const bonuses = [];
        let lineCount = 0;

        // 1. STRAIGHT LINES (Rows & Cols)
        // Rows
        for(let r=0; r<5; r++) {
            let isLine = true;
            for(let c=0; c<5; c++) {
                if(!matches[r*5 + c]) isLine = false;
            }
            if(isLine) { score += 30; lineCount++; }
        }
        // Cols
        for(let c=0; c<5; c++) {
            let isLine = true;
            for(let r=0; r<5; r++) {
                if(!matches[r*5 + c]) isLine = false;
            }
            if(isLine) { score += 30; lineCount++; }
        }
        if(lineCount > 0) bonuses.push(`${lineCount} LINE${lineCount>1?'S':''} (+${lineCount*30})`);

        // 2. CORNERS (0, 4, 20, 24)
        if(matches[0] && matches[4] && matches[20] && matches[24]) {
            score += 50;
            bonuses.push("4 CORNERS (+50)");
        }

        // 3. THE "X"
        // Diag 1: 0, 6, 12, 18, 24
        // Diag 2: 4, 8, 12, 16, 20
        const d1 = matches[0] && matches[6] && matches[12] && matches[18] && matches[24];
        const d2 = matches[4] && matches[8] && matches[12] && matches[16] && matches[20];
        if(d1 && d2) {
            score += 150;
            bonuses.push("THE X (+150)");
        }

        // 4. FULL CARD
        const allMatched = matches.every(m => m === true);
        if(allMatched) {
            score += 1000;
            bonuses.push("FULL HOUSE (+1000)");
        }

        document.getElementById('scoreDisplay').innerText = score;
        document.getElementById('bonusDisplay').innerHTML = bonuses.map(b => `<div class="bonus-pill">${b}</div>`).join('');
    }
</script>

</body>
</html>