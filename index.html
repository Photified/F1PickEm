<!DOCTYPE html>
<html lang="en" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#e10600">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>F1 2026: PICK 'EM</title>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,400;0,700;0,900;1,400&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <script src="bingo_data.js"></script>

    <style>
        :root {
            --brand-red: #e10600; --brand-dark: #15151e; --bg-body: #f8f9fa;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.08);
            --c-driver: #ff9500; --c-team: #00d2be; --c-fia: #e10600; --score-win: #39ff14; 
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Titillium Web', sans-serif; background: var(--bg-body); color: var(--brand-dark); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .hidden { display: none !important; }

        /* HEADER */
        header { background: white; border-bottom: 3px solid var(--brand-red); height: 60px; display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); z-index: 20; flex-shrink: 0; }
        .logo-area { padding: 0 15px; height: 100%; display: flex; align-items: center; border-right: 1px solid #eee; cursor: pointer; }
        .header-logo { max-height: 28px; width: auto; }
        .race-scroll-area { flex: 1; display: flex; flex-direction: row; align-items: center; overflow-x: auto; height: 100%; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .race-card { flex: 0 0 65px; height: 100%; display: inline-flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid #f5f5f5; cursor: pointer; opacity: 0.5; transition: 0.2s; }
        .race-card.active { opacity: 1; background: #fff; border-bottom: 4px solid var(--brand-red); }
        .race-flag-img { width: 24px; height: 16px; object-fit: cover; border-radius: 2px; margin-bottom: 4px; }
        .race-name { font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .user-area { padding: 0 15px; font-weight: 800; font-size: 12px; border-left: 1px solid #eee; height: 100%; display: flex; align-items: center; background: #fff; z-index: 25; }

        /* LAYOUT */
        .main-stage { flex: 1; display: grid; grid-template-columns: 320px 1fr 300px; padding: 20px; gap: 20px; overflow: hidden; height: 100%; }
        .panel { background: white; border-radius: 12px; box-shadow: var(--card-shadow); overflow: hidden; display: flex; flex-direction: column; border: 1px solid #e0e0e0; height: 100%; }
        .active-panel { background: white; border-radius: 12px; border: 1px solid #e0e0e0; padding: 0; display: flex; flex-direction: column; overflow: hidden; height: 100%; position: relative; }

        @media (max-width: 1024px) {
            .main-stage { grid-template-columns: 1fr; padding: 10px; padding-bottom: 70px; }
            .panel { display: none; } 
            .panel.mobile-modal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; border-radius: 0; animation: slideUp 0.3s ease-out; }
            .mobile-close-btn { display: block !important; }
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .mobile-close-btn { display: none; padding: 15px; background: #333; color: white; text-align: center; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }

        /* NAV */
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; border-top: 1px solid #ddd; z-index: 1000; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: #888; text-transform: uppercase; cursor: pointer; }
        .nav-item.active { color: var(--brand-red); background: #fff5f5; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }
        @media (max-width: 1024px) { .mobile-nav { display: flex; } }

        /* GAME HEADER */
        #raceHeader { padding: 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; height: 70px; }
        .rh-left { display: flex; align-items: center; gap: 12px; }
        .rh-flag { width: 50px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .rh-title { font-size: 22px; font-weight: 900; font-style: italic; text-transform: uppercase; line-height: 1; }
        .rh-date { font-size: 11px; color: #888; font-weight: 700; margin-top: 2px; }
        .budget-hud { background: #f4f4f8; padding: 8px 15px; border-radius: 6px; border: 1px solid #ddd; border-left: 4px solid #22c55e; display: flex; flex-direction: column; align-items: flex-end; }
        .budget-hud-val { font-size: 16px; font-weight: 900; color: #22c55e; line-height: 1; }
        .budget-hud-bar-bg { width: 80px; height: 5px; background: #e0e0e0; margin-top: 4px; border-radius: 3px; }
        .budget-hud-bar-fill { height: 100%; background: #22c55e; width: 50%; border-radius: 3px; transition: 0.3s; }

        /* GRID */
        .grid-container { padding: 15px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .bingo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; max-width: 600px; aspect-ratio: 1/1; }
        
        .slot { background: #fafafa; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; position: relative; cursor: pointer; user-select: none; transition: 0.2s; text-transform: uppercase; color: #aaa; }
        .slot:active { transform: scale(0.98); background: #eee; }
        .slot[data-req="driver"] { background: #fff8e6; border-color: var(--c-driver); color: var(--c-driver); }
        .slot[data-req="team"] { background: #e0fbf8; border-color: var(--c-team); color: var(--c-team); }
        .slot[data-req="fia"] { background: #fff2f2; border-color: var(--c-fia); color: var(--c-fia); }

        .slot.filled { background: #f4f4f4 !important; border: 1px solid #d0d0d0 !important; color: #333 !important; padding: 0; overflow: hidden; display: flex; flex-direction: row; align-items: stretch; text-align: left; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .slot.filled::before { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 0; border-style: solid; border-width: 20px 20px 0 0; z-index: 5; }
        .slot.filled[data-type="driver"]::before { border-color: var(--c-driver) transparent transparent transparent; }
        .slot.filled[data-type="team"]::before { border-color: var(--c-team) transparent transparent transparent; }
        .slot.filled[data-type="fia"]::before { border-color: var(--c-fia) transparent transparent transparent; }

        .remove-pick-btn { position: absolute; top: 0; right: 0; width: 24px; height: 24px; background: rgba(0,0,0,0.8); color: #fff; display: flex; align-items: center; justify-content: center; z-index: 10; border-bottom-left-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .slot-img-container { width: 40%; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: var(--team-color-hex); position: relative; border-right: 1px solid rgba(255,255,255,0.2); }
        .slot-img { width: 85%; height: 85%; object-fit: contain; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); z-index: 2; }
        .slot.filled[data-type="team"] .slot-img { width: 95%; height: auto; }
        .slot.filled[data-type="fia"] .slot-img { filter: brightness(0) invert(1); }
        .slot-price-tag { background: rgba(0,0,0,0.7); color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 4px; position: absolute; bottom: 5px; z-index: 3; }
        
        .slot-text-container { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 5px 10px; background-color: #f9f9f9; background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee), linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee); background-size: 16px 16px; background-position: 0 0, 8px 8px; }
        .slot-sub { font-size: 9px; text-transform: uppercase; font-weight: 900; color: var(--cat-text-color); margin-bottom: 2px; letter-spacing: 0.5px; }
        .slot-main { font-size: 13px; font-weight: 800; line-height: 1.1; word-wrap: break-word; color: #111; }
        @media (max-width: 400px) { .slot-main { font-size: 10px; } }

        .slot.matched { opacity: 1; box-shadow: inset 0 0 0 5px var(--score-win); transform: scale(1.02); z-index: 5; }
        .slot.matched::after { content: '‚úì'; position: absolute; bottom: 5px; right: 5px; background: var(--score-win); color: black; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        /* MARKET */
        .tab-header { display: flex; border-bottom: 1px solid #eee; background: #f9f9f9; flex-shrink: 0; height: 45px; }
        .tab-btn { flex: 1; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px; cursor: pointer; color: #888; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn.active { background: white; color: #000; }
        #tabBtn-drivers.active { border-bottom-color: var(--c-driver); color: var(--c-driver); }
        #tabBtn-teams.active { border-bottom-color: var(--c-team); color: var(--c-team); }
        #tabBtn-fia.active { border-bottom-color: var(--c-fia); color: var(--c-fia); }
        .side-content { flex: 1; overflow-y: auto; background: #f4f4f8; display: none; }
        .side-content.active { display: block; }
        .driver-row { background: white; border-bottom: 1px solid #eee; margin-bottom: 0; }
        .driver-header { padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; background: white; }
        .driver-header:hover { background: #f9f9f9; }
        .driver-face { width: 36px; height: 36px; object-fit: cover; border-radius: 6px; background: #eee; border: 2px solid var(--team-color); }
        .driver-info { display: flex; flex-direction: column; }
        .d-name { font-weight: 800; font-size: 13px; color: #333; }
        .d-team { font-size: 10px; color: #999; text-transform: uppercase; }
        .driver-content { display: none; padding: 10px; background: #fafafa; border-top: 1px solid #eee; }
        .driver-row.open .driver-content { display: block; }
        .driver-row.open .driver-header { background: #eee; }
        .chip { padding: 10px 12px; background: white; border: 1px solid #ddd; border-left-width: 5px; border-radius: 6px; margin-bottom: 8px; font-size: 11px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .chip:active { transform: scale(0.98); background: #f0f0f0; }
        .chip.driver { border-left-color: var(--c-driver); }
        .chip.team { border-left-color: var(--c-team); }
        .chip.fia { border-left-color: var(--c-fia); }
        .chip-cost { background: #eee; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 900; color: #555; }

        /* LOGIN */
        .view-login { width: 100%; display: flex; flex-direction: column; align-items: center; padding: 25px; box-sizing: border-box; overflow-y: auto; height: 100%; }
        .login-input { padding: 15px; width: 100%; text-align: center; border: 2px solid #eee; border-radius: 10px; font-weight: bold; font-size: 18px; max-width: 400px; margin-bottom: 25px; background: #fff; }
        .section-header { font-size: 11px; font-weight: 900; color: #999; text-transform: uppercase; margin: 15px 0 10px 0; width: 100%; max-width: 600px; border-bottom: 1px solid #eee; padding-bottom: 5px; letter-spacing: 1px; }
        .selection-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; max-width: 600px; margin-bottom: 20px; width: 100%; }
        .selection-card { width: 90px; height: 90px; border: 2px solid #eee; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; background: white; position: relative; }
        .selection-card.selected { border-width: 3px; background: #f0fdf4; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: scale(1.05); z-index: 2; }
        .selection-card.selected::after { content: '‚úì'; position: absolute; top: 5px; right: 5px; background: #22c55e; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }
        .selection-img { width: 60%; height: 50%; object-fit: contain; margin-bottom: 6px; pointer-events: none; }
        .selection-name { font-size: 9px; font-weight: 800; text-align: center; line-height: 1.1; pointer-events: none; padding: 0 4px; text-transform: uppercase; }
        .login-btn { padding: 16px; width: 100%; max-width: 400px; margin-top: 20px; background: var(--brand-red); color: white; border: none; font-weight: 900; cursor: pointer; border-radius: 10px; font-size: 16px; box-shadow: 0 4px 10px rgba(225, 6, 0, 0.2); }

        /* STRATEGY */
        .view-strategy { text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center; height: 100%; padding: 20px; overflow-y: auto; }
        .strategy-header-container { margin-top: 20px; margin-bottom: 30px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .big-flag { width: 100px; height: auto; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .strategy-title { font-size: 32px; font-weight: 900; font-style: italic; text-transform: uppercase; line-height: 1; }
        .strat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; width: 100%; }
        .strat-card { background: #fff; border: 2px solid #eee; border-radius: 12px; padding: 20px; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .strat-card:hover { border-color: var(--brand-red); transform: translateY(-3px); }
        .mini-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; width: 60px; height: 60px; margin-bottom: 10px; opacity: 0.8; }
        .mg-c { border-radius: 1px; }

        /* MODAL */
        #customModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-box { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .btn-modal { padding: 12px 24px; border-radius: 8px; font-weight: 800; cursor: pointer; border: none; margin: 5px; font-size: 14px; }
        .btn-confirm { background: var(--brand-red); color: white; }
        .btn-cancel { background: #eee; color: #333; }

        /* STANDINGS & RULES */
        .score-box { text-align: center; margin-bottom: 20px; padding: 25px; background: #fff; border-radius: 12px; border: 1px solid #eee; box-shadow: var(--card-shadow); }
        .score-val { font-size: 42px; font-weight: 900; color: var(--brand-dark); line-height: 1; }
        .score-lbl { font-size: 12px; font-weight: 700; color: #888; text-transform: uppercase; margin-top: 5px; letter-spacing: 1px; }
        .rules-block { background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 15px; }
        .rules-title { font-weight: 900; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; color: var(--brand-red); border-bottom: 2px solid #f5f5f5; padding-bottom: 8px; }
        .rules-text { font-size: 13px; line-height: 1.6; color: #555; margin: 0; }
        .rules-list { padding-left: 20px; margin: 5px 0; font-size: 13px; color: #555; }
        .rules-list li { margin-bottom: 8px; }
        
        .actions-footer { padding: 15px; width: 100%; box-sizing: border-box; display: flex; gap: 10px; justify-content: space-between; align-items: center; }
        .btn-action { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-weight: 900; font-size: 12px; text-transform: uppercase; cursor: pointer; transition: 0.2s; }
        .btn-lock { background: #22c55e; color: white; border-color: #16a34a; display: none; } 
        .btn-unlock { background: #e10600; color: white; border-color: #b91c1c; display: none; }
        .btn-change-strat { background: white; color: #888; border: 2px solid #eee; padding: 10px 25px; font-size: 11px; font-weight: 800; text-transform: uppercase; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .btn-change-strat:hover { border-color: #333; color: #333; }

    </style>
</head>
<body>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(() => console.log('Service Worker Registered'));
  }
</script>

<div id="customModal" class="hidden">
    <div class="modal-box">
        <h3 id="modalTitle" style="margin-top:0; color:#e10600; font-style:italic; font-size:20px;">RACE CONTROL</h3>
        <p id="modalText" style="font-size:14px; color:#555; margin-bottom:20px; line-height:1.4;">Text</p>
        <div id="modalActions"></div>
    </div>
</div>

<header>
    <div class="logo-area" onclick="location.reload()">
        <img src="images/logotop.png" class="header-logo" alt="F1 Pick Em">
    </div>
    <div class="race-scroll-area" id="raceBar"></div>
    <div class="user-area" id="displayTeamName">GUEST</div>
</header>

<div class="main-stage">
    
    <div class="panel" id="marketPanel">
        <div class="mobile-close-btn" onclick="closeMobileMarket()">CLOSE MARKET √ó</div>
        <div class="tab-header">
            <div class="tab-btn active" id="tabBtn-drivers" onclick="showTab('drivers')">DRIVERS</div>
            <div class="tab-btn" id="tabBtn-teams" onclick="showTab('teams')">TEAMS</div>
            <div class="tab-btn" id="tabBtn-fia" onclick="showTab('fia')">FIA</div>
        </div>
        <div id="panel-drivers" class="side-content active"><div id="driverList"></div></div>
        <div id="panel-teams" class="side-content"><div id="teamList"></div></div>
        <div id="panel-fia" class="side-content"><div id="fiaList"></div></div>
    </div>

    <div class="active-panel" id="mainPanel">
        
        <div id="view-login" class="view-login">
            <h2 style="font-style:italic; font-size:24px; margin-bottom:20px;">TEAM PRINCIPAL LOGIN</h2>
            <input type="text" id="teamNameInput" class="login-input" placeholder="Enter Team Name">
            <div class="section-header">Select Favorite Driver</div>
            <div id="favDriverGrid" class="selection-grid"></div>
            <div class="section-header">Select Favorite Team</div>
            <div id="favTeamGrid" class="selection-grid"></div>
            <button class="login-btn" onclick="login()">ENTER PADDOCK</button>
        </div>

        <div id="view-strategy" class="view-strategy hidden">
            <div class="strategy-header-container">
                <img id="stratFlag" src="" class="big-flag">
                <div id="stratRaceTitle" class="strategy-title">STRATEGY</div>
                <div style="color:#888; font-size:12px; font-weight:700;">SELECT GRID FORMATION</div>
            </div>
            <div class="strat-grid">
                <div class="strat-card" onclick="confirmStrategy('balanced')">
                    <div class="mini-grid"><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-team)"></div></div>
                    <strong>Balanced</strong>
                </div>
                <div class="strat-card" onclick="confirmStrategy('team')">
                    <div class="mini-grid"><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-fia)"></div></div>
                    <strong>Constructor</strong>
                </div>
                <div class="strat-card" onclick="confirmStrategy('chaos')">
                    <div class="mini-grid"><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div></div>
                    <strong>FIA / Chaos</strong>
                </div>
                <div class="strat-card" onclick="confirmStrategy('driver')">
                    <div class="mini-grid"><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div></div>
                    <strong>Driver Focus</strong>
                </div>
            </div>
        </div>

        <div id="view-game" class="view-game hidden" style="width:100%; height:100%; display:flex; flex-direction:column;">
            <div id="raceHeader">
                <div class="rh-left">
                    <img id="rhFlag" src="" class="rh-flag">
                    <div>
                        <div id="rhTitle" class="rh-title">RACE</div>
                        <div id="rhDate" class="rh-date">DATE</div>
                    </div>
                </div>
                <div class="budget-hud">
                    <span style="font-size:9px; font-weight:800; color:#888; margin-bottom:2px;">CAP SPACE</span>
                    <div class="budget-hud-val" id="hudBudgetVal">$100M</div>
                    <div class="budget-hud-bar-bg"><div class="budget-hud-bar-fill" id="hudBudgetBar"></div></div>
                </div>
            </div>

            <div class="grid-container">
                <div id="grid" class="bingo-grid"></div>
            </div>
            
            <div style="padding:15px; border-top:1px solid #eee; text-align:center;">
                <div class="actions-footer" style="margin-bottom:10px;">
                    <button id="lockBtn" class="btn-action btn-lock" onclick="toggleUserLock()">LOCK CARD</button>
                    <button id="unlockBtn" class="btn-action btn-unlock" onclick="toggleUserLock()">UNLOCK CARD</button>
                </div>
                <button class="btn-change-strat" onclick="changeStrategy()">CHANGE GRID SETUP</button>
            </div>
        </div>
        
        <div id="view-standings" class="hidden" style="padding:20px; overflow-y:auto; height:100%;">
            <div class="score-box">
                <div class="score-val" id="scoreDisplay">0</div>
                <div class="score-lbl">Total Points</div>
            </div>
            <div style="text-align:center; color:#888; font-size:12px; margin-top:20px;">Leaderboard updating...</div>
        </div>

        <div id="view-rules" class="hidden" style="padding:20px; overflow-y:auto; height:100%;">
            <div class="rules-block">
                <div class="rules-title">HOW TO PLAY</div>
                <p class="rules-text">1. Choose a Grid Strategy.<br>2. Tap a slot to open the market.<br>3. Select a prediction.<br>4. Stay under the $100M Cap.</p>
            </div>
            <div class="rules-block">
                <div class="rules-title">SCORING</div>
                <ul class="rules-list">
                    <li><strong>10 PTS</strong> - Correct Tile</li>
                    <li><strong>+30 PTS</strong> - Bingo Line (Horizontal/Vertical)</li>
                    <li><strong>+50 PTS</strong> - 4 Corners</li>
                    <li><strong>+100 PTS</strong> - Full Card (Blackout)</li>
                </ul>
            </div>
            <div class="rules-block">
                <div class="rules-title">LEGEND</div>
                <ul class="rules-list">
                    <li style="color:var(--c-driver)">‚óè ORANGE: Driver Event</li>
                    <li style="color:var(--c-team)">‚óè TEAL: Constructor Event</li>
                    <li style="color:var(--c-fia)">‚óè RED: FIA / Track Event</li>
                </ul>
            </div>
        </div>

    </div>

    <div class="panel" id="desktopRightPanel">
        <div class="tab-header">
            <div class="tab-btn active">STANDINGS</div>
        </div>
        <div style="padding:20px;">
            <div class="score-box">
                <div class="score-val" id="deskScoreDisplay">0</div>
                <div class="score-lbl">POINTS</div>
            </div>
        </div>
    </div>

</div>

<div class="mobile-nav">
    <div class="nav-item active" onclick="switchMobileView('game', this)">
        <div class="nav-icon">‚äû</div>
        GRID
    </div>
    <div class="nav-item" onclick="switchMobileView('standings', this)">
        <div class="nav-icon">üèÜ</div>
        SCORE
    </div>
    <div class="nav-item" onclick="switchMobileView('rules', this)">
        <div class="nav-icon">‚Ñπ</div>
        RULES
    </div>
</div>

<script>
    class DataManager {
        constructor() { this.type = 'local'; }
        save(key, data) { if(this.type === 'local') localStorage.setItem(key, JSON.stringify(data)); }
        load(key) { if(this.type === 'local') { const d = localStorage.getItem(key); return d ? JSON.parse(d) : null; } }
    }
    const db = new DataManager();

    let activeRace = 'aus';
    let currentGrid = Array(9).fill(null);
    let verifiedResults = [];
    let modalCallback = null;
    let isGridLocked = false;
    let isUserLocked = false;
    const BUDGET_CAP = 100;
    
    let favDriver = null;
    let favTeam = null;

    const templates = {
        balanced: ['driver','team','driver', 'team','driver','fia', 'driver','fia','team'],
        team:     ['team','team','driver', 'team','team','team', 'driver','team','fia'],
        chaos:    ['fia','fia','driver',   'fia','fia','fia',    'team','fia','driver'],
        driver:   ['driver','driver','team', 'driver','driver','driver', 'fia','driver','team']
    };

    window.onload = () => {
        if(typeof BINGO_CONFIG === 'undefined') return alert("Error: bingo_data.js missing.");
        
        const savedRace = localStorage.getItem('current_race_id');
        if(savedRace) activeRace = savedRace;

        buildLoginSelectionGrids();
        renderRaces();
        buildLists();
        
        const savedName = localStorage.getItem('f1_team_name');
        const savedGrid = db.load(`grid_${activeRace}`);
        
        if(savedName) document.getElementById('teamNameInput').value = savedName;
        
        if(savedName && savedGrid) {
            login(true);
        }
        
        setInterval(checkLockStatus, 1000);
        updateBudgetUI();
    };

    function switchMobileView(viewName, btn) {
        document.getElementById('view-game').classList.add('hidden');
        document.getElementById('view-standings').classList.add('hidden');
        document.getElementById('view-rules').classList.add('hidden');
        document.getElementById('view-strategy').classList.add('hidden');
        document.getElementById(`view-${viewName}`).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(btn) btn.classList.add('active');
    }

    function showTab(tabName) {
        document.querySelectorAll('.side-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`panel-${tabName}`).classList.add('active');
        document.querySelectorAll('#marketPanel .tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tabBtn-${tabName}`).classList.add('active');
    }

    function buildLoginSelectionGrids() {
        const dGrid = document.getElementById('favDriverGrid');
        BINGO_CONFIG.drivers.filter(d=>d.team!=='FIA').sort((a,b)=>a.name.localeCompare(b.name)).forEach(d => {
            const card = document.createElement('div');
            card.className = 'selection-card';
            card.style.borderColor = d.color;
            card.onclick = () => {
                dGrid.querySelectorAll('.selection-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                favDriver = d.name;
            };
            card.innerHTML = `<img src="${d.img}" class="selection-img"><div class="selection-name">${d.name}</div>`;
            dGrid.appendChild(card);
        });

        const tGrid = document.getElementById('favTeamGrid');
        BINGO_CONFIG.constructors.filter(c=>c.type==='Team').sort((a,b)=>a.name.localeCompare(b.name)).forEach(t => {
            const card = document.createElement('div');
            card.className = 'selection-card';
            card.style.borderColor = t.color;
            card.onclick = () => {
                tGrid.querySelectorAll('.selection-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                favTeam = t.name;
            };
            card.innerHTML = `<img src="${t.img}" class="selection-img"><div class="selection-name">${t.name}</div>`;
            tGrid.appendChild(card);
        });
    }

    function login(auto = false) {
        const name = document.getElementById('teamNameInput').value;
        if(!auto) {
            if(!name || !favDriver || !favTeam) return alert("Please enter name and select favorites.");
            localStorage.setItem('f1_team_name', name);
            localStorage.setItem('f1_fav_driver', favDriver);
            localStorage.setItem('f1_fav_team', favTeam);
        } else {
            favDriver = localStorage.getItem('f1_fav_driver');
            favTeam = localStorage.getItem('f1_fav_team');
        }
        
        document.getElementById('displayTeamName').innerText = name.toUpperCase();
        
        const savedGrid = db.load(`grid_${activeRace}`);
        const userLock = localStorage.getItem(`userLock_${activeRace}`);
        if(userLock === 'true') isUserLocked = true;

        if(savedGrid) {
            currentGrid = savedGrid;
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-game').classList.remove('hidden');
            renderRaceHeader();
            renderGrid();
        } else {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-strategy').classList.remove('hidden');
            const r = BINGO_CONFIG.races.find(r=>r.id===activeRace);
            document.getElementById('stratFlag').src = `https://flagcdn.com/w160/${r.c}.png`;
        }
        updateActionButtons();
    }

    function confirmStrategy(type) {
        currentGrid = templates[type].map(t => null);
        renderGridStructure(templates[type]);
        document.getElementById('view-strategy').classList.add('hidden');
        document.getElementById('view-game').classList.remove('hidden');
        renderRaceHeader();
        db.save(`grid_${activeRace}`, currentGrid);
    }

    function changeStrategy() {
        if(isGridLocked || isUserLocked) return;
        showModal("CHANGE SETUP?", "This will wipe your current grid.", true, () => {
            db.save(`grid_${activeRace}`, null);
            localStorage.removeItem(`userLock_${activeRace}`);
            location.reload();
        });
    }

    function renderGridStructure(pattern) {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        pattern.forEach((type, i) => {
            const slot = document.createElement('div');
            slot.dataset.index = i;
            slot.className = 'slot'; 
            slot.dataset.req = type; 
            slot.innerText = type === 'fia' ? "FIA" : type.toUpperCase();
            slot.onclick = () => handleSlotClick(i, type);
            // Drop support for desktop drag
            slot.ondragover = e => e.preventDefault();
            slot.ondrop = e => handleDrop(e, i, type);
            grid.appendChild(slot);
        });
    }

    function renderGrid() {
        const slots = document.querySelectorAll('.slot');
        slots.forEach(s => {
            const idx = parseInt(s.dataset.index);
            const data = currentGrid[idx];
            if(data) {
                let drv = BINGO_CONFIG.drivers.find(d => d.name === data.driver);
                if(!drv) drv = BINGO_CONFIG.constructors.find(c => c.name === data.driver);
                if(!drv && data.type === 'fia') drv = {name:'RC', color:'#333', img:'images/fia.png'};

                const color = drv ? drv.color : '#333';
                const img = drv ? drv.img : '';
                
                s.style.setProperty('--team-color-hex', color);
                let catColor = '#ff9500';
                if(data.type === 'team') catColor = '#00d2be';
                if(data.type === 'fia') catColor = '#e10600';
                s.style.setProperty('--cat-text-color', catColor);

                s.className = `slot filled`;
                s.dataset.type = data.type;
                s.onclick = null; 

                s.innerHTML = `
                    <div class="remove-pick-btn" onclick="removePick(${idx}); event.stopPropagation();">√ó</div>
                    <div class="slot-img-container">
                        <img src="${img}" class="slot-img" onerror="this.style.display='none'">
                        <div class="slot-price-tag">$${data.cost}M</div>
                    </div>
                    <div class="slot-text-container">
                        <div class="slot-sub">${data.subtype}</div>
                        <div class="slot-main">${data.text.replace(data.driver, '').trim()}</div>
                    </div>
                `;
                
                if(verifiedResults.includes(data.text)) s.classList.add('matched');
                else s.classList.remove('matched');

            } else {
                s.className = 'slot';
                s.removeAttribute('style');
                delete s.dataset.type;
                s.classList.remove('matched');
                const req = s.dataset.req;
                s.innerText = req === 'fia' ? "FIA" : req.toUpperCase();
                s.onclick = () => handleSlotClick(idx, req);
            }
        });
        updateScore();
        updateBudgetUI();
        updateActionButtons();
    }

    function handleSlotClick(idx, type) {
        if(currentGrid[idx] || isGridLocked || isUserLocked) return;
        const panel = document.getElementById('marketPanel');
        if(window.innerWidth <= 1024) panel.classList.add('mobile-modal');
        
        showTab(type === 'driver' ? 'drivers' : (type === 'team' ? 'teams' : 'fia'));
        
        if(type === 'driver' && favDriver) expandRow(favDriver, 'drivers');
        if(type === 'team' && favTeam) expandRow(favTeam, 'teams');
        
        panel.dataset.targetIndex = idx;
    }

    function closeMobileMarket() { document.getElementById('marketPanel').classList.remove('mobile-modal'); }

    function fillSlot(text, type, cost, driverName, subType) {
        const panel = document.getElementById('marketPanel');
        let targetIdx = parseInt(panel.dataset.targetIndex);
        
        if(isNaN(targetIdx)) {
            // Find first available slot
            const slots = document.querySelectorAll('.slot');
            for(let i=0; i<slots.length; i++) {
                if(currentGrid[i] === null && slots[i].dataset.req === type) { targetIdx = i; break; }
            }
            if(targetIdx === undefined || targetIdx === -1) return alert("No available slot for " + type);
        }

        const currentSpent = calculateTotalCost();
        if(currentSpent + cost > BUDGET_CAP) return showModal("OVER BUDGET", "You cannot afford this pick.", false);
        
        // ** LOGIC UPDATE: ALLOW MULTIPLE FIA **
        // Check for duplicates only if type is NOT 'fia'
        if(type !== 'fia' && driverName) {
            const conflict = currentGrid.some(x => x && x.driver === driverName);
            if(conflict) return showModal("RULE VIOLATION", "You can only select one pick per driver/team per race.", false);
        }

        currentGrid[targetIdx] = { text, type, driver: driverName, subtype: subType, cost };
        db.save(`grid_${activeRace}`, currentGrid);
        renderGrid();
        closeMobileMarket();
        delete panel.dataset.targetIndex;
    }

    // Drag support for desktop
    function handleDrop(e, index, reqType) {
        e.preventDefault();
        if(isGridLocked || isUserLocked) return;

        const text = e.dataTransfer.getData('text');
        const type = e.dataTransfer.getData('type');
        const cost = parseInt(e.dataTransfer.getData('cost'));
        const driverName = e.dataTransfer.getData('exclusive_driver');
        const subType = e.dataTransfer.getData('subtype'); 

        if(type !== reqType) return; 

        const currentSpent = calculateTotalCost();
        const oldItem = currentGrid[index];
        const oldCost = oldItem ? oldItem.cost : 0;
        
        if ((currentSpent - oldCost + cost) > BUDGET_CAP) return showModal("OVER BUDGET", "", false);

        // ** LOGIC UPDATE: ALLOW MULTIPLE FIA **
        if (type !== 'fia' && driverName) {
            const hasConflict = currentGrid.some((item, i) => 
                i !== index && item && item.driver === driverName
            );
            if (hasConflict) return showModal("RULE VIOLATION", "One pick per category per driver.", false);
        }
        
        currentGrid[index] = { text, type, driver: driverName, subtype: subType, cost: cost };
        renderGrid();
        db.save(`grid_${activeRace}`, currentGrid);
    }

    function removePick(idx) {
        if(isGridLocked || isUserLocked) return;
        currentGrid[idx] = null;
        db.save(`grid_${activeRace}`, currentGrid);
        renderGrid();
    }

    function buildLists() {
        const dList = document.getElementById('driverList');
        BINGO_CONFIG.drivers.filter(d=>d.team!=='FIA').forEach(d => {
            const row = createRow(d, 'driver');
            const opts = [...BINGO_CONFIG.templates.quali.map(t=>({...t, s:'QUALI'})), ...BINGO_CONFIG.templates.race.map(t=>({...t, s:'RACE'})), ...BINGO_CONFIG.templates.bonus.map(t=>({...t, s:'BONUS'}))];
            opts.forEach(o => {
                const cost = getCost(d, o);
                row.querySelector('.driver-content').appendChild(createChip(d.name + ' ' + o.t, cost, 'driver', d.name, o.s));
            });
            dList.appendChild(row);
        });

        const tList = document.getElementById('teamList');
        BINGO_CONFIG.constructors.filter(t=>t.type==='Team').forEach(t => {
            const row = createRow(t, 'team');
            BINGO_CONFIG.templates.team.forEach(o => {
                const cost = getCost(t, o);
                row.querySelector('.driver-content').appendChild(createChip(t.name + ' ' + o.t, cost, 'team', t.name, 'TEAM'));
            });
            tList.appendChild(row);
        });

        const fList = document.getElementById('fiaList');
        const fRow = createRow({name:'Race Control', team:'FIA', color:'#333', img:'images/fia.png'}, 'fia');
        fRow.classList.add('open');
        BINGO_CONFIG.templates.fia.forEach(o => {
            fRow.querySelector('.driver-content').appendChild(createChip(o.t, o.c, 'fia', 'Race Control', 'FIA'));
        });
        fList.appendChild(fRow);
    }

    function createRow(entity, type) {
        const div = document.createElement('div');
        div.className = 'driver-row';
        div.dataset.name = entity.name;
        div.innerHTML = `
            <div class="driver-header" onclick="this.parentElement.classList.toggle('open')" style="--team-color:${entity.color}">
                <img src="${entity.img}" class="driver-face" onerror="this.style.display='none'">
                <div class="driver-info"><div class="d-name">${entity.name}</div><div class="d-team">${entity.team || 'CONSTRUCTOR'}</div></div>
            </div>
            <div class="driver-content"></div>
        `;
        return div;
    }

    function createChip(text, cost, type, dName, sub) {
        const el = document.createElement('div');
        el.className = `chip ${type}`;
        el.draggable = true;
        el.innerHTML = `<span>${text.replace(dName, '').trim() || text}</span> <span class="chip-cost">$${cost}M</span>`;
        el.onclick = () => fillSlot(text, type, cost, dName, sub);
        el.ondragstart = e => {
            if(isGridLocked || isUserLocked) { e.preventDefault(); return; }
            e.dataTransfer.setData('text', text);
            e.dataTransfer.setData('type', type);
            e.dataTransfer.setData('cost', cost);
            if(dName) e.dataTransfer.setData('exclusive_driver', dName);
            if(sub) e.dataTransfer.setData('subtype', sub);
        };
        return el;
    }

    function expandRow(name, tab) {
        const list = document.getElementById(tab === 'drivers' ? 'driverList' : 'teamList');
        const rows = list.querySelectorAll('.driver-row');
        rows.forEach(r => {
            r.classList.remove('open');
            if(r.dataset.name === name) { r.classList.add('open'); setTimeout(() => r.scrollIntoView({behavior:'smooth', block:'start'}), 100); }
        });
    }

    function getCost(entity, template) {
        let cost = (entity.price || 0) + template.c;
        if(entity.tier === 1 && (template.t.includes('Points') || template.t.includes('Podium'))) cost += 20; 
        if(entity.tier === 3 && template.t.includes('11th')) cost += 10;
        return cost;
    }

    function calculateTotalCost() { return currentGrid.reduce((sum, item) => sum + (item ? item.cost : 0), 0); }

    function renderRaces() {
        const bar = document.getElementById('raceBar');
        bar.innerHTML = '';
        BINGO_CONFIG.races.forEach(r => {
            const d = document.createElement('div');
            d.className = `race-card ${r.id===activeRace ? 'active':''}`;
            d.onclick = () => { activeRace = r.id; localStorage.setItem('current_race_id', activeRace); location.reload(); };
            d.innerHTML = `<img src="https://flagcdn.com/w40/${r.c}.png" class="race-flag-img"><span class="race-name">${r.n}</span>`;
            bar.appendChild(d);
        });
        renderRaceHeader();
    }

    function renderRaceHeader() {
        const r = BINGO_CONFIG.races.find(x => x.id === activeRace);
        document.getElementById('rhFlag').src = `https://flagcdn.com/w160/${r.c}.png`;
        document.getElementById('rhTitle').innerText = r.n;
        document.getElementById('rhDate').innerText = r.d;
    }

    function checkLockStatus() {
        const r = BINGO_CONFIG.races.find(x => x.id === activeRace);
        if(!r.lockTime) return;
        if(new Date(r.lockTime) - new Date() <= 0) isGridLocked = true;
        updateActionButtons();
    }

    function updateActionButtons() {
        const lock = document.getElementById('lockBtn');
        const unlock = document.getElementById('unlockBtn');
        const isFull = currentGrid.every(x => x !== null);
        if(isGridLocked) {
            lock.style.display = 'none'; unlock.style.display = 'none';
            document.getElementById('grid').classList.add('grid-locked');
        } else if(isUserLocked) {
            lock.style.display = 'none'; unlock.style.display = 'inline-block';
            document.getElementById('grid').classList.add('grid-locked');
        } else {
            document.getElementById('grid').classList.remove('grid-locked');
            unlock.style.display = 'none';
            lock.style.display = isFull ? 'inline-block' : 'none';
        }
    }

    function toggleUserLock() {
        isUserLocked = !isUserLocked;
        localStorage.setItem(`userLock_${activeRace}`, isUserLocked);
        updateActionButtons();
    }

    function updateScore() {
        let score = 0;
        currentGrid.forEach(x => { if(x && verifiedResults.includes(x.text)) score+=10; });
        document.getElementById('scoreDisplay').innerText = score;
        document.getElementById('deskScoreDisplay').innerText = score;
    }

    function updateBudgetUI() {
        const spent = calculateTotalCost();
        const rem = BUDGET_CAP - spent;
        document.getElementById('hudBudgetVal').innerText = `$${rem}M`;
        document.getElementById('hudBudgetBar').style.width = `${(rem/BUDGET_CAP)*100}%`;
        const col = rem < 0 ? '#e10600' : '#22c55e';
        document.getElementById('hudBudgetVal').style.color = col;
        document.getElementById('hudBudgetBar').style.backgroundColor = col;
    }

    function showModal(title, text, isConfirm, callback) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalText').innerText = text;
        const acts = document.getElementById('modalActions');
        acts.innerHTML = '';
        if(isConfirm) {
            modalCallback = callback;
            acts.innerHTML = `<button class="btn-modal btn-cancel" onclick="closeModal()">CANCEL</button><button class="btn-modal btn-confirm" onclick="execCallback()">CONFIRM</button>`;
        } else {
            acts.innerHTML = `<button class="btn-modal btn-confirm" onclick="closeModal()">OK</button>`;
        }
        document.getElementById('customModal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('customModal').classList.add('hidden'); modalCallback = null; }
    function execCallback() { if(modalCallback) modalCallback(); closeModal(); }

</script>
</body>
</html>