<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 2026: CHAMPIONSHIP BINGO</title>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,400;0,600;0,700;0,900;1,400&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --brand-red: #e10600;
            --brand-dark: #15151e;
            --bg-body: #f4f4f8;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.08);
            
            /* High Visibility Category Colors */
            --c-driver: #ff9500;  /* Orange */
            --c-team: #00d2be;    /* Teal */
            --c-tech: #0070ff;    /* Bright Blue */
            --c-chaos: #e10600;   /* Red */
        }

        body {
            font-family: 'Titillium Web', sans-serif;
            background: var(--bg-body);
            color: var(--brand-dark);
            margin: 0; height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- 1. LOGIN OVERLAY --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(21, 21, 30, 0.98);
            z-index: 2000;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white;
        }
        .login-box {
            background: #222; padding: 40px; border-radius: 12px;
            text-align: center; border: 2px solid var(--brand-red);
            box-shadow: 0 0 50px rgba(225, 6, 0, 0.3);
        }
        .login-input {
            padding: 15px; border-radius: 6px; border: 1px solid #444;
            background: #111; color: white; font-size: 18px; margin-top: 20px;
            width: 280px; text-align: center; font-weight: bold;
        }
        .login-btn {
            margin-top: 20px; padding: 12px 30px;
            background: var(--brand-red); color: white; border: none;
            font-weight: 900; font-size: 16px; cursor: pointer;
            text-transform: uppercase; border-radius: 6px; width: 100%;
        }

        /* --- 2. STRATEGY MODAL (New) --- */
        #strategyModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1500;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }

        .strat-container {
            background: white; border-radius: 16px; padding: 30px;
            text-align: center; max-width: 800px; width: 90%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .strat-header {
            display: flex; align-items: center; justify-content: center; gap: 20px;
            margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 20px;
        }

        .strat-flag { width: 80px; border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .strat-options {
            display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;
        }

        .strat-card {
            background: #f8f8f8; border: 2px solid #ddd; border-radius: 12px;
            padding: 20px; width: 140px; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center;
        }
        .strat-card:hover { transform: translateY(-5px); border-color: var(--brand-red); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        /* Mini Grid Preview Icons */
        .mini-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px;
            width: 60px; height: 60px; margin-bottom: 15px;
        }
        .mg-cell { background: #ddd; border-radius: 1px; }
        
        /* Color the mini-grids based on type */
        .sc-balanced .mg-cell:nth-child(odd) { background: var(--c-driver); }
        .sc-balanced .mg-cell:nth-child(even) { background: var(--c-team); }
        
        .sc-tech .mg-cell { background: var(--c-tech); opacity: 0.3; }
        .sc-tech .mg-cell:nth-child(3n) { background: var(--c-tech); opacity: 1; }
        
        .sc-chaos .mg-cell { background: var(--c-chaos); opacity: 0.3; }
        .sc-chaos .mg-cell:nth-child(2n) { background: var(--c-chaos); opacity: 1; }
        
        .sc-driver .mg-cell { background: var(--c-driver); opacity: 0.3; }
        .sc-driver .mg-cell:nth-child(odd) { background: var(--c-driver); opacity: 1; }

        .strat-title { font-weight: 800; font-size: 14px; text-transform: uppercase; margin-bottom: 5px; }
        .strat-desc { font-size: 11px; color: #666; line-height: 1.2; }


        /* --- 3. MAIN APP STYLES --- */
        header {
            background: white; border-bottom: 3px solid var(--brand-red);
            padding: 10px 25px; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .user-profile { font-weight: 700; display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .status-dot { width: 10px; height: 10px; background: #ccc; border-radius: 50%; }
        .status-dot.online { background: #00d2be; box-shadow: 0 0 8px #00d2be; }

        /* Race Bar */
        .race-bar {
            background: #fff; padding: 0; display: flex;
            overflow-x: auto; border-bottom: 1px solid #ddd;
            scrollbar-width: thin; height: 85px;
        }
        .race-card {
            flex: 0 0 80px; padding: 10px 5px; text-align: center;
            border-right: 1px solid #f0f0f0; cursor: pointer;
            opacity: 0.6; transition: 0.2s; background: #fff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .race-card:hover { opacity: 1; background: #f9f9f9; }
        .race-card.active { 
            opacity: 1; background: #fff; 
            border-bottom: 4px solid var(--brand-red); 
            box-shadow: inset 0 -10px 10px -10px rgba(0,0,0,0.1);
        }
        .race-flag-img {
            width: 32px; height: 24px; object-fit: cover; 
            border-radius: 3px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-bottom: 6px;
        }
        .race-name { font-size: 11px; font-weight: 800; text-transform: uppercase; line-height: 1; margin-bottom: 3px; }
        .race-date { font-size: 9px; color: #888; font-weight: 600; }

        /* Main Layout */
        .main-stage {
            flex: 1; display: grid; 
            grid-template-columns: 300px 1fr 280px;
            padding: 20px; gap: 20px; overflow: hidden;
        }

        .panel {
            background: white; border-radius: 10px; box-shadow: var(--card-shadow);
            overflow: hidden; display: flex; flex-direction: column; border: 1px solid #e0e0e0;
        }
        .panel-header {
            padding: 12px; background: #f8f8f8; font-weight: 800;
            font-size: 13px; text-transform: uppercase; border-bottom: 1px solid #eee;
            text-align: center; color: #666;
        }

        /* --- 4. IMPROVED TABS (Color Coded Strokes) --- */
        .pool-tabs { display: flex; flex-direction: column; padding: 10px; gap: 8px; }
        
        .tab-btn {
            padding: 12px 15px; cursor: pointer; text-align: left;
            font-weight: 700; font-size: 12px; text-transform: uppercase;
            border-radius: 4px; transition: 0.2s; background: white;
            color: #555; border: 1px solid #eee;
            /* The Key Feature: Left Border */
            border-left-width: 5px; border-left-style: solid;
        }

        /* Specific Colors for Tab Strokes */
        .tab-btn[data-cat="driver"] { border-left-color: var(--c-driver); }
        .tab-btn[data-cat="team"]   { border-left-color: var(--c-team); }
        .tab-btn[data-cat="tech"]   { border-left-color: var(--c-tech); }
        .tab-btn[data-cat="chaos"]  { border-left-color: var(--c-chaos); }

        /* Active State */
        .tab-btn:hover { background: #f9f9f9; transform: translateX(2px); }
        .tab-btn.active { 
            background: #222; color: white; border-color: #222;
        }

        .pool-list { flex: 1; overflow-y: auto; padding: 10px; background: #fbfbfb; }
        
        .chip {
            padding: 10px; margin-bottom: 8px; background: white;
            border-radius: 6px; font-size: 11px; font-weight: 700; cursor: grab;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between;
            border-left: 5px solid #ccc;
        }
        .chip:hover { transform: translateX(2px); }
        .chip.driver { border-left-color: var(--c-driver); color: var(--brand-dark); }
        .chip.team { border-left-color: var(--c-team); color: var(--brand-dark); }
        .chip.tech { border-left-color: var(--c-tech); color: var(--brand-dark); }
        .chip.chaos { border-left-color: var(--c-chaos); color: var(--brand-dark); }

        /* Grid */
        .grid-container {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: white; border-radius: 10px; box-shadow: var(--card-shadow); border: 1px solid #e0e0e0;
            padding: 20px;
        }

        .bingo-grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 8px; width: 100%; height: 100%; max-height: 600px; aspect-ratio: 1/1;
        }

        .slot {
            background: #fafafa; border: 2px dashed #ddd; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            text-align: center; padding: 4px; font-size: 11px; font-weight: 700;
            position: relative; transition: 0.2s;
        }

        .slot[data-req="driver"] { background: #fff8e1; border-color: #ffe0b2; color: var(--c-driver); }
        .slot[data-req="team"]   { background: #e0f2f1; border-color: #b2dfdb; color: var(--c-team); }
        .slot[data-req="tech"]   { background: #e3f2fd; border-color: #bbdefb; color: var(--c-tech); }
        .slot[data-req="chaos"]  { background: #ffebee; border-color: #ffcdd2; color: var(--c-chaos); }

        .slot.filled { border: none; color: white !important; box-shadow: 0 4px 8px rgba(0,0,0,0.15); opacity: 1; }
        .slot.filled[data-type="driver"] { background: var(--c-driver); }
        .slot.filled[data-type="team"]   { background: var(--c-team); }
        .slot.filled[data-type="tech"]   { background: var(--c-tech); }
        .slot.filled[data-type="chaos"]  { background: var(--c-chaos); }
        .slot.center { background: linear-gradient(135deg, #222, #000) !important; color: var(--brand-red) !important; border:none; font-size: 14px; text-transform: uppercase; }

        /* Leaderboard */
        .leaderboard { flex: 1; overflow-y: auto; font-size: 12px; }
        .lb-row {
            display: flex; justify-content: space-between; padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .lb-row.me { background: #fffde7; border-left: 4px solid #ffb800; }
        .lb-rank { font-weight: 900; width: 20px; color: #888; }
        .lb-name { flex: 1; font-weight: 700; }
        .lb-score { font-weight: 900; color: var(--brand-red); }

    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h1 style="margin:0; font-style:italic; font-size:32px;">F1 <span style="color:var(--brand-red)">2026</span></h1>
        <p style="color:#aaa; font-size:12px; letter-spacing:1px; margin-top:5px;">OFFICIAL PADDOCK LOGIN</p>
        <input type="text" id="teamNameInput" class="login-input" placeholder="Enter Team Name">
        <button class="login-btn" onclick="login()">Enter Paddock</button>
    </div>
</div>

<div id="strategyModal">
    <div class="strat-container">
        <h2 style="margin-top:0;">ROUND 1: STRATEGY BRIEFING</h2>
        <div class="strat-header">
            <img src="https://flagcdn.com/w160/au.png" class="strat-flag">
            <div style="text-align:left;">
                <div style="font-size:24px; font-weight:900; font-style:italic;">AUSTRALIAN GP</div>
                <div style="color:#666; font-size:12px;">ALBERT PARK CIRCUIT ‚Ä¢ MAR 06-08</div>
            </div>
        </div>
        
        <p style="font-size:14px; color:#555; margin-bottom:20px;">Select your Bingo Card Template to lock in your strategy:</p>

        <div class="strat-options">
            <div class="strat-card sc-balanced" onclick="confirmStrategy('balanced')">
                <div class="mini-grid">
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                </div>
                <div class="strat-title">‚öñÔ∏è Balanced</div>
                <div class="strat-desc">Equal mix of Drivers, Teams, and Tech events.</div>
            </div>

            <div class="strat-card sc-tech" onclick="confirmStrategy('tech')">
                <div class="mini-grid">
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                </div>
                <div class="strat-title">üîß Tech Spec</div>
                <div class="strat-desc">Heavy focus on New Regs, Active Aero & Engines.</div>
            </div>

            <div class="strat-card sc-chaos" onclick="confirmStrategy('chaos')">
                <div class="mini-grid">
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                </div>
                <div class="strat-title">üö© Chaos Agent</div>
                <div class="strat-desc">Maximum Safety Cars, Crashes, and Penalties.</div>
            </div>

            <div class="strat-card sc-driver" onclick="confirmStrategy('driver')">
                <div class="mini-grid">
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                </div>
                <div class="strat-title">üèéÔ∏è Silly Season</div>
                <div class="strat-desc">Focus on Driver Rivalries, Radios, and Podiums.</div>
            </div>
        </div>
    </div>
</div>

<header>
    <div class="user-profile">
        <div class="status-dot" id="connectionDot"></div>
        <span id="displayTeamName">GUEST</span>
    </div>
    <div style="font-weight:900; font-style:italic; font-size:22px;">F1 <span style="color:var(--brand-red)">2026</span> BINGO</div>
    <button onclick="saveToServer()" style="background:var(--brand-red); color:white; border:none; padding:8px 20px; border-radius:20px; font-weight:bold; cursor:pointer; box-shadow:0 4px 6px rgba(225,6,0,0.2);">CLOUD SAVE</button>
</header>

<div class="race-bar" id="raceBar"></div>

<div class="main-stage">
    
    <div class="panel">
        <div class="panel-header">Predictions Pool</div>
        <div class="pool-tabs">
            <div class="tab-btn active" data-cat="driver" onclick="setPool('driver')">üèéÔ∏è Drivers</div>
            <div class="tab-btn" data-cat="team" onclick="setPool('team')">üõ†Ô∏è Teams</div>
            <div class="tab-btn" data-cat="tech" onclick="setPool('tech')">‚ö° Tech</div>
            <div class="tab-btn" data-cat="chaos" onclick="setPool('chaos')">üö© Chaos</div>
        </div>
        <div id="pool" class="pool-list"></div>
    </div>

    <div class="grid-container">
        <div id="grid" class="bingo-grid"></div>
    </div>

    <div class="panel">
        <div class="panel-header">üèÜ World Championship</div>
        <div class="leaderboard" id="leaderboardList">
            <div style="padding:20px; text-align:center; color:#999;">Loading...</div>
        </div>
    </div>

</div>

<script>
    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "SENDER_ID",
        appId: "APP_ID"
    };

    let db, auth;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
    } catch(e) { console.warn("Offline Mode"); }

    const races = [
        {id:'aus', c:'au', n:'Australia', d:'Mar 8'}, {id:'chn', c:'cn', n:'China', d:'Mar 15'},
        {id:'jpn', c:'jp', n:'Japan', d:'Mar 29'}, {id:'bhr', c:'bh', n:'Bahrain', d:'Apr 12'},
        {id:'sau', c:'sa', n:'Saudi Arabia', d:'Apr 19'}, {id:'mia', c:'us', n:'Miami', d:'May 3'},
        {id:'can', c:'ca', n:'Canada', d:'May 24'}, {id:'mon', c:'mc', n:'Monaco', d:'Jun 7'},
        {id:'bar', c:'es', n:'Spain', d:'Jun 14'}, {id:'aut', c:'at', n:'Austria', d:'Jun 28'},
        {id:'gbr', c:'gb', n:'Britain', d:'Jul 5'}, {id:'bel', c:'be', n:'Belgium', d:'Jul 19'},
        {id:'hun', c:'hu', n:'Hungary', d:'Jul 26'}, {id:'ned', c:'nl', n:'Dutch', d:'Aug 23'},
        {id:'ita', c:'it', n:'Monza', d:'Sep 6'}, {id:'mad', c:'es', n:'Madrid', d:'Sep 13'},
        {id:'aze', c:'az', n:'Baku', d:'Sep 27'}, {id:'sin', c:'sg', n:'Singapore', d:'Oct 11'},
        {id:'usa', c:'us', n:'Austin', d:'Oct 25'}, {id:'mex', c:'mx', n:'Mexico', d:'Nov 1'},
        {id:'bra', c:'br', n:'Brazil', d:'Nov 8'}, {id:'lvg', c:'us', n:'Vegas', d:'Nov 21'},
        {id:'qat', c:'qa', n:'Qatar', d:'Nov 29'}, {id:'abu', c:'ae', n:'Abu Dhabi', d:'Dec 6'}
    ];

    const templates = {
        balanced: ['driver','driver','team','tech','chaos','driver','team','tech','chaos','driver','team','tech','FREE','driver','team','tech','chaos','driver','team','tech','chaos','driver','team','tech','chaos'],
        tech: ['tech','tech','team','driver','tech','tech','team','driver','tech','chaos','team','driver','FREE','tech','tech','driver','tech','chaos','tech','team','tech','team','tech','driver','chaos'],
        chaos: ['chaos','chaos','driver','team','chaos','chaos','driver','team','chaos','tech','driver','team','FREE','chaos','chaos','team','chaos','tech','chaos','driver','chaos','driver','chaos','team','chaos'],
        driver: ['driver','driver','driver','team','driver','driver','team','chaos','driver','driver','team','driver','FREE','driver','team','driver','chaos','team','driver','driver','driver','driver','team','driver','chaos']
    };

    let currentUser = null;
    let poolData = {};
    let activeRace = 'aus';
    let currentGrid = Array(25).fill(null);
    let currentPoolCat = 'driver';

    async function init() {
        try {
            const res = await fetch('data.json');
            poolData = await res.json();
        } catch(e) { console.log('Err JSON'); }
        
        renderRaces();
        
        const saved = localStorage.getItem('f1_team_name');
        if(saved) {
            document.getElementById('teamNameInput').value = saved;
            login();
        }
    }

    function login() {
        const name = document.getElementById('teamNameInput').value;
        if(!name) return;
        currentUser = { name, id: name.replace(/\s+/g, '_').toLowerCase() };
        localStorage.setItem('f1_team_name', name);
        
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('displayTeamName').innerText = name.toUpperCase();
        document.getElementById('connectionDot').classList.add('online');

        // Check if user has a saved grid. If not, SHOW STRATEGY MODAL.
        const localGrid = localStorage.getItem(`grid_${activeRace}`);
        
        if(!localGrid) {
            // New user or new race -> Show Strategy Modal
            document.getElementById('strategyModal').style.display = 'flex';
        } else {
            // Load existing
            if(auth) { auth.signInAnonymously(); loadCloud(); listenLeaderboard(); }
            // If offline, just load local? We'll rely on cloud load mainly.
            applyTemplate('balanced'); // Fallback structure
        }

        if(auth) {
            auth.signInAnonymously();
            loadCloud();
            listenLeaderboard();
        } else {
            // Mock Leaderboard
            renderLeaderboard([{name: name, score: 0}, {name: "Max V.", score: 150}]);
        }
        
        setPool('driver');
    }

    // --- MODAL LOGIC ---
    function confirmStrategy(type) {
        applyTemplate(type);
        document.getElementById('strategyModal').style.display = 'none';
        // Force save empty template to avoid showing modal again
        saveToServer(); 
    }

    function renderRaces() {
        const bar = document.getElementById('raceBar');
        bar.innerHTML = '';
        races.forEach(r => {
            const div = document.createElement('div');
            div.className = `race-card ${r.id === activeRace ? 'active' : ''}`;
            div.onclick = () => { activeRace = r.id; renderRaces(); loadCloud(); };
            div.innerHTML = `
                <img src="https://flagcdn.com/w40/${r.c}.png" class="race-flag-img">
                <span class="race-name">${r.n}</span>
                <span class="race-date">${r.d}</span>
            `;
            bar.appendChild(div);
        });
    }

    function setPool(cat) {
        currentPoolCat = cat;
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active');
            if(b.dataset.cat === cat) b.classList.add('active');
        });
        renderPool();
    }

    function renderPool() {
        const container = document.getElementById('pool');
        container.innerHTML = '';
        if(!poolData[currentPoolCat]) return;

        poolData[currentPoolCat].forEach(text => {
            const chip = document.createElement('div');
            chip.className = `chip ${currentPoolCat}`;
            chip.innerText = text;
            chip.draggable = true;
            chip.ondragstart = e => {
                e.dataTransfer.setData('text', text);
                e.dataTransfer.setData('type', currentPoolCat);
            };
            container.appendChild(chip);
        });
    }

    function applyTemplate(t) {
        const pattern = templates[t];
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        pattern.forEach((type, i) => {
            const slot = document.createElement('div');
            if(type === 'FREE') {
                slot.className = 'slot center';
                slot.innerText = "LIGHTS OUT";
                currentGrid[i] = { text:"LIGHTS OUT", type:"FREE" };
            } else {
                slot.className = 'slot';
                slot.dataset.req = type;
                slot.dataset.index = i;
                
                slot.ondragover = e => e.preventDefault();
                slot.ondrop = e => handleDrop(e, i, type);
                slot.onclick = () => { currentGrid[i] = null; renderGrid(); };
                
                if(currentGrid[i]) {
                    slot.innerText = currentGrid[i].text;
                    slot.classList.add('filled');
                    slot.dataset.type = currentGrid[i].type;
                }
            }
            grid.appendChild(slot);
        });
    }

    function handleDrop(e, index, reqType) {
        e.preventDefault();
        const text = e.dataTransfer.getData('text');
        const type = e.dataTransfer.getData('type');
        
        if(type !== reqType) return;
        
        currentGrid[index] = { text, type };
        renderGrid();
    }

    function renderGrid() {
        const slots = document.querySelectorAll('.slot:not(.center)');
        slots.forEach(s => {
            const idx = s.dataset.index;
            const data = currentGrid[idx];
            if(data) {
                s.innerText = data.text;
                s.className = `slot filled`;
                s.dataset.type = data.type;
            } else {
                s.innerText = '';
                s.className = 'slot';
                delete s.dataset.type;
            }
        });
    }

    function saveToServer() {
        if(!db) return;
        db.collection('players').doc(currentUser.id).set({
            name: currentUser.name,
            score: Math.floor(Math.random() * 200),
            [`grid_${activeRace}`]: currentGrid
        }, { merge: true });
        localStorage.setItem(`grid_${activeRace}`, JSON.stringify(currentGrid));
    }

    function loadCloud() {
        if(!db) return;
        db.collection('players').doc(currentUser.id).get().then(doc => {
            if(doc.exists && doc.data()[`grid_${activeRace}`]) {
                currentGrid = doc.data()[`grid_${activeRace}`];
                // Since we found a grid, no need for modal
                renderGrid();
            } else {
                // If cloud has no grid, check local or show modal
                // For simplicity here, we reset
                currentGrid = Array(25).fill(null);
                document.getElementById('strategyModal').style.display = 'flex';
                renderGrid();
            }
        });
    }

    function listenLeaderboard() {
        if(!db) return;
        db.collection('players').orderBy('score', 'desc').limit(15).onSnapshot(snap => {
            const players = [];
            snap.forEach(doc => players.push(doc.data()));
            renderLeaderboard(players);
        });
    }

    function renderLeaderboard(players) {
        const list = document.getElementById('leaderboardList');
        list.innerHTML = '';
        players.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = `lb-row ${p.name === currentUser.name ? 'me' : ''}`;
            div.innerHTML = `
                <span class="lb-rank">${i+1}</span>
                <span class="lb-name">${p.name}</span>
                <span class="lb-score">${p.score}</span>
            `;
            list.appendChild(div);
        });
    }

    window.onload = init;
</script>

</body>
</html>