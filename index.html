<!DOCTYPE html>
<html lang="en" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>F1 2026: PICK 'EM</title>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,400;0,700;0,900;1,400&display=swap" rel="stylesheet">
    <script src="bingo_data.js"></script>

    <style>
        :root {
            --brand-red: #e10600; --brand-dark: #15151e; --bg-body: #f8f9fa;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.08);
            /* Colors */
            --c-driver: #ff9500; 
            --c-team: #00d2be; 
            --c-fia: #e10600; 
            --score-win: #39ff14; 
        }
        body { font-family: 'Titillium Web', sans-serif; background: var(--bg-body); color: var(--brand-dark); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .hidden { display: none !important; }

        /* HEADER */
        header { 
            background: white; border-bottom: 3px solid var(--brand-red); 
            height: 70px; box-sizing: border-box; 
            display: flex; align-items: center; 
            padding: 0; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); z-index: 20; flex-shrink: 0; 
        }
        .logo-area { 
            flex-shrink: 0; padding: 0 20px; 
            height: 100%; display: flex; align-items: center;
            border-right: 1px solid #eee; cursor: pointer;
        }
        .header-logo { max-height: 35px; width: auto; display: block; object-fit: contain; }

        .race-scroll-area { 
            flex: 1; display: flex; flex-direction: row; 
            align-items: center; overflow-x: auto; height: 100%;
            scrollbar-width: none; white-space: nowrap; 
        }
        .race-scroll-area::-webkit-scrollbar { display: none; }

        .race-card { 
            flex: 0 0 70px; height: 100%; 
            display: inline-flex; flex-direction: column; align-items: center; justify-content: center;
            border-right: 1px solid #f5f5f5; cursor: pointer; opacity: 0.5; transition: 0.2s; 
        }
        .race-card:hover { opacity: 1; background: #f9f9f9; }
        .race-card.active { opacity: 1; background: #fff; border-bottom: 4px solid var(--brand-red); }
        .race-flag-img { width: 30px; height: 20px; object-fit: cover; border-radius: 2px; margin-bottom: 4px; }
        .race-name { font-size: 10px; font-weight: 800; text-transform: uppercase; line-height: 1; }

        .user-area { 
            padding: 0 25px; font-weight: 800; font-size: 13px; 
            border-left: 1px solid #eee; height: 100%; 
            display: flex; align-items: center; flex-shrink: 0; 
            background: #fff; z-index: 25;
        }

        /* MAIN LAYOUT */
        .main-stage { flex: 1; display: grid; grid-template-columns: 360px 1fr 300px; padding: 20px; gap: 20px; overflow: hidden; height: 100%; }
        .panel { background: white; border-radius: 12px; box-shadow: var(--card-shadow); overflow: hidden; display: flex; flex-direction: column; border: 1px solid #e0e0e0; height: 100%; }
        
        /* TABS */
        .tab-header { display: flex; border-bottom: 1px solid #eee; background: #f9f9f9; flex-shrink: 0; height: 42px; }
        .tab-btn { flex: 1; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px; cursor: pointer; color: #888; border-bottom: 3px solid transparent; transition: 0.2s; letter-spacing: 0.5px; }
        .tab-btn:hover { background: #f0f0f0; }
        .tab-btn.active { color: #000; border-bottom-color: var(--brand-red); background: white; }

        .side-content { flex: 1; overflow-y: auto; padding: 10px; background: #f4f4f8; display: none; }
        .side-content.active { display: block; }

        /* LIST ITEMS */
        .driver-row { background: white; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; overflow: hidden; transition: 0.2s; }
        .driver-header { padding: 10px 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; background: linear-gradient(90deg, transparent 95%, #fafafa); }
        .driver-header:hover { background: #f5f5f5; }
        
        .driver-face { width: 36px; height: 36px; object-fit: cover; border-radius: 6px; background: #eee; border: 2px solid var(--team-color); padding: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        .driver-face[src=""] { display: none; } 
        
        .driver-face.car-face { width: 100px; height: 36px; object-fit: contain; border-radius: 4px; background: white; }

        .driver-name { font-weight: 800; font-size: 14px; color: #333; }
        .driver-team { font-size: 10px; color: #888; text-transform: uppercase; margin-top:2px; }

        .driver-content { display: none; padding: 5px 10px 10px 10px; background: #fff; border-top: 1px solid #eee; flex-direction: column; gap: 5px;}
        .driver-row.open .driver-content { display: flex; }
        .driver-row.open .driver-header { background: #eee; border-bottom: 1px solid #ddd; }

        .menu-label { font-size: 10px; font-weight: 900; color: #999; text-transform: uppercase; margin: 12px 0 6px 4px; letter-spacing: 0.5px; border-bottom: 1px solid #eee; padding-bottom: 2px; }

        .qp-red-btn { background: var(--brand-red); color: white; font-family: 'Titillium Web', sans-serif; font-weight: 800; font-size: 12px; text-transform: uppercase; text-align: center; padding: 12px; width: 100%; border: none; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s; margin-bottom: 5px; box-sizing: border-box; }
        .qp-red-btn:hover { background: #b00; transform: translateY(-1px); }

        /* CHIPS */
        .chip { padding: 8px 10px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; font-weight: 700; cursor: grab; text-align: left; border-left-width: 5px; border-left-style: solid; transition: 0.1s; display: flex; justify-content: space-between; align-items: center; }
        .chip:hover { transform: translateX(3px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .chip.driver { border-left-color: var(--c-driver); }
        .chip.team { border-left-color: var(--c-team); }
        .chip.fia { border-left-color: var(--c-fia); }
        .chip-cost { background: #eee; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 900; color: #555; }

        .sub-btn { background: #f8f9fa; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #555; transition: 0.1s; border-left-width: 6px; border-left-style: solid; }
        .sub-btn:hover { background: #f0f0f0; color: #000; }
        .sub-btn.active { background: #f4f4f4; color: #000; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
        .sub-btn.driver { border-left-color: var(--c-driver); }
        .sub-btn.team { border-left-color: var(--c-team); }
        .sub-btn.fia { border-left-color: var(--c-fia); }
        .sub-content { display: none; grid-template-columns: 1fr; gap: 6px; padding: 8px 5px; animation: fadeIn 0.2s; }
        .sub-btn.active + .sub-content { display: grid; }

        /* CENTER GRID */
        .active-panel { background: white; border-radius: 12px; border: 1px solid #e0e0e0; padding: 0; display: flex; flex-direction: column; overflow: hidden; height: 100%; position: relative; }
        
        #raceHeader { padding: 15px 25px; background: #fff; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; height: 90px; box-sizing: border-box; }
        .rh-left { display: flex; align-items: center; gap: 15px; }
        .rh-flag { width: 70px; height: auto; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .rh-info { display: flex; flex-direction: column; }
        .rh-title { font-size: 24px; font-weight: 900; font-style: italic; text-transform: uppercase; line-height: 1; }
        .rh-date { font-size: 12px; color: #888; font-weight: 700; margin-top: 4px; }
        .rh-right { display: flex; align-items: center; gap: 20px; }

        .budget-hud { background: #f4f4f8; color: #333; padding: 8px 15px; border-radius: 8px; display: flex; flex-direction: column; align-items: flex-end; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border: 1px solid #ddd; border-left: 4px solid #22c55e; }
        .budget-hud-label { font-size: 9px; font-weight: 800; color: #888; letter-spacing: 1px; }
        .budget-hud-val { font-size: 16px; font-weight: 900; color: #22c55e; }
        .budget-hud-bar-bg { width: 100px; height: 5px; background: #e0e0e0; margin-top: 4px; border-radius: 3px; }
        .budget-hud-bar-fill { height: 100%; background: #22c55e; width: 50%; border-radius: 3px; transition: 0.3s; }

        .lock-container { text-align: right; }
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 4px; color: white; font-weight: 800; font-size: 11px; text-transform: uppercase; }
        .status-open { background: #22c55e; }
        .status-locked { background: #ef4444; }
        .lock-timer { font-size: 12px; font-weight: 700; color: #555; margin-top: 4px; }

        .grid-container { padding: 20px; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; }
        .bingo-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap: 15px; width: 100%; aspect-ratio: 1/1; max-height: 600px; }
        
        .grid-locked .slot { opacity: 0.7; pointer-events: none; filter: grayscale(0.5); }
        .grid-locked .slot.filled { filter: grayscale(0); opacity: 1; }

        .slot { background: #fafafa; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; text-align: center; padding: 5px; font-size: 11px; font-weight: 700; position: relative; user-select: none; transition: 0.2s; width: 100%; height: 100%; box-sizing: border-box; cursor: pointer; }
        .slot:hover { border-color: #aaa; background: #f0f0f0; }
        .slot[data-req="driver"] { background: #fff8e6; border-color: var(--c-driver); color: var(--c-driver); opacity: 0.8; }
        .slot[data-req="team"] { background: #e0fbf8; border-color: var(--c-team); color: var(--c-team); opacity: 0.8; }
        .slot[data-req="fia"] { background: #fff2f2; border-color: var(--c-fia); color: var(--c-fia); opacity: 0.8; }

        .slot.filled { background: #f4f4f4 !important; border: 1px solid #d0d0d0 !important; color: #333 !important; box-shadow: 0 4px 10px rgba(0,0,0,0.08); opacity: 1; padding: 0; overflow: hidden; display: flex; flex-direction: row; align-items: stretch; text-align: left; position: relative; cursor: default; }
        .slot.filled::before { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 0; border-style: solid; border-width: 16px 16px 0 0; z-index: 5; }
        .slot.filled[data-type="driver"]::before { border-color: var(--c-driver) transparent transparent transparent; }
        .slot.filled[data-type="team"]::before { border-color: var(--c-team) transparent transparent transparent; }
        .slot.filled[data-type="fia"]::before { border-color: var(--c-fia) transparent transparent transparent; }

        .remove-pick-btn { position: absolute; top: 0; right: 0; width: 24px; height: 24px; background: #000; color: #fff; font-weight: 900; font-size: 14px; line-height: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; border-bottom-left-radius: 4px; opacity: 0.8; transition: 0.2s; }
        .remove-pick-btn:hover { background: #333; opacity: 1; }

        .slot-img-container { width: 35%; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid rgba(255,255,255,0.1); background-color: var(--team-color-hex); position: relative; }
        .slot-img { width: 70%; height: 70%; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); margin-bottom: 2px; }
        .slot.filled[data-type="team"] .slot-img { width: 90%; height: auto; margin-top: 10px; }
        .slot-price-tag { background: rgba(0,0,0,0.4); color: white; font-size: 12px; font-weight: 900; padding: 2px 6px; border-radius: 4px; margin-top: 4px; }
        .slot.filled[data-type="fia"] .slot-img { filter: brightness(0) invert(1); }

        .slot-text-container { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 4px 15px; min-width: 0; background-color: #f4f4f4; background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee), linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee); background-position: 0 0, 10px 10px; background-size: 20px 20px; }
        .slot-sub { font-size: 13px; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 5px; color: var(--cat-text-color); }
        .slot-main { font-size: 18px; font-weight: 800; line-height: 1.1; word-wrap: break-word; overflow: hidden; color: #222; }

        .slot.matched { opacity: 1; box-shadow: inset 0 0 0 5px var(--score-win); transform: scale(1.02); z-index: 5; }
        .slot.matched::after { content: '✓'; position: absolute; bottom: 5px; right: 5px; background: var(--score-win); color: black; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        .actions-footer { padding: 15px; width: 100%; box-sizing: border-box; display: flex; gap: 10px; }
        .btn-action { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-weight: 900; font-size: 12px; text-transform: uppercase; cursor: pointer; transition: 0.2s; }
        .btn-reset { background: #fff; color: #e10600; }
        .btn-reset:hover { background: #fff0f0; }
        .btn-lock { background: #22c55e; color: white; border-color: #16a34a; display: none; } 
        .btn-lock:hover { background: #16a34a; }
        .btn-unlock { background: #e10600; color: white; border-color: #b91c1c; display: none; }

        .right-content { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .right-content.active { display: block; }
        .score-box { text-align: center; margin-bottom: 20px; padding: 20px; background: #fafafa; border-radius: 8px; border: 1px solid #eee; }
        .score-val { font-size: 36px; font-weight: 900; color: var(--brand-dark); line-height: 1; }
        .score-lbl { font-size: 12px; font-weight: 700; color: #888; text-transform: uppercase; margin-top: 5px; }
        .bonus-pill { display: inline-block; padding: 4px 8px; background: var(--score-win); color: #000; border-radius: 12px; font-size: 10px; font-weight: 900; margin: 2px; }
        .rules-block { margin-bottom: 20px; }
        .rules-title { font-weight: 800; font-size: 14px; margin-bottom: 8px; text-transform: uppercase; color: var(--brand-red); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .rules-text { font-size: 12px; line-height: 1.5; color: #555; }
        .rules-list { padding-left: 20px; margin: 5px 0; font-size: 12px; color: #555; }
        .rules-list li { margin-bottom: 6px; }

        .view-login, .view-strategy { text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center; height: 100%; }
        .login-input { padding: 15px; width: 100%; margin-top: 15px; text-align: center; border: 2px solid #eee; border-radius: 8px; font-weight: bold; font-size: 16px; max-width: 400px; }
        .login-btn { padding: 15px; width: 100%; margin-top: 15px; background: var(--brand-red); color: white; border: none; font-weight: 900; cursor: pointer; border-radius: 8px; font-size: 16px; max-width: 400px; }
        
        .strategy-header-container { margin-top: 20px; margin-bottom: 30px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .big-flag { width: 100px; height: auto; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .strategy-title { font-size: 32px; font-weight: 900; font-style: italic; text-transform: uppercase; line-height: 1; }

        .strat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 600px; width: 100%; }
        .strat-card { background: #f9f9f9; border: 2px solid #eee; border-radius: 12px; padding: 20px; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.2s; }
        .strat-card:hover { border-color: var(--brand-red); background: white; transform: translateY(-3px); }
        .mini-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; width: 60px; height: 60px; margin-bottom: 10px; opacity: 0.6; }
        .mg-c { background: #ddd; border-radius: 1px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 2px solid #eee; }
        .modal-title { font-size: 20px; font-weight: 900; color: var(--brand-red); text-transform: uppercase; margin-bottom: 10px; font-style: italic; }
        .modal-text { color: #555; font-size: 14px; margin-bottom: 25px; line-height: 1.5; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .btn-modal { padding: 10px 20px; border-radius: 6px; font-weight: 800; cursor: pointer; border: none; flex: 1; }
        .btn-cancel { background: #eee; color: #333; }
        .btn-cancel:hover { background: #ddd; }
        .btn-confirm { background: var(--brand-red); color: white; }
        .btn-confirm:hover { background: #b00; }

        #adminPanel { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: #222; color: white; padding: 20px; border-radius: 12px; z-index: 3000; display: none; flex-direction: column; width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .admin-toggle-list { max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .admin-item { padding: 10px; background: #333; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 10px; border-radius: 4px; }
        .admin-item.checked { background: var(--brand-red); font-weight: bold; }
        
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    </style>
</head>
<body>

<div id="customModal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="modal-title" id="modalTitle">Race Control</div>
        <div class="modal-text" id="modalText">Message here...</div>
        <div class="modal-actions" id="modalActions"></div>
    </div>
</div>

<header>
    <div class="logo-area" ondblclick="toggleAdmin()">
        <img src="images/logotop.png" class="header-logo" alt="F1 Pick Em">
    </div>
    
    <div class="race-scroll-area" id="raceBar"></div>

    <div class="user-area">
        <span id="displayTeamName">GUEST</span>
    </div>
</header>

<div id="adminPanel">
    <h3>RACE CONTROL <span onclick="toggleAdmin()" style="float:right; cursor:pointer;">&times;</span></h3>
    <div class="admin-toggle-list" id="adminList"></div>
    <button onclick="publishResults()" style="width:100%; margin-top:10px; padding:10px; background:var(--score-win); border:none; font-weight:bold; cursor:pointer;">PUBLISH</button>
</div>

<div class="main-stage">
    
    <div class="panel">
        <div class="tab-header">
            <div class="tab-btn active" id="tabBtn-drivers" onclick="showSideTab('drivers', this)">DRIVERS</div>
            <div class="tab-btn" id="tabBtn-teams" onclick="showSideTab('teams', this)">TEAMS</div>
            <div class="tab-btn" id="tabBtn-fia" onclick="showSideTab('fia', this)">FIA</div>
        </div>
        
        <div id="panel-drivers" class="side-content active">
            <div id="driverList"></div>
        </div>
        
        <div id="panel-teams" class="side-content">
            <div id="teamList"></div>
        </div>

        <div id="panel-fia" class="side-content">
            <div id="fiaList"></div>
        </div>
    </div>

    <div class="active-panel" id="mainPanel">
        <div id="view-login" class="view-login" style="justify-content: center;">
            <h1 style="font-style:italic; font-size:28px;">TEAM PRINCIPAL LOGIN</h1>
            <input type="text" id="teamNameInput" class="login-input" placeholder="Enter Team Name">
            <button class="login-btn" onclick="login()">ENTER PADDOCK</button>
        </div>

        <div id="view-strategy" class="view-strategy hidden">
            <div class="strategy-header-container">
                <img id="stratFlag" src="" class="big-flag">
                <div id="stratRaceTitle" class="strategy-title">RACE STRATEGY</div>
                <div style="color:#888; font-size:12px; font-weight:700;">SELECT YOUR GRID SETUP</div>
            </div>
            
            <div class="strat-grid">
                <div class="strat-card" onclick="confirmStrategy('balanced')">
                    <div class="mini-grid"><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-team)"></div></div>
                    <strong>Balanced</strong>
                </div>
                <div class="strat-card" onclick="confirmStrategy('team')">
                    <div class="mini-grid"><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-fia)"></div></div>
                    <strong>Constructor</strong>
                </div>
                <div class="strat-card" onclick="confirmStrategy('chaos')">
                    <div class="mini-grid"><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div></div>
                    <strong>FIA</strong>
                </div>
                <div class="strat-card" onclick="confirmStrategy('driver')">
                    <div class="mini-grid"><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-fia)"></div><div class="mg-c" style="background:var(--c-driver)"></div><div class="mg-c" style="background:var(--c-team)"></div></div>
                    <strong>Driver</strong>
                </div>
            </div>
        </div>

        <div id="view-game" class="view-game hidden" style="width:100%;">
            <div id="raceHeader">
                <div class="rh-left">
                    <img id="rhFlag" src="" class="rh-flag">
                    <div class="rh-info">
                        <div id="rhTitle" class="rh-title">RACE NAME</div>
                        <div id="rhDate" class="rh-date">DATE</div>
                    </div>
                </div>
                
                <div class="rh-right">
                    <div class="budget-hud">
                        <span class="budget-hud-label">CAP SPACE</span>
                        <div class="budget-hud-val" id="hudBudgetVal">$100M</div>
                        <div class="budget-hud-bar-bg">
                            <div class="budget-hud-bar-fill" id="hudBudgetBar"></div>
                        </div>
                    </div>

                    <div class="lock-container">
                        <div id="rhStatus" class="status-badge status-open">OPEN</div>
                        <div id="rhTimer" class="lock-timer">LOCKS IN: --</div>
                    </div>
                </div>
            </div>

            <div class="grid-container">
                <div id="grid" class="bingo-grid"></div>
            </div>
            
            <div class="actions-footer">
                <button id="resetBtn" class="btn-action btn-reset" onclick="triggerReset()">Reset Card</button>
                <button id="lockBtn" class="btn-action btn-lock" onclick="toggleUserLock()">LOCK CARD</button>
                <button id="unlockBtn" class="btn-action btn-unlock" onclick="toggleUserLock()">UNLOCK CARD</button>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="tab-header">
            <div class="tab-btn active" onclick="switchRightTab('standings', this)">STANDINGS</div>
            <div class="tab-btn" onclick="switchRightTab('rules', this)">RULES & SCORING</div>
        </div>

        <div id="tab-standings" class="right-content active">
            <div class="score-box">
                <div class="score-val" id="scoreDisplay">0</div>
                <div class="score-lbl">Total Points</div>
                <div id="bonusDisplay" style="margin-top:10px;"></div>
            </div>
            <div class="leaderboard" id="leaderboardList"></div>
        </div>

        <div id="tab-rules" class="right-content">
            <div class="rules-block">
                <div class="rules-title">HOW TO PLAY</div>
                <div class="rules-text">
                    1. Select a <strong>Race Strategy</strong> to generate your 3x3 grid.<br><br>
                    2. Drag <strong>My Picks</strong> from left menu onto matching colored slots.<br><br>
                    3. <strong>Budget Cap:</strong> You have <strong>$100M</strong>. Manage it wisely!<br><br>
                    4. <strong>Limit:</strong> 1 pick per category per driver.<br><br>
                    5. <strong>Lock:</strong> Lock your card before the deadline.
                </div>
            </div>
            <div class="rules-block">
                <div class="rules-title">SCORING</div>
                <ul class="rules-list">
                    <li><strong>10 PTS</strong> - Each Correct Tile</li>
                    <li><strong>+30 PTS</strong> - Straight Line Bonus</li>
                    <li><strong>+50 PTS</strong> - 4 Corners Bonus</li>
                    <li><strong>+100 PTS</strong> - Full Card Bonus</li>
                </ul>
            </div>
            <div class="rules-block">
                <div class="rules-title">COLOR GUIDE</div>
                <ul class="rules-list">
                    <li style="color:var(--c-driver)">● <strong>ORANGE:</strong> Driver Picks</li>
                    <li style="color:var(--c-team)">● <strong>TEAL:</strong> Constructor Picks</li>
                    <li style="color:var(--c-fia)">● <strong>RED:</strong> FIA Picks</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    let activeRace = 'aus';
    let currentGrid = Array(9).fill(null); // 3x3 - All slots playable
    let verifiedResults = [];
    let modalCallback = null;
    let isGridLocked = false;
    let isUserLocked = false;
    const BUDGET_CAP = 100;

    const templates = {
        balanced: ['driver','team','driver', 'team','driver','fia', 'driver','fia','team'],
        team:     ['team','team','driver', 'team','team','team', 'driver','team','fia'],
        chaos:    ['fia','fia','driver',   'fia','fia','fia',    'team','fia','driver'],
        driver:   ['driver','driver','team', 'driver','driver','driver', 'fia','driver','team']
    };

    window.onload = () => {
        if(typeof BINGO_CONFIG === 'undefined') return alert("Missing bingo_data.js");
        
        const savedRace = localStorage.getItem('current_race_id');
        if(savedRace) activeRace = savedRace;

        renderRaces();
        buildDriverMarket();
        buildTeamMarket();
        buildFIAMarket();
        
        const savedName = localStorage.getItem('f1_team_name');
        if(savedName) document.getElementById('teamNameInput').value = savedName;
        
        const savedGrid = localStorage.getItem(`grid_${activeRace}`);
        const savedUserLock = localStorage.getItem(`userLock_${activeRace}`);
        
        if(savedUserLock === 'true') isUserLocked = true;

        if(savedName && savedGrid) login();
        
        setInterval(checkLockStatus, 1000);
        updateBudgetUI();
    };

    function showSideTab(tabName, btn) {
        document.querySelectorAll('.side-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`panel-${tabName}`).classList.add('active');
        
        // Update header buttons
        const header = document.querySelector('.panel .tab-header');
        header.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        // If btn provided, activate it. If not, find by ID
        if(btn) {
            btn.classList.add('active');
        } else {
            const autoBtn = document.getElementById(`tabBtn-${tabName}`);
            if(autoBtn) autoBtn.classList.add('active');
        }
    }

    function checkLockStatus() {
        const r = BINGO_CONFIG.races.find(x => x.id === activeRace);
        if(!r || !r.lockTime) return;

        const now = new Date();
        const lockTime = new Date(r.lockTime);
        const diff = lockTime - now;

        const statusBadge = document.getElementById('rhStatus');
        const timerDisplay = document.getElementById('rhTimer');
        const grid = document.getElementById('grid');
        
        if (diff <= 0) {
            isGridLocked = true;
            if(statusBadge) { statusBadge.innerText = "LOCKED"; statusBadge.className = "status-badge status-locked"; }
            if(timerDisplay) timerDisplay.innerText = "Picks Closed";
            updateActionButtons(); 
            return;
        } 
        
        isGridLocked = false;
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        if(timerDisplay) timerDisplay.innerText = `LOCKS IN: ${d}D ${h}H`;

        if(isUserLocked) {
            if(statusBadge) { statusBadge.innerText = "READY"; statusBadge.className = "status-badge status-locked"; }
        } else {
            if(statusBadge) { statusBadge.innerText = "OPEN"; statusBadge.className = "status-badge status-open"; }
        }
        updateActionButtons();
    }

    function updateActionButtons() {
        const resetBtn = document.getElementById('resetBtn');
        const lockBtn = document.getElementById('lockBtn');
        const unlockBtn = document.getElementById('unlockBtn');
        const grid = document.getElementById('grid');

        const isFull = currentGrid.every(slot => slot !== null);

        if(isGridLocked) {
            grid.classList.add('grid-locked');
            resetBtn.style.display = 'none';
            lockBtn.style.display = 'none';
            unlockBtn.style.display = 'none';
        } else if(isUserLocked) {
            grid.classList.add('grid-locked');
            resetBtn.style.display = 'none';
            lockBtn.style.display = 'none';
            unlockBtn.style.display = 'block';
        } else {
            grid.classList.remove('grid-locked');
            resetBtn.style.display = 'block';
            unlockBtn.style.display = 'none';
            
            if(isFull) lockBtn.style.display = 'block';
            else lockBtn.style.display = 'none';
        }
    }

    function toggleUserLock() {
        isUserLocked = !isUserLocked;
        localStorage.setItem(`userLock_${activeRace}`, isUserLocked);
        checkLockStatus();
    }

    function renderRaceHeader() {
        const r = BINGO_CONFIG.races.find(x => x.id === activeRace);
        if(!r) return;
        document.getElementById('rhFlag').src = `https://flagcdn.com/w160/${r.c}.png`;
        document.getElementById('rhTitle').innerText = r.n.toUpperCase();
        document.getElementById('rhDate').innerText = r.d.toUpperCase();
        checkLockStatus(); 
    }

    // BUDGET LOGIC
    function calculateTotalCost() {
        let total = 0;
        currentGrid.forEach(item => {
            if(item && item.cost) total += item.cost;
        });
        return total;
    }

    function updateBudgetUI() {
        const spent = calculateTotalCost();
        const remaining = BUDGET_CAP - spent;
        const pct = (remaining / BUDGET_CAP) * 100;
        
        const val = document.getElementById('hudBudgetVal');
        const bar = document.getElementById('hudBudgetBar');
        
        if(val) val.innerText = `$${remaining}M`;
        if(bar) {
            bar.style.width = `${pct}%`;
            if(remaining < 10) { bar.style.backgroundColor = '#e10600'; val.style.color = '#e10600'; }
            else { bar.style.backgroundColor = '#22c55e'; val.style.color = '#22c55e'; }
        }
    }

    function getChipCost(driverName, type, templateText) {
        let basePrice = 0;
        let tier = 2; // Default tier

        if (type === 'team') {
             const constr = BINGO_CONFIG.constructors.find(c => c.name === driverName);
             basePrice = constr ? (constr.price || 0) : 0;
             if(constr) tier = constr.tier;
        } else if (type === 'fia') {
             basePrice = 0; 
             tier = 0;
        } else {
             const drv = BINGO_CONFIG.drivers.find(d => d.name === driverName);
             basePrice = drv ? (drv.price || 0) : 0;
             if(drv) tier = drv.tier;
        }

        let eventCost = 0;
        let foundTemplate = null;
        for (const cat in BINGO_CONFIG.templates) {
            const match = BINGO_CONFIG.templates[cat].find(t => t.t === templateText);
            if (match) {
                eventCost = match.c;
                foundTemplate = match.t;
                break;
            }
        }
        
        let cost = basePrice + eventCost;

        // --- PROBABILITY TAX LOGIC ---
        // Certain combos are "Too Easy" so we increase price heavily
        
        if (type === 'driver') {
            // Tier 1 Tax
            if (tier === 1) {
                if (foundTemplate === "Points Finish") cost += 25; // Base ~12 + 5 + 25 = 42
                if (foundTemplate === "Podium Finish") cost += 15; // Base ~12 + 4 + 15 = 31
                if (foundTemplate === "Q3 Appearance") cost += 10;
            }
            // Tier 3 "Easy" Tax
            if (tier === 3) {
                if (foundTemplate === "11th-20th Finish") cost += 10; // Base ~4 + 3 + 10 = 17
            }
        }

        if (type === 'team') {
             // Tier 1 Team Tax
             if (tier === 1) {
                 if (foundTemplate === "Double Points") cost += 15; // Base ~8 + 4 + 15 = 27
             }
        }

        return cost;
    }

    function showModal(title, text, isConfirm, callback) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalText').innerText = text;
        const actions = document.getElementById('modalActions');
        actions.innerHTML = '';

        if(isConfirm) {
            modalCallback = callback;
            actions.innerHTML = `
                <button class="btn-modal btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-modal btn-confirm" onclick="execCallback()">Confirm</button>
            `;
        } else {
            actions.innerHTML = `<button class="btn-modal btn-confirm" onclick="closeModal()">OK</button>`;
        }
        document.getElementById('customModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('customModal').classList.add('hidden');
        modalCallback = null;
    }

    function execCallback() {
        if(modalCallback) modalCallback();
        closeModal();
    }

    function triggerReset() {
        if(isGridLocked || isUserLocked) return;
        showModal("Race Control", "Are you sure you want to retire this card? All current predictions for this race will be deleted.", true, performReset);
    }

    function performReset() {
        localStorage.removeItem(`grid_${activeRace}`);
        localStorage.removeItem(`userLock_${activeRace}`);
        currentGrid = Array(9).fill(null);
        isUserLocked = false;
        updateBudgetUI();
        
        const r = BINGO_CONFIG.races.find(r=>r.id===activeRace);
        if(r) {
            document.getElementById('stratRaceTitle').innerText = r.n.toUpperCase() + " STRATEGY";
            document.getElementById('stratFlag').src = `https://flagcdn.com/w160/${r.c}.png`;
        }
        switchState('strategy');
    }

    function switchRightTab(tabName, btn) {
        document.querySelectorAll('.right-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
        const btns = btn.parentElement.querySelectorAll('.tab-btn');
        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // --- TAB 1: DRIVERS ---
    function buildDriverMarket() {
        const container = document.getElementById('driverList');
        container.innerHTML = ''; 
        const realDrivers = BINGO_CONFIG.drivers.filter(d => d.team !== 'FIA');
        
        realDrivers.forEach(d => {
            const row = document.createElement('div');
            row.className = 'driver-row';
            
            row.innerHTML = `
                <div class="driver-header" onclick="toggleDriver(this)" data-team="${d.team}" style="--team-color:${d.color}">
                    <img src="${d.img}" class="driver-face" onerror="this.style.display='none'">
                    <div>
                        <div class="driver-name">${d.name}</div>
                        <div class="driver-team">${d.team}</div>
                    </div>
                </div>
                <div class="driver-content"></div>
            `;
            
            const content = row.querySelector('.driver-content');
            
            const label = document.createElement('div'); label.className = 'menu-label'; label.innerText = 'QUICK PICKS';
            content.appendChild(label);

            const qpBtn = document.createElement('div'); qpBtn.className = 'qp-red-btn'; qpBtn.innerText = 'DRIVER QUICK PICKS';
            qpBtn.onclick = (e) => { e.stopPropagation(); applyQuickPicks(d.name, d.team, 'maximize_driver'); };
            content.appendChild(qpBtn);

            const label2 = document.createElement('div'); label2.className = 'menu-label'; label2.innerText = 'MANUAL SELECTION';
            content.appendChild(label2);

            createSubSection(content, "QUALIFYING", BINGO_CONFIG.templates.quali, `${d.name} `, 'driver', 'quali', d.name, 'driver');
            createSubSection(content, "RACE RESULT", BINGO_CONFIG.templates.race, `${d.name} `, 'driver', 'race', d.name, 'driver');
            createSubSection(content, "BONUS", BINGO_CONFIG.templates.bonus, `${d.name} `, 'driver', 'bonus', d.name, 'driver');
            
            container.appendChild(row);
        });
    }

    // --- TAB 2: TEAMS ---
    function buildTeamMarket() {
        const container = document.getElementById('teamList');
        container.innerHTML = '';
        const realTeams = BINGO_CONFIG.constructors.filter(c => c.type === 'Team');

        realTeams.forEach(t => {
             const row = document.createElement('div');
            row.className = 'driver-row';
            // Use special class for wide car images
            row.innerHTML = `
                <div class="driver-header" onclick="toggleDriver(this)" style="--team-color:${t.color}">
                    <img src="${t.img}" class="driver-face car-face" onerror="this.style.display='none'">
                    <div>
                        <div class="driver-name">${t.name}</div>
                        <div class="driver-team">CONSTRUCTOR</div>
                    </div>
                </div>
                <div class="driver-content"></div>
            `;
            const content = row.querySelector('.driver-content');

            const qpBtn = document.createElement('div'); qpBtn.className = 'qp-red-btn'; qpBtn.innerText = 'TEAM QUICK PICKS';
            qpBtn.onclick = (e) => { e.stopPropagation(); applyQuickPicks(t.name, null, 'maximize_team'); };
            content.appendChild(qpBtn);

            createSubSection(content, "CONSTRUCTOR EVENTS", BINGO_CONFIG.templates.team, `${t.name} `, 'team', 'team', t.name, 'team');
            
            container.appendChild(row);
        });
    }

    // --- TAB 3: FIA ---
    function buildFIAMarket() {
        const container = document.getElementById('fiaList');
        container.innerHTML = '';
        
        const row = document.createElement('div');
        row.className = 'driver-row open'; 
        row.innerHTML = `
            <div class="driver-header" style="--team-color:#333">
                <img src="images/fia.png" class="driver-face" style="filter:invert(1)">
                <div>
                    <div class="driver-name">RACE CONTROL</div>
                    <div class="driver-team">FIA</div>
                </div>
            </div>
            <div class="driver-content" style="display:flex"></div>
        `;
        
        const content = row.querySelector('.driver-content');
        
        const qpBtn = document.createElement('div'); qpBtn.className = 'qp-red-btn'; qpBtn.innerText = 'FIA QUICK PICKS';
        qpBtn.onclick = (e) => { e.stopPropagation(); applyQuickPicks(null, null, 'random_fia'); };
        content.appendChild(qpBtn);

        createSubSection(content, "TRACK EVENTS", BINGO_CONFIG.templates.fia, '', 'fia', 'fia', 'Race Control', 'fia');
        
        container.appendChild(row);
    }

    function createSubSection(parent, title, items, prefix, type, subtype, driverName = null, colorClass = '') {
        const btn = document.createElement('div');
        btn.className = `sub-btn ${colorClass}`;
        btn.innerText = title;
        btn.onclick = () => btn.classList.toggle('active');
        parent.appendChild(btn);

        const grid = document.createElement('div');
        grid.className = 'sub-content';
        items.forEach(t => createChip(grid, prefix + t.t, type, subtype, driverName, '', t.c, t.t));
        parent.appendChild(grid);
    }

    function handleSlotClick(slot) {
        // Only if empty
        const idx = parseInt(slot.dataset.index);
        if(currentGrid[idx]) return; // Already filled

        const req = slot.dataset.req;
        if(req === 'driver') showSideTab('drivers');
        if(req === 'team') showSideTab('teams');
        if(req === 'fia') showSideTab('fia');
    }

    function handleDrop(e, index, reqType) {
        e.preventDefault();
        
        if(isGridLocked || isUserLocked) {
            showModal("Card Locked", "Unlock your card to make changes.", false);
            return;
        }

        const text = e.dataTransfer.getData('text');
        const type = e.dataTransfer.getData('type');
        const cost = parseInt(e.dataTransfer.getData('cost'));
        const driverName = e.dataTransfer.getData('exclusive_driver');
        const subType = e.dataTransfer.getData('subtype'); 

        if(type !== reqType) return; 

        const currentSpent = calculateTotalCost();
        const oldItem = currentGrid[index];
        const oldCost = oldItem ? oldItem.cost : 0;
        
        if ((currentSpent - oldCost + cost) > BUDGET_CAP) {
            showModal("Budget Cap Exceeded", "You cannot afford this pick.", false);
            return;
        }

        if (driverName && subType && subType !== 'fia') {
            const hasConflict = currentGrid.some((item, i) => 
                i !== index && item && item.driver === driverName && item.subtype === subType
            );
            if (hasConflict) {
                showModal("Rule Violation", `Cannot add: ${driverName} already has a ${subType.toUpperCase()} prediction.`, false);
                return;
            }
        }
        
        currentGrid[index] = { text, type, driver: driverName, subtype: subType, cost: cost };
        renderGrid();
        saveLocal();
        checkLockStatus();
        updateBudgetUI();
    }

    // --- REVISED LOGIC WITH TIERS ---
    function applyQuickPicks(driverName, teamName, mode) {
        if(isGridLocked || isUserLocked) { showModal("Card Locked", "Unlock your card to make changes.", false); return; }

        let targetTier = 1; // Default
        if (mode === 'maximize_driver') {
            const d = BINGO_CONFIG.drivers.find(x => x.name === driverName);
            if(d) targetTier = d.tier || 1;
        } else if (mode === 'maximize_team') {
            const t = BINGO_CONFIG.constructors.find(x => x.name === driverName); // driverName var holds team name
            if(t) targetTier = t.tier || 1;
        }

        // Build priority list based on mode
        let allOptions = [];
        if (mode === 'maximize_driver') {
            allOptions = [
                ...BINGO_CONFIG.templates.quali.map(x=>({...x, type:'driver', st:'quali'})),
                ...BINGO_CONFIG.templates.race.map(x=>({...x, type:'driver', st:'race'})),
                ...BINGO_CONFIG.templates.bonus.map(x=>({...x, type:'driver', st:'bonus'}))
            ];
        } else if (mode === 'maximize_team') {
            allOptions = BINGO_CONFIG.templates.team.map(x=>({...x, type:'team', st:'team'}));
        } else if (mode === 'random_fia') {
             const allFia = BINGO_CONFIG.templates.fia;
             let shuffled = [...allFia].sort(() => 0.5 - Math.random());
             allOptions = shuffled.map(x=>({...x, type:'fia', st:'fia'}));
        }

        // Filter by Tier (if not FIA)
        let priorities = [];
        if (mode !== 'random_fia') {
            priorities = allOptions.filter(opt => opt.tiers && opt.tiers.includes(targetTier));
            priorities.sort((a,b) => b.c - a.c);
        } else {
            priorities = allOptions.slice(0, 9);
        }

        let tempGrid = [...currentGrid];
        let tempCost = calculateTotalCost(); 
        let addedCount = 0;

        for (let i = 0; i < 9; i++) {
            // No free space, check all slots
            if (tempGrid[i] !== null) continue; 

            const slotEl = document.querySelector(`.slot[data-index="${i}"]`);
            if (!slotEl) continue;
            const reqType = slotEl.dataset.req;

            for (let p of priorities) {
                if (p.type !== reqType) continue; 

                let fullText = p.t;
                let dName = 'Race Control';
                let st = p.st;

                if (p.type === 'driver') { fullText = `${driverName} ${p.t}`; dName = driverName; }
                if (p.type === 'team') { fullText = `${driverName} ${p.t}`; dName = driverName; } 

                let conflict = false;
                if (p.type === 'driver' || p.type === 'team') {
                     conflict = tempGrid.some(x => x && x.driver === dName && x.subtype === st);
                }
                
                const alreadyExists = tempGrid.some(x => x && x.text === fullText);

                if (!conflict && !alreadyExists) {
                    const cost = getChipCost(dName, p.type, p.t);
                    
                    if (tempCost + cost <= BUDGET_CAP) {
                        tempGrid[i] = { text: fullText, type: p.type, driver: dName, subtype: st, cost: cost };
                        tempCost += cost;
                        addedCount++;
                        break; 
                    }
                }
            }
        }

        if (addedCount > 0) {
            currentGrid = tempGrid;
            renderGrid();
            saveLocal();
            checkLockStatus();
            updateBudgetUI();
        } else {
            showModal("Fill Failed", "Could not add any picks. Check budget or open slots.", false);
        }
    }

    function removePick(index) {
        if(isGridLocked || isUserLocked) return;
        currentGrid[index] = null;
        renderGrid();
        saveLocal();
        checkLockStatus();
        updateBudgetUI();
    }

    function login() {
        const name = document.getElementById('teamNameInput').value;
        if(!name) return alert("Enter Name");
        localStorage.setItem('f1_team_name', name);
        document.getElementById('displayTeamName').innerText = name.toUpperCase();
        checkLocalGrid();
    }

    function checkLocalGrid() {
        const savedGrid = localStorage.getItem(`grid_${activeRace}`);
        const savedRes = localStorage.getItem(`results_${activeRace}`);
        verifiedResults = savedRes ? JSON.parse(savedRes) : [];

        if(savedGrid) {
            currentGrid = JSON.parse(savedGrid);
            switchState('game');
            renderGrid();
        } else {
            const r = BINGO_CONFIG.races.find(r=>r.id===activeRace);
            if(r) {
                document.getElementById('stratRaceTitle').innerText = r.n.toUpperCase() + " STRATEGY";
                document.getElementById('stratFlag').src = `https://flagcdn.com/w160/${r.c}.png`;
            }
            switchState('strategy');
        }
    }

    function switchState(view) {
        document.querySelectorAll('.view-login, .view-strategy, .view-game').forEach(e => e.classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
        if(view === 'game') renderRaceHeader();
    }

    function confirmStrategy(type) {
        currentGrid = templates[type].map(t => null); 
        renderGridStructure(templates[type]);
        switchState('game');
        saveLocal();
    }

    function renderGridStructure(pattern) {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        pattern.forEach((type, i) => {
            const slot = document.createElement('div');
            slot.dataset.index = i;
            slot.className = 'slot'; 
            slot.dataset.req = type; 
            slot.innerText = type === 'fia' ? "FIA" : type.toUpperCase();
            
            // Interaction:
            slot.onclick = () => handleSlotClick(slot);
            slot.ondragover = e => e.preventDefault();
            slot.ondrop = e => handleDrop(e, i, type);
            
            grid.appendChild(slot);
        });
    }

    function renderGrid() {
        const slots = document.querySelectorAll('.slot');
        slots.forEach(s => {
            const idx = parseInt(s.dataset.index);
            const data = currentGrid[idx];
            if(data) {
                let drv = BINGO_CONFIG.drivers.find(d => d.name === data.driver);
                if (!drv) drv = BINGO_CONFIG.constructors.find(c => c.name === data.driver);
                if (!drv && data.type === 'fia') drv = {name:'Race Control', color:'#333', img:'images/fia.png'};

                const imgSrc = drv ? drv.img : '';
                const teamColor = drv ? drv.color : '#333';
                
                let mainText = data.text;
                if(drv && mainText.startsWith(drv.name)) {
                    mainText = mainText.replace(drv.name, '').trim();
                } 

                let subText = data.subtype ? data.subtype.toUpperCase() : "EVENT";
                if(subText === 'FIA') subText = 'TRACK';

                s.style.setProperty('--team-color-hex', teamColor);
                
                let catColor = '#ff9500'; 
                if(data.type === 'team') catColor = '#00d2be'; 
                if(data.type === 'fia') catColor = '#e10600'; 
                s.style.setProperty('--cat-text-color', catColor);

                s.innerHTML = `
                    <div class="remove-pick-btn" onclick="removePick(${idx}); event.stopPropagation();">×</div>
                    <div class="slot-img-container">
                        <img src="${imgSrc}" class="slot-img" onerror="this.style.display='none'">
                        <div class="slot-price-tag">$${data.cost}M</div>
                    </div>
                    <div class="slot-text-container">
                        <div class="slot-sub" style="color:${catColor}">${subText}</div>
                        <div class="slot-main">${mainText}</div>
                    </div>
                `;
                s.className = `slot filled`;
                s.dataset.type = data.type; 
                s.onclick = null; // Remove click to open market if filled
                
                if(verifiedResults.includes(data.text)) s.classList.add('matched');
                else s.classList.remove('matched');
            } else {
                const req = s.dataset.req;
                s.innerHTML = req === 'fia' ? "FIA" : req.toUpperCase();
                s.className = 'slot';
                s.removeAttribute('style');
                delete s.dataset.type;
                s.classList.remove('matched');
                // Re-add listener if cleared
                s.onclick = () => handleSlotClick(s);
            }
        });
        updateScore();
    }

    function renderRaces() {
        const bar = document.getElementById('raceBar');
        bar.innerHTML = '';
        BINGO_CONFIG.races.forEach(r => {
            const d = document.createElement('div');
            d.className = `race-card ${r.id === activeRace ? 'active':''}`;
            d.onclick = () => { 
                activeRace = r.id; 
                localStorage.setItem('current_race_id', activeRace);
                renderRaces(); 
                checkLocalGrid(); 
            };
            d.innerHTML = `<img src="https://flagcdn.com/w40/${r.c}.png" class="race-flag-img"><span class="race-name">${r.n}</span>`;
            bar.appendChild(d);
        });
    }

    function saveLocal() {
        localStorage.setItem(`grid_${activeRace}`, JSON.stringify(currentGrid));
    }
    
    function toggleAdmin() {
        const p = document.getElementById('adminPanel');
        p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
        if(p.style.display === 'flex') {
            const list = document.getElementById('adminList');
            list.innerHTML = '';
            let items = currentGrid.filter(x => x).map(x => x.text);
            items = [...new Set(items)];
            if(items.length === 0) list.innerHTML = "<div style='color:#aaa'>Grid empty.</div>";
            items.forEach(text => {
                const item = document.createElement('div');
                const isChecked = verifiedResults.includes(text);
                item.className = `admin-item ${isChecked ? 'checked' : ''}`;
                item.innerText = text;
                item.onclick = () => item.classList.toggle('checked');
                list.appendChild(item);
            });
        }
    }

    function publishResults() {
        const checked = document.querySelectorAll('.admin-item.checked');
        verifiedResults = Array.from(checked).map(el => el.innerText);
        localStorage.setItem(`results_${activeRace}`, JSON.stringify(verifiedResults));
        renderGrid();
        document.getElementById('adminPanel').style.display = 'none';
        alert("Results Published!");
    }

    function updateScore() {
        let score = 0;
        let matches = Array(9).fill(false);

        currentGrid.forEach((item, i) => {
            if(!item) return;
            if(verifiedResults.includes(item.text)) {
                score += 10;
                matches[i] = true;
            }
        });

        const bonuses = [];
        let lineCount = 0;

        for(let r=0; r<3; r++) {
            let isLine = true;
            for(let c=0; c<3; c++) { if(!matches[r*3 + c]) isLine = false; }
            if(isLine) { score += 30; lineCount++; }
        }
        for(let c=0; c<3; c++) {
            let isLine = true;
            for(let r=0; r<3; r++) { if(!matches[r*3 + c]) isLine = false; }
            if(isLine) { score += 30; lineCount++; }
        }
        if(lineCount > 0) bonuses.push(`${lineCount} LINE BONUS (+${lineCount*30})`);

        if(matches[0] && matches[2] && matches[6] && matches[8]) {
            score += 50;
            bonuses.push("4 CORNERS BONUS (+50)");
        }

        const allMatched = matches.every(m => m === true);
        if(allMatched) {
            score += 100;
            bonuses.push("FULL CARD BONUS (+100)");
        }

        document.getElementById('scoreDisplay').innerText = score;
        document.getElementById('bonusDisplay').innerHTML = bonuses.map(b => `<div class="bonus-pill">${b}</div>`).join('');
    }
</script>

</body>

</html>